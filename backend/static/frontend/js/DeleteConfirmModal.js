import{e as c,f,g as r,c as v,k,a8 as N,p as M,t as d,n as B,C as P,D as b,a2 as V,E as R,a3 as F,q as L,r as x,h as _,j as w,B as S,w as C,V as j,x as T,u as Z,v as z,aW as O,l as E}from"./index.js";import{r as A}from"./ExclamationTriangleIcon.js";function I(e,t){return c(),f("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[r("path",{"fill-rule":"evenodd",d:"M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z","clip-rule":"evenodd"})])}function $(e,t){return c(),f("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[r("path",{"fill-rule":"evenodd",d:"M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z","clip-rule":"evenodd"})])}function U(e,t){return c(),f("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[r("path",{d:"M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"}),r("path",{"fill-rule":"evenodd",d:"M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.762 1.762 0 0 1 0-1.113ZM17.25 12a5.25 5.25 0 1 1-10.5 0 5.25 5.25 0 0 1 10.5 0Z","clip-rule":"evenodd"})])}function W(e,t){return c(),f("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[r("path",{"fill-rule":"evenodd",d:"M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-1.72 6.97a.75.75 0 1 0-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 1 0 1.06 1.06L12 13.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L13.06 12l1.72-1.72a.75.75 0 1 0-1.06-1.06L12 10.94l-1.72-1.72Z","clip-rule":"evenodd"})])}const G={__name:"StatusBadge",props:{status:{type:String,required:!0}},setup(e){const t=e,s=v(()=>({PENDING:{text:"Pendiente",classes:"bg-yellow-100 text-yellow-800",icon:$},IN_REVIEW:{text:"En Revisión",classes:"bg-blue-100 text-blue-800",icon:U},RESPONDED:{text:"Respondida",classes:"bg-green-100 text-green-800",icon:I},CLOSED:{text:"Cerrada",classes:"bg-gray-100 text-gray-800",icon:W}})[t.status]||{text:t.status,classes:"bg-gray-100 text-gray-800",icon:$}),a=v(()=>s.value.classes),n=v(()=>s.value.text),o=v(()=>s.value.icon);return(i,m)=>(c(),f("span",{class:B([a.value,"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"])},[(c(),k(N(o.value),{class:"w-3 h-3 mr-1"})),M(" "+d(n.value),1)],2))}},D=P("legalRequestsManagement",{state:()=>({requests:[],currentRequest:null,loading:!1,error:null,userRole:"client"}),getters:{getRequestsByStatus:e=>t=>e.requests.filter(s=>s.status===t),pendingRequestsCount:e=>e.requests.filter(t=>t.status==="PENDING").length,requestsWithResponses:e=>e.requests.filter(t=>t.response_count>0)},actions:{async fetchRequests(e={}){this.loading=!0,this.error=null;try{const t=new URLSearchParams;e.search&&t.append("search",e.search),e.status&&t.append("status",e.status),e.page&&t.append("page",e.page),e.date_from&&t.append("date_from",e.date_from),e.date_to&&t.append("date_to",e.date_to);const s=`legal_requests/${t.toString()?"?"+t.toString():""}`,a=await b(s);if(a.status===200)return this.requests=a.data.requests,this.userRole=a.data.user_role,{requests:a.data.requests,count:a.data.count,userRole:a.data.user_role};throw new Error("Failed to fetch requests")}catch(t){throw this.error=t.message,console.error("Error fetching legal requests:",t),t}finally{this.loading=!1}},async fetchRequestDetail(e){this.loading=!0,this.error=null;try{const t=await b(`legal_requests/${e}/`);if(t.status===200)return this.currentRequest=t.data,t.data;throw new Error("Failed to fetch request detail")}catch(t){throw this.error=t.message,console.error("Error fetching request detail:",t),t}finally{this.loading=!1}},async updateRequestStatus(e,t){try{const s=await V(`legal_requests/${e}/status/`,{status:t});if(s.status===200){const a=this.requests.findIndex(n=>n.id===e);return a!==-1&&(this.requests[a]={...this.requests[a],status:t,status_display:s.data.request.status_display}),this.currentRequest&&this.currentRequest.id===e&&(this.currentRequest=s.data.request),s.data.request}throw new Error("Failed to update request status")}catch(s){throw console.error("Error updating request status:",s),s}},async createResponse(e,t){try{const s=new FormData;s.append("response_text",t);const a=await R(`legal_requests/${e}/responses/`,s);if(a.status===201){this.currentRequest&&this.currentRequest.id===e&&(this.currentRequest.responses||(this.currentRequest.responses=[]),this.currentRequest.responses.push(a.data.response));const n=this.requests.findIndex(o=>o.id===e);return n!==-1&&(this.requests[n].response_count+=1),a.data.response}throw new Error("Failed to create response")}catch(s){throw console.error("Error creating response:",s),s}},async deleteRequest(e){var t,s,a,n;try{const o=await F(`legal_requests/${e}/delete/`);if(o.status===200||o.status===204)return this.requests=this.requests.filter(i=>i.id!==e),this.currentRequest&&this.currentRequest.id===e&&(this.currentRequest=null),!0;throw new Error(`Failed to delete request: Status ${o.status}`)}catch(o){console.error("Error deleting request:",o),o.response&&(console.error("Response status:",o.response.status),console.error("Response data:",o.response.data));const i=((s=(t=o.response)==null?void 0:t.data)==null?void 0:s.detail)||((n=(a=o.response)==null?void 0:a.data)==null?void 0:n.message)||o.message||"Error desconocido al eliminar la solicitud";throw new Error(i)}},async addFilesToRequest(e,t){try{const s=new FormData;t.forEach(n=>{s.append("files",n)});const a=await R(`legal_requests/${e}/files/`,s);if(a.status===200)return this.currentRequest&&this.currentRequest.id===e&&await this.fetchRequestDetail(e),{success:!0,data:a.data,message:a.data.message};throw new Error("Failed to add files")}catch(s){throw console.error("Error adding files to request:",s),s}},async downloadFile(e,t){try{const s=localStorage.getItem("token"),a={...s&&{Authorization:`Bearer ${s}`},Accept:"application/octet-stream, */*"},n=await L.get(`/api/legal_requests/${e}/files/${t}/download/`,{responseType:"arraybuffer",timeout:3e4,headers:a});if(n.status===200)return n;throw new Error(`Failed to download file: HTTP ${n.status}`)}catch(s){throw console.error("Error downloading file:",s),s}}}}),K={class:"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"},H={class:"relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"},J={class:"flex items-center justify-between mb-4"},Q=r("h3",{class:"text-lg font-medium text-gray-900"}," Actualizar Estado ",-1),X={class:"mb-4 p-3 bg-gray-50 rounded-lg"},Y={class:"text-sm font-medium text-gray-900"},ee={class:"text-sm text-gray-600"},te={class:"mb-4"},se=r("label",{class:"block text-sm font-medium text-gray-700 mb-2"}," Estado actual: ",-1),re={class:"mb-6"},ae=r("label",{class:"block text-sm font-medium text-gray-700 mb-2"}," Nuevo estado: ",-1),oe=T('<option value="">Seleccionar estado...</option><option value="PENDING">Pendiente</option><option value="IN_REVIEW">En Revisión</option><option value="RESPONDED">Respondida</option><option value="CLOSED">Cerrada</option>',5),ne=[oe],ie={class:"flex justify-end space-x-3"},le=["disabled"],ke={__name:"StatusUpdateModal",props:{request:{type:Object,required:!0}},emits:["close","updated"],setup(e,{emit:t}){const s=e,a=t,n=D(),o=x(""),i=x(!1),m=async()=>{if(!(!o.value||o.value===s.request.status)){i.value=!0;try{const l=await n.updateRequestStatus(s.request.id,o.value);a("updated",l)}catch(l){console.error("Error updating status:",l)}finally{i.value=!1}}};return(l,u)=>(c(),f("div",K,[r("div",H,[r("div",J,[Q,r("button",{onClick:u[0]||(u[0]=g=>l.$emit("close")),class:"text-gray-400 hover:text-gray-600"},[_(w(S),{class:"h-6 w-6"})])]),r("div",X,[r("p",Y,d(e.request.request_number),1),r("p",ee,d(e.request.first_name)+" "+d(e.request.last_name),1)]),r("div",te,[se,_(G,{status:e.request.status},null,8,["status"])]),r("div",re,[ae,C(r("select",{"onUpdate:modelValue":u[1]||(u[1]=g=>o.value=g),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"},ne,512),[[j,o.value]])]),r("div",ie,[r("button",{onClick:u[2]||(u[2]=g=>l.$emit("close")),class:"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md"}," Cancelar "),r("button",{onClick:m,disabled:!o.value||o.value===e.request.status||i.value,class:"px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed rounded-md"},d(i.value?"Actualizando...":"Actualizar"),9,le)])])]))}},ue={class:"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"},de={class:"relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"},ce={class:"flex items-center justify-between mb-4"},me=r("h3",{class:"text-lg font-medium text-red-900"}," Eliminar Solicitud ",-1),he={class:"flex items-center justify-center mb-4"},fe={class:"mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100"},pe={class:"mb-4 p-3 bg-gray-50 rounded-lg"},ge={class:"text-sm font-medium text-gray-900"},ve={class:"text-sm text-gray-600"},xe={class:"text-sm text-gray-600"},_e=r("div",{class:"mb-6"},[r("p",{class:"text-sm text-gray-700 mb-2"}," ¿Estás seguro de que deseas eliminar esta solicitud? "),r("p",{class:"text-sm text-red-600 font-medium"}," Esta acción no se puede deshacer. Se eliminarán todos los archivos y respuestas asociadas. ")],-1),ye={class:"mb-6"},we=r("label",{class:"block text-sm font-medium text-gray-700 mb-2"},' Para confirmar, escribe "eliminar": ',-1),qe={key:0,class:"mt-1 text-xs text-red-600"},be={key:0,class:"mb-4 p-3 bg-red-50 border border-red-200 rounded-md"},Re={class:"text-sm text-red-800"},Ee={class:"flex justify-end space-x-3"},$e=["disabled"],Se=["disabled"],Ne={__name:"DeleteConfirmModal",props:{request:{type:Object,required:!0}},emits:["close","deleted"],setup(e,{emit:t}){const s=e,a=t,n=D(),o=Z(),i=x(""),m=x(!1),l=x(""),u=v(()=>i.value.toLowerCase().trim()==="eliminar"),g=()=>{u.value&&!m.value&&q()},q=async()=>{if(!u.value){l.value='Debes escribir "eliminar" para confirmar';return}m.value=!0,l.value="";try{await n.deleteRequest(s.request.id),a("deleted"),a("close"),setTimeout(async()=>{try{await o.replace({name:"legal_requests_list"})}catch{window.location.href="/#/legal_requests"}},100)}catch(h){console.error("Error deleting request:",h),l.value=h.message||"Error al eliminar la solicitud. Por favor intenta nuevamente.",h.response&&(console.error("Response status:",h.response.status),console.error("Response data:",h.response.data))}finally{m.value=!1}};return(h,p)=>(c(),f("div",ue,[r("div",de,[r("div",ce,[me,r("button",{onClick:p[0]||(p[0]=y=>h.$emit("close")),class:"text-gray-400 hover:text-gray-600"},[_(w(S),{class:"h-6 w-6"})])]),r("div",he,[r("div",fe,[_(w(A),{class:"h-6 w-6 text-red-600"})])]),r("div",pe,[r("p",ge,d(e.request.request_number),1),r("p",ve,d(e.request.first_name)+" "+d(e.request.last_name),1),r("p",xe,d(e.request.email),1)]),_e,r("div",ye,[we,C(r("input",{"onUpdate:modelValue":p[1]||(p[1]=y=>i.value=y),type:"text",placeholder:"eliminar",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500",onKeyup:O(g,["enter"])},null,544),[[z,i.value]]),i.value&&!u.value?(c(),f("p",qe,' Debes escribir exactamente "eliminar" para confirmar ')):E("",!0)]),l.value?(c(),f("div",be,[r("p",Re,d(l.value),1)])):E("",!0),r("div",Ee,[r("button",{onClick:p[2]||(p[2]=y=>h.$emit("close")),disabled:m.value,class:"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md disabled:opacity-50 disabled:cursor-not-allowed"}," Cancelar ",8,$e),r("button",{onClick:q,disabled:!u.value||m.value,class:"px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed rounded-md"},d(m.value?"Eliminando...":"Eliminar Solicitud"),9,Se)])])]))}};export{G as _,ke as a,Ne as b,D as u};
