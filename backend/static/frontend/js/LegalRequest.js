import{e as g,f as v,g as s,C as X,D as Q,E as k,am as W,an as Y,u as K,r as $,b as ee,c as se,o as te,h as m,i as y,m as E,j as l,w as D,v as ae,F as I,N as F,p as b,n as x,s as w,a9 as re,a4 as N,k as q,t as L,l as C,Q as oe,a5 as le,R as ne}from"./index.js";import{s as ie,h as T}from"./loading_message.js";import{_ as de}from"./SearchBarAndFilterBy.js";import{a as P,i as B,n as O,r as V,b as j,u as G,l as z}from"./combobox.js";import{r as M}from"./DocumentIcon.js";import"./MagnifyingGlassIcon2.js";function J(r,o){return g(),v("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[s("path",{"fill-rule":"evenodd",d:"M5.5 17a4.5 4.5 0 0 1-1.44-8.765 4.5 4.5 0 0 1 8.302-3.046 3.5 3.5 0 0 1 4.504 4.272A4 4 0 0 1 15 17H5.5Zm3.75-2.75a.75.75 0 0 0 1.5 0V9.66l1.95 2.1a.75.75 0 1 0 1.1-1.02l-3.25-3.5a.75.75 0 0 0-1.1 0l-3.25 3.5a.75.75 0 1 0 1.1 1.02l1.95-2.1v4.59Z","clip-rule":"evenodd"})])}function ce(r,o){return g(),v("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[s("path",{"fill-rule":"evenodd",d:"M1 5.25A2.25 2.25 0 0 1 3.25 3h13.5A2.25 2.25 0 0 1 19 5.25v9.5A2.25 2.25 0 0 1 16.75 17H3.25A2.25 2.25 0 0 1 1 14.75v-9.5Zm1.5 5.81v3.69c0 .414.336.75.75.75h13.5a.75.75 0 0 0 .75-.75v-2.69l-2.22-2.219a.75.75 0 0 0-1.06 0l-1.91 1.909.47.47a.75.75 0 1 1-1.06 1.06L6.53 8.091a.75.75 0 0 0-1.06 0l-2.97 2.97ZM12 7a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z","clip-rule":"evenodd"})])}function ue(r,o){return g(),v("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[s("path",{d:"M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z"})])}const pe=X("legalRequest",{state:()=>({legalRequests:[],dataLoaded:!1,legalRequestTypes:[],legalDisciplines:[],lastCreatedRequestId:null}),actions:{async init(){this.dataLoaded||await this.fetchDropDownOptionsData()},async fetchDropDownOptionsData(){try{let o=(await Q("dropdown_options_legal_request/")).data;if(o&&typeof o=="string")try{o=JSON.parse(o)}catch(c){console.error("JSON parse error:",c.message),o={legal_request_types:[],legal_disciplines:[]}}this.legalRequestTypes=o.legal_request_types??[],this.legalDisciplines=o.legal_disciplines??[],this.dataLoaded=!0}catch(r){console.error("Error fetching dropdown options data:",r.message),this.legalRequestTypes=[],this.legalDisciplines=[],this.dataLoaded=!1}},async createLegalRequest(r){const o={firstName:r.firstName,lastName:r.lastName,email:r.email,requestTypeId:r.requestTypeId.id,disciplineId:r.disciplineId.id,description:r.description},c=new FormData;c.append("mainData",JSON.stringify(o));try{const u=await k("create_legal_request/",c);if(u.status===201){const f=u.data.id;this.lastCreatedRequestId=f,console.log("Legal request received successfully:",u.data.message);const a=r.requestTypeId.name||"legal",i=r.disciplineId.name||"";return W(Y.CREATE,`Radicaste una solicitud de ${a}${i?` en ${i}`:""}.`).catch(h=>{console.warn("Activity registration failed:",h)}),setTimeout(()=>{this.sendConfirmationEmailAsync(f)},200),r.files&&r.files.length>0&&setTimeout(()=>{this.uploadFilesAsync(f,r.files)},300),this.dataLoaded=!1,u.status}else return console.error("Failed to create legal request:",u.status),null}catch(u){return console.error("Error creating legal request:",u.message),null}},async uploadFiles(r,o){const c=[];for(const u of o)try{const f=new FormData;f.append("file",u),f.append("legalRequestId",r);const a=await k("upload_legal_request_file/",f);c.push({file:u.name,success:a.status===201})}catch(f){console.error(`Error uploading file ${u.name}:`,f.message),c.push({file:u.name,success:!1})}return c},async uploadFilesAsync(r,o){const f=async(a,i=0)=>{try{return await k("upload_legal_request_file/",a)}catch(h){if(i<3){const _=1e3*Math.pow(2,i)+Math.random()*1e3;return console.log(`Retry ${i+1}/3 for file upload after ${_}ms`),await new Promise(R=>setTimeout(R,_)),f(a,i+1)}throw h}};try{const a=new FormData;a.append("legalRequestId",r),o.forEach((h,_)=>{a.append("files",h)}),console.log(`Starting upload of ${o.length} files for legal request ${r}`);const i=await f(a);i.status===201?console.log("Files uploaded successfully:",i.data):console.warn("Some files may have failed to upload:",i.data)}catch(a){console.error("Error uploading files after all retries:",a.message)}},getLastCreatedRequestId(){return this.lastCreatedRequestId},async sendConfirmationEmailAsync(r){try{const o=new FormData;o.append("legal_request_id",r),(await k("send_confirmation_email/",o)).status===200?console.log(`Confirmation email sent for legal request ${r}`):console.warn(`Failed to send confirmation email for legal request ${r}`)}catch(o){console.error(`Error sending confirmation email for legal request ${r}:`,o)}}}}),me={class:"p-6"},ge={class:"pb-10 px-4 sm:px-6 lg:px-8"},fe={class:"w-full p-5 rounded-lg border-2 border-stroke bg-terciary"},he=s("div",null,[s("h1",{class:"text-primary text-xl font-semibold"},"Presentar Solicitud")],-1),ye={class:"mt-4 space-y-3"},ve={class:"grid md:grid-cols-2 xl:grid-cols-3 gap-3"},xe=s("span",{class:"text-red-500"},"*",-1),be={class:"relative mt-2"},_e=s("span",{class:"text-red-500"},"*",-1),we={class:"relative mt-2"},qe={class:"col-span-full"},ke=s("label",{for:"description",class:"block text-base font-medium leading-6 text-primary"},[b(" Descripción "),s("span",{class:"text-red-500"},"*")],-1),$e={class:"mt-2"},Ie={class:"col-span-full"},Ce=s("label",{for:"files",class:"block text-base font-medium leading-6 text-primary"}," Anexos ",-1),Re={key:0,class:"text-center"},Ee={class:"mt-4 flex text-sm/6 text-gray-600"},Fe={for:"file-upload",class:"relative cursor-pointer rounded-md bg-white font-semibold text-indigo-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-indigo-600 focus-within:ring-offset-2 hover:text-indigo-500"},Le=s("span",null,"Sube archivos",-1),Me=s("p",{class:"pl-1"},"o arrastra y suelta",-1),Se=s("p",{class:"text-xs/5 text-gray-600"}," PNG, JPG, PDF, DOCX de hasta 30MB ",-1),Ae={key:1,class:"w-full"},De={class:"flex flex-wrap gap-3 mb-4"},Ne=["onMouseenter","onMouseleave"],Te=["onClick"],Pe={class:"text-center text-xs truncate w-20"},Be={class:"text-center"},Oe={for:"additional-files",class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-600 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 cursor-pointer"},Ve=s("p",{class:"text-xs text-gray-500 mt-2"},[b(" PNG, JPG, PDF, DOCX de hasta 30MB cada uno"),s("br"),b(" Puedes seleccionar múltiples archivos ")],-1),je={class:"flex gap-3 span-col-full"},Ge=["disabled"],ze=s("span",null,"Guardar",-1),Je=[ze],Ze=s("span",null,"Cancelar",-1),Ue=30*1024*1024,es={__name:"LegalRequest",setup(r){const o=K(),c=pe(),u=$([]),f=$([]),a=ee({requestTypeId:"",disciplineId:"",description:"",files:[]}),i=$(null),h=$([]),_=p=>{const t=Array.from(p.target.files);S(t),p.target.value=null},R=p=>{p.preventDefault();const t=Array.from(p.dataTransfer.files);S(t)},S=p=>{p.forEach(t=>{if(t.size>Ue){w(`El archivo "${t.name}" excede el límite de 30 MB. Por favor, selecciona un archivo más pequeño.`,"warning");return}const e=t.name.split(".").pop().toLowerCase();let n="",d={general:"",xMark:""};switch(e){case"png":case"jpg":case"jpeg":n=ce,d.general="border-gray-200 text-gray-400",d.xMark="bg-gray-400";break;case"pdf":n=M,d.general="border-red-600/20 text-red-600/60",d.xMark="bg-red-600/60";break;case"doc":n=M,d.general="border-blue-600/20 text-blue-600/60",d.xMark="bg-blue-600/60";break;case"docx":n=M,d.general="border-blue-600/20 text-blue-600/60",d.xMark="bg-blue-600/60";break;default:w("¡Ups! Ese tipo de archivo no es compatible. Asegúrate de que el archivo sea PDF, DOC, DOCX, JPG, PNG, JPEG.","warning");return}h.value.push({name:t.name,icon:n,style:d,hover:!1,file:t})})},Z=p=>{h.value.splice(p,1)},A=se(()=>a.requestTypeId&&a.disciplineId&&a.description.trim()),U=async()=>{ie();const p=h.value.map(t=>t.file);a.files=p;try{const t={requestTypeId:a.requestTypeId,disciplineId:a.disciplineId,description:a.description,files:[]},e=await c.createLegalRequest(t);T(),e===201?(p.length>0?(w(`✅ ¡Solicitud recibida exitosamente! Tus ${p.length} archivo(s) se procesarán y recibirás un email de confirmación.`,"success"),setTimeout(async()=>{try{const n=c.getLastCreatedRequestId();n&&await c.uploadFilesAsync(n,p)}catch(n){console.error("Background file upload failed:",n)}},500)):w("✅ ¡Solicitud recibida exitosamente! Recibirás un email de confirmación en breve.","success"),H(),o.push({name:"legal_requests_list"})):w("Error al crear la solicitud. Intenta nuevamente.","error")}catch(t){T(),console.error("Error al enviar la solicitud:",t),w("Hubo un error inesperado. Por favor, inténtalo más tarde.","error")}},H=()=>{a.requestTypeId="",a.disciplineId="",a.description="",h.value=[]};return te(async()=>{await c.init(),u.value=c.legalRequestTypes,f.value=c.legalDisciplines}),(p,t)=>(g(),v(I,null,[s("div",me,[m(de,{"onUpdate:searchQuery":t[0]||(t[0]=e=>p.searchQuery=e)},{default:y(()=>[re(p.$slots,"default")]),_:3})]),s("div",ge,[s("div",fe,[he,s("form",{onSubmit:t[11]||(t[11]=E(e=>U(),["prevent"]))},[s("div",ye,[s("div",ve,[s("div",null,[m(l(z),{as:"div",modelValue:a.requestTypeId,"onUpdate:modelValue":[t[3]||(t[3]=e=>a.requestTypeId=e),t[4]||(t[4]=e=>i.value="")]},{default:y(()=>[m(l(P),{class:"block text-base font-medium leading-6 text-primary"},{default:y(()=>[b(" Tipo de solicitud "),xe]),_:1}),s("div",be,[m(l(B),{class:"w-full rounded-md border-0 bg-white py-1.5 pl-3 pr-10 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-secondary sm:text-sm sm:leading-6",onChange:t[1]||(t[1]=e=>i.value=e.target.value),onBlur:t[2]||(t[2]=e=>i.value=""),"display-value":e=>e!=null&&e.name?`${e==null?void 0:e.name}`:""},null,8,["display-value"]),m(l(O),{class:"absolute inset-y-0 right-0 flex items-center gap-2 rounded-r-md px-2 focus:outline-none border-l border-gray-300"},{default:y(()=>[b(" Seleccionar "),m(l(N),{class:"h-5 w-5 text-gray-400","aria-hidden":"true"})]),_:1}),u.value?(g(),q(l(G),{key:0,class:"absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm"},{default:y(()=>[(g(!0),v(I,null,F(u.value,e=>(g(),q(l(V),{key:e.id,value:e,as:"template"},{default:y(({active:n,selected:d})=>[s("li",{class:x(["relative cursor-default select-none py-2 pl-3 pr-9",n?"bg-secondary text-white":"text-primary"])},[s("span",{class:x(["block truncate",d&&"font-semibold"])},L(e.name),3),d?(g(),v("span",{key:0,class:x(["absolute inset-y-0 right-0 flex items-center pr-4",n?"text-white":"text-secondary"])},[m(l(j),{class:"h-5 w-5","aria-hidden":"true"})],2)):C("",!0)],2)]),_:2},1032,["value"]))),128))]),_:1})):C("",!0)])]),_:1},8,["modelValue"])]),s("div",null,[m(l(z),{as:"div",modelValue:a.disciplineId,"onUpdate:modelValue":[t[7]||(t[7]=e=>a.disciplineId=e),t[8]||(t[8]=e=>i.value="")]},{default:y(()=>[m(l(P),{class:"block text-base font-medium leading-6 text-primary"},{default:y(()=>[b(" Especialidad "),_e]),_:1}),s("div",we,[m(l(B),{class:"w-full rounded-md border-0 bg-white py-1.5 pl-3 pr-10 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-secondary sm:text-sm sm:leading-6",onChange:t[5]||(t[5]=e=>i.value=e.target.value),onBlur:t[6]||(t[6]=e=>i.value=""),"display-value":e=>e!=null&&e.name?`${e==null?void 0:e.name}`:""},null,8,["display-value"]),m(l(O),{class:"absolute inset-y-0 right-0 flex items-center gap-2 rounded-r-md px-2 focus:outline-none border-l border-gray-300"},{default:y(()=>[b(" Seleccionar "),m(l(N),{class:"h-5 w-5 text-gray-400","aria-hidden":"true"})]),_:1}),f.value?(g(),q(l(G),{key:0,class:"absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm"},{default:y(()=>[(g(!0),v(I,null,F(f.value,e=>(g(),q(l(V),{key:e.id,value:e,as:"template"},{default:y(({active:n,selected:d})=>[s("li",{class:x(["relative cursor-default select-none py-2 pl-3 pr-9",n?"bg-secondary text-white":"text-primary"])},[s("span",{class:x(["block truncate",d&&"font-semibold"])},L(e.name),3),d?(g(),v("span",{key:0,class:x(["absolute inset-y-0 right-0 flex items-center pr-4",n?"text-white":"text-secondary"])},[m(l(j),{class:"h-5 w-5","aria-hidden":"true"})],2)):C("",!0)],2)]),_:2},1032,["value"]))),128))]),_:1})):C("",!0)])]),_:1},8,["modelValue"])]),s("div",qe,[ke,s("div",$e,[D(s("textarea",{"onUpdate:modelValue":t[9]||(t[9]=e=>a.description=e),rows:"4",name:"comment",id:"comment",class:"block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-secondary sm:text-sm sm:leading-6",required:""},null,512),[[ae,a.description]])])]),s("div",Ie,[Ce,s("div",{class:"mt-2 flex justify-center rounded-lg border border-dashed border-gray-900/25 bg-white px-6 py-10",onDragover:t[10]||(t[10]=E(()=>{},["prevent"])),onDrop:E(R,["prevent"])},[h.value.length<1?(g(),v("div",Re,[m(l(J),{class:"mx-auto size-12 text-gray-300","aria-hidden":"true"}),s("div",Ee,[s("label",Fe,[Le,s("input",{id:"file-upload",name:"file-upload",type:"file",multiple:"",accept:".pdf,.docx,.jpg,.jpeg,.png",class:"sr-only",onChange:_},null,32)]),Me]),Se])):(g(),v("div",Ae,[s("div",De,[(g(!0),v(I,null,F(h.value,(e,n)=>(g(),v("div",{key:n,class:x(["relative p-4 grid rounded-md bg-white border-2",e.style.general]),onMouseenter:d=>e.hover=!0,onMouseleave:d=>e.hover=!1},[D(s("div",{class:x(["absolute p-0.5 mt-2 ml-2 rounded-full",e.style.xMark]),onClick:d=>Z(n)},[m(l(ue),{class:"size-3 text-white"})],10,Te),[[oe,e.hover]]),(g(),q(le(e.icon),{class:"size-12 mx-auto"})),s("span",Pe,L(e.name),1)],42,Ne))),128))]),s("div",Be,[s("label",Oe,[m(l(J),{class:"w-4 h-4 mr-2"}),b(" Agregar más archivos "),s("input",{id:"additional-files",name:"additional-files",type:"file",multiple:"",accept:".pdf,.docx,.jpg,.jpeg,.png",class:"sr-only",onChange:_},null,32)]),Ve])]))],32)]),s("div",je,[s("button",{type:"submit",class:x(["p-2.5 text-sm font-medium rounded-md flex gap-2",A.value?"bg-secondary text-white":"bg-gray-200 text-secondary border-2 border-dashed border-secondary cursor-not-allowed bg-opacity-50"]),disabled:!A.value},Je,10,Ge),m(l(ne),{to:{name:"process_list"},type:"button",class:"p-2.5 text-sm font-medium rounded-md flex gap-2 bg-red-600/80 text-white cursor-pointer"},{default:y(()=>[Ze]),_:1})])])])],32)])])],64))}};export{es as default};
