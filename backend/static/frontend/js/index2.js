import{r as C,D as f,E,ao as c,ap as d,a2 as $,a3 as w,a$ as y,q as D,C as P}from"./index.js";const T=()=>({documents:[],selectedDocument:null,dataLoaded:!1,lastUpdatedDocumentId:null,isLoading:!1,lastFetchTime:null,documentCache:{},tags:[],tagsLoaded:!1,isLoadingTags:!1,pagination:{currentPage:1,itemsPerPage:10,totalItems:0,totalPages:0,hasMore:!1}}),_={documentById:e=>t=>e.documentCache[t]?e.documentCache[t]:e.documents.find(r=>r.id==t)||null,tagById:e=>t=>e.tags.find(r=>r.id==t)||null,sortedTags:e=>[...e.tags].sort((t,r)=>t.name.localeCompare(r.name)),publishedDocumentsUnassigned:e=>e.documents.filter(t=>t.state==="Published"&&!t.assigned_to),draftAndPublishedDocumentsUnassigned:e=>e.documents.filter(t=>(t.state==="Draft"||t.state==="Published")&&!t.assigned_to),progressDocumentsByClient:e=>e.documents.filter(t=>t.state==="Progress"),pendingSignatureDocuments:e=>e.documents.filter(t=>t.state==="PendingSignatures"),fullySignedDocuments:e=>e.documents.filter(t=>t.state==="FullySigned"),completedDocumentsByClient:e=>e.documents.filter(t=>t.state==="Completed"),progressAndCompletedDocumentsByClient:e=>t=>{if(!t)return[];const r=String(t);return e.documents.filter(a=>(a.assigned_to?String(a.assigned_to):null)===r&&(a.state==="Progress"||a.state==="Completed"))},documentsByClient:e=>t=>t?e.documents.filter(s=>s.client_id===parseInt(t)):[],getDocumentsByLawyerId:e=>t=>t?e.documents.filter(r=>r.created_by===parseInt(t)&&(r.state==="Draft"||r.state==="Published")):[]},S={filteredDocuments:e=>(t,r)=>{if(!t)return e.documents;const s=t.toLowerCase();return e.documents.filter(a=>{var n,o,i,m,h,l,p,g;return a.title.toLowerCase().includes(s)||a.state.toLowerCase().includes(s)||a.assigned_to&&r&&(((o=(n=r.userById(a.assigned_to))==null?void 0:n.first_name)==null?void 0:o.toLowerCase().includes(s))||((m=(i=r.userById(a.assigned_to))==null?void 0:i.last_name)==null?void 0:m.toLowerCase().includes(s))||((l=(h=r.userById(a.assigned_to))==null?void 0:h.email)==null?void 0:l.toLowerCase().includes(s))||((g=(p=r.userById(a.assigned_to))==null?void 0:p.identification)==null?void 0:g.toLowerCase().includes(s)))})},filteredDocumentsByTags:e=>t=>!t||t.length===0?e.documents:e.documents.filter(r=>!r.tags||r.tags.length===0?!1:r.tags.some(s=>t.includes(s.id))),filteredDocumentsBySearchAndTags:e=>(t,r,s)=>{let a=e.documents;if(t){const n=t.toLowerCase();a=a.filter(o=>{var i,m,h,l,p,g,u,L;return o.title.toLowerCase().includes(n)||o.state.toLowerCase().includes(n)||o.assigned_to&&r&&(((m=(i=r.userById(o.assigned_to))==null?void 0:i.first_name)==null?void 0:m.toLowerCase().includes(n))||((l=(h=r.userById(o.assigned_to))==null?void 0:h.last_name)==null?void 0:l.toLowerCase().includes(n))||((g=(p=r.userById(o.assigned_to))==null?void 0:p.email)==null?void 0:g.toLowerCase().includes(n))||((L=(u=r.userById(o.assigned_to))==null?void 0:u.identification)==null?void 0:L.toLowerCase().includes(n)))})}return s&&s.length>0&&(a=a.filter(n=>!n.tags||n.tags.length===0?!1:n.tags.some(o=>s.includes(o.id)))),a}},A=C(!1),I=C({title:"",content:""}),U=e=>{if(!e)return"";let t=e.content||"";return["Completed","PendingSignatures","FullySigned"].includes(e.state)&&e.variables&&Array.isArray(e.variables)&&e.variables.forEach(s=>{if(!s||!s.name_en)return;const a=new RegExp(`{{\\s*${s.name_en}\\s*}}`,"g");let n=s.value||"";if(s.summary_field==="value"&&n!==""){const i=String(n).replace(/[^0-9.,-]/g,"").replace(/\./g,"").replace(",","."),m=Number(i);if(!Number.isNaN(m)){const h=m.toLocaleString("es-CO",{maximumFractionDigits:2}),l=s.currency||"",g={COP:"COP $",USD:"US $",EUR:"EUR €"}[l]||l||"";n=g?`${g} ${h}`:h}}t=t.replace(a,n)}),t},x=e=>{const t=U(e);I.value={title:(e==null?void 0:e.title)||"",content:t},A.value=!0;const r=R();e&&e.id&&(r.lastUpdatedDocumentId=e.id,localStorage.setItem("lastUpdatedDocumentId",e.id.toString()))},b=async(e,t,r="application/pdf")=>{let s=null;try{const a=await f(e,"blob");if(!a||!a.data)throw new Error("[ERROR] No response data received.");if(a.data instanceof Blob&&a.data.size<1e3){const i=await a.data.text();if(i.includes("error")||i.includes("Error"))throw new Error(`[ERROR] Server returned error: ${i}`)}const n=new Blob([a.data],{type:r}),o=document.createElement("a");s=window.URL.createObjectURL(n),o.href=s,o.download=t,document.body.appendChild(o),o.click()}catch(a){throw console.error("[ERROR] Error downloading file:",a),a}finally{s&&window.URL.revokeObjectURL(s);const a=document.querySelector("a[download]");a&&document.body.removeChild(a)}},B={async init(e=!1){const t=!this.lastFetchTime||Date.now()-this.lastFetchTime>3e5;(!this.dataLoaded||t||e)&&await this.fetchDocuments({forceRefresh:e});const r=localStorage.getItem("lastUpdatedDocumentId");r&&(this.lastUpdatedDocumentId=parseInt(r))},async fetchDocuments(e={}){const{page:t=1,limit:r=this.pagination.itemsPerPage,state:s="",states:a=null,clientId:n=null,lawyerId:o=null,forceRefresh:i=!1,append:m=!1}=e;if(!(this.isLoading||this.lastFetchTime&&Date.now()-this.lastFetchTime<30*1e3&&!i&&this.dataLoaded)){this.isLoading=!0;try{const l=new URLSearchParams;l.append("page",t),l.append("limit",r),s&&l.append("state",s),Array.isArray(a)&&a.length>0&&l.append("states",a.join(",")),n&&l.append("client_id",n),o&&l.append("lawyer_id",o);const p=`dynamic-documents/?${l.toString()}`;let u=(await f(p)).data;return!u.items&&Array.isArray(u)&&(u={items:u,totalItems:u.length,totalPages:1,currentPage:1}),this.pagination={currentPage:t,itemsPerPage:r,totalItems:u.totalItems||u.items.length,totalPages:u.totalPages||1,hasMore:u.totalPages&&t<u.totalPages||!1},m&&t>1?this.documents=[...this.documents,...u.items]:this.documents=u.items||[],this.dataLoaded=!0,this.lastFetchTime=Date.now(),this.pagination}catch(l){throw console.error("Error fetching documents:",l),t===1&&(this.documents=[]),l}finally{this.isLoading=!1}}},async loadMoreDocuments(e={}){if(!this.pagination.hasMore||this.isLoading)return;const t=this.pagination.currentPage+1;return this.fetchDocuments({...e,page:t,append:!0})},async fetchDocumentById(e,t=!1){if(this.documentCache[e]&&!t)return this.documentCache[e];try{const s=(await f(`dynamic-documents/${e}/`)).data;this.documentCache[e]=s;const a=this.documents.findIndex(n=>n.id==e);return a>=0&&(this.documents[a]=s),s}catch(r){throw console.error(`Error fetching document ID ${e}:`,r),r}},async createDocument(e){try{e.state!=="Progress"&&e.state!=="Draft"&&e.state!=="PendingSignatures"&&e.state!=="Completed"&&e.assigned_to&&!e.requires_signature&&(e.state="Progress");const t=await E("dynamic-documents/create/",e);return this.documents.unshift(t.data),this.documentCache[t.data.id]=t.data,this.lastUpdatedDocumentId=t.data.id,localStorage.setItem("lastUpdatedDocumentId",t.data.id),await c(d.CREATE,`Creaste el nuevo documento ${e.title||"sin título"}`),t.data}catch(t){throw console.error("Error creating document:",t),t}},async updateDocument(e,t){try{const r=await $(`dynamic-documents/${e}/update/`,t);this.documentCache[e]=r.data;const s=this.documents.findIndex(a=>a.id==e);return s>=0&&(this.documents[s]=r.data),this.lastUpdatedDocumentId=e,localStorage.setItem("lastUpdatedDocumentId",e),await c(d.UPDATE,`Actualizaste el documento ${t.title||"sin título"}`),r.data}catch(r){throw console.error(`Error updating document ID ${e}:`,r),r}},async deleteDocument(e){try{let t="document";const r=this.documentById(e);r&&(t=r.title);const s=await w(`dynamic-documents/${e}/delete/`);return s.status>=200&&s.status<300?(delete this.documentCache[e],this.documents=this.documents.filter(a=>a.id!=e),await c(d.DELETE,`Eliminaste el documento ${t}`),!0):!1}catch(t){return console.error(`Error deleting document ID ${e}:`,t),!1}},async downloadPDF(e,t){try{await b(`dynamic-documents/${e}/download-pdf/`,`${t}.pdf`),await c(d.DOWNLOAD,`Descargaste en PDF "${t}"`)}catch(r){throw console.error(`Error downloading PDF for document ID ${e}:`,r),r}},async downloadWord(e,t){try{await b(`dynamic-documents/${e}/download-word/`,`${t}.docx`,"application/vnd.openxmlformats-officedocument.wordprocessingml.document"),await c(d.DOWNLOAD,`Descargaste en Word "${t}"`)}catch(r){throw console.error(`Error downloading Word document for document ID ${e}:`,r),r}},clearSelectedDocument(){this.selectedDocument=null},async uploadLetterheadImage(e,t){try{const r=new FormData;r.append("image",t);const s=await y(`dynamic-documents/${e}/letterhead/upload/`,r);return await c(d.UPDATE,`Subiste imagen de membrete para documento ID ${e}`),s}catch(r){throw console.error(`Error uploading letterhead image for document ID ${e}:`,r),r}},async getLetterheadImage(e,t="blob"){var n;const r=(n=document.cookie.split("; ").find(o=>o.startsWith("csrftoken=")))==null?void 0:n.split("=")[1],s=localStorage.getItem("token"),a={"X-CSRFToken":r,...s&&{Authorization:`Bearer ${s}`}};try{const o=await D.get(`/api/dynamic-documents/${e}/letterhead/`,{headers:a,responseType:t,validateStatus:i=>i===200||i===404});return o.status===404?null:o}catch(o){throw console.error(`Error fetching letterhead image for document ID ${e}:`,o),o}},async deleteLetterheadImage(e){try{const t=await w(`dynamic-documents/${e}/letterhead/delete/`);return await c(d.DELETE,`Eliminaste imagen de membrete para documento ID ${e}`),t}catch(t){throw console.error(`Error deleting letterhead image for document ID ${e}:`,t),t}},async uploadGlobalLetterheadImage(e){try{const t=new FormData;t.append("image",e);const r=await y("user/letterhead/upload/",t);return await c(d.UPDATE,"Subiste imagen de membrete global"),r}catch(t){throw console.error("Error uploading global letterhead image:",t),t}},async getGlobalLetterheadImage(e="blob"){var t;try{return await f("user/letterhead/",e)}catch(r){throw((t=r.response)==null?void 0:t.status)!==404&&console.error("Error fetching global letterhead image:",r),r}},async deleteGlobalLetterheadImage(){try{const e=await w("user/letterhead/delete/");return await c(d.DELETE,"Eliminaste imagen de membrete global"),e}catch(e){throw console.error("Error deleting global letterhead image:",e),e}},async uploadGlobalLetterheadWordTemplate(e){try{const t=new FormData;t.append("template",e);const r=await y("user/letterhead/word-template/upload/",t);return await c(d.UPDATE,"Subiste plantilla Word de membrete global"),r}catch(t){throw console.error("Error uploading global Word letterhead template:",t),t}},async getGlobalLetterheadWordTemplate(e="blob"){var a;const t=(a=document.cookie.split("; ").find(n=>n.startsWith("csrftoken=")))==null?void 0:a.split("=")[1],r=localStorage.getItem("token"),s={"X-CSRFToken":t,...r&&{Authorization:`Bearer ${r}`}};try{const n=await D.get("/api/user/letterhead/word-template/",{headers:s,responseType:e,validateStatus:o=>o===200||o===404});return n.status===404?null:n}catch(n){throw console.error("Error fetching global Word letterhead template:",n),n}},async deleteGlobalLetterheadWordTemplate(){try{const e=await w("user/letterhead/word-template/delete/");return await c(d.DELETE,"Eliminaste plantilla Word de membrete global"),e}catch(e){throw console.error("Error deleting global Word letterhead template:",e),e}},async uploadDocumentLetterheadWordTemplate(e,t){try{const r=new FormData;r.append("template",t);const s=await y(`dynamic-documents/${e}/letterhead/word-template/upload/`,r);return await c(d.UPDATE,`Subiste plantilla Word de membrete para documento ID ${e}`),s}catch(r){throw console.error(`Error uploading Word letterhead template for document ID ${e}:`,r),r}},async getDocumentLetterheadWordTemplate(e,t="blob"){var n;const r=(n=document.cookie.split("; ").find(o=>o.startsWith("csrftoken=")))==null?void 0:n.split("=")[1],s=localStorage.getItem("token"),a={"X-CSRFToken":r,...s&&{Authorization:`Bearer ${s}`}};try{const o=await D.get(`/api/dynamic-documents/${e}/letterhead/word-template/`,{headers:a,responseType:t,validateStatus:i=>i===200||i===404});return o.status===404?null:o}catch(o){throw console.error(`Error fetching Word letterhead template for document ID ${e}:`,o),o}},async deleteDocumentLetterheadWordTemplate(e){try{const t=await w(`dynamic-documents/${e}/letterhead/word-template/delete/`);return await c(d.DELETE,`Eliminaste plantilla Word de membrete para documento ID ${e}`),t}catch(t){throw console.error(`Error deleting Word letterhead template for document ID ${e}:`,t),t}}},W={async fetchTags(e=!1){if(this.isLoadingTags)return this.tags;if(this.tagsLoaded&&!e)return this.tags;this.isLoadingTags=!0;try{const t=await f("dynamic-documents/tags/");return this.tags=t.data||[],this.tagsLoaded=!0,this.tags}catch(t){throw console.error("Error fetching tags:",t),this.tags=[],t}finally{this.isLoadingTags=!1}},async createTag(e){try{const t=await E("dynamic-documents/tags/create/",e);return this.tags.push(t.data),await c(d.CREATE,`Creaste la etiqueta "${e.name}"`),t.data}catch(t){throw console.error("Error creating tag:",t),t}},async updateTag(e,t){try{const r=await $(`dynamic-documents/tags/${e}/update/`,t),s=this.tags.findIndex(a=>a.id==e);return s>=0&&(this.tags[s]=r.data),await c(d.UPDATE,`Actualizaste la etiqueta "${t.name||"sin nombre"}"`),r.data}catch(r){throw console.error(`Error updating tag ID ${e}:`,r),r}},async deleteTag(e){try{let t="etiqueta";const r=this.tagById(e);return r&&(t=r.name),(await w(`dynamic-documents/tags/${e}/delete/`)).status===204?(this.tags=this.tags.filter(a=>a.id!=e),await c(d.DELETE,`Eliminaste la etiqueta "${t}"`),!0):!1}catch(t){return console.error(`Error deleting tag ID ${e}:`,t),!1}},async initTags(e=!1){(!this.tagsLoaded||e)&&await this.fetchTags(e)}},k={async fetchAvailableClients(){var e;try{return(((e=(await f("dynamic-documents/permissions/clients/")).data)==null?void 0:e.clients)||[]).map(a=>({id:a.user_id,user_id:a.user_id,email:a.email,full_name:a.full_name,role:a.role}))}catch(t){throw console.error("Error fetching available clients:",t),t}},async fetchDocumentPermissions(e){try{return(await f(`dynamic-documents/${e}/permissions/`)).data}catch(t){throw console.error(`Error fetching permissions for document ${e}:`,t),t}},async fetchAvailableRoles(){try{return(await f("dynamic-documents/permissions/roles/")).data}catch(e){throw console.error("Error fetching available roles:",e),e}},async manageDocumentPermissions(e,t){try{return(await E(`dynamic-documents/${e}/permissions/manage/`,t)).data}catch(r){throw console.error(`Error managing permissions for document ${e}:`,r),r}}},R=P("dynamicDocument",{state:T,getters:{..._,...S},actions:{...B,...W,...k}});export{b as d,U as g,x as o,I as p,A as s,R as u};
