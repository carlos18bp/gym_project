import{e as u,f as _,g as e,r as U,s as d,E as ne,w as K,Q as ie,m as I,k as V,t as C,j,l as h,G as Z,a1 as $e,u as ae,c as z,a8 as L,n as M,a4 as le,ad as ke,ae as Ce,af as Ee,F as W,M as H,ag as Se,i as O,p as G,ac as Pe,aU as Fe,N as ce,O as de,aH as Me,o as Oe,ap as ze,h as J,v as ue,b as Be,T as me,D as te,P as ge,aY as je,aj as Te}from"./index.js";import{r as Ie,g as re}from"./color_palette.js";import{useRecentViews as Ue}from"./useRecentViews.js";import{u as fe,o as pe,d as Ae}from"./dynamicDocument.js";import{_ as he}from"./_plugin-vue_export-helper.js";import{r as qe,a as Ne}from"./PhotoIcon.js";import{s as Re,h as oe,r as ee}from"./loading_message.js";function Le(s,f){return u(),_("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})])}function Ve(s,f){return u(),_("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z"})])}function We(s,f){return u(),_("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M18.364 18.364A9 9 0 0 0 5.636 5.636m12.728 12.728A9 9 0 0 1 5.636 5.636m12.728 12.728L5.636 5.636"})])}function Ge(){const s=U(!1),f=U("");async function o(r,D,n="",w="",g=[],v={}){if(!D)throw f.value="Recipient email is required.",await d(f.value,"error"),new Error(f.value);const y=new FormData;y.append("to_email",D),y.append("subject",n),y.append("body",w),g.forEach(($,l)=>{y.append(`attachments[${l}]`,$)});for(const[$,l]of Object.entries(v))y.append($,l);try{s.value=!0,f.value="",Re("Sending email...","Please wait while we send the email.");const $=await ne(r,y);return oe(),await d("Email sent successfully.","success"),$.data}catch($){throw oe(),console.error("Error sending email:",$.message),f.value="An error occurred while sending the email. Please try again.",await d(f.value,"error"),$}finally{s.value=!1}}return{sendEmail:o,isLoading:s,errorMessage:f}}const Ze={class:"bg-white rounded-lg shadow-xl p-6 max-w-4xl w-full overflow-auto max-h-[80vh]"},He={class:"flex justify-between items-center mb-4"},Qe={class:"text-lg font-bold"},Xe=["innerHTML"],Va={__name:"DocumentPreviewModal",props:{isVisible:Boolean,documentData:{type:Object,default:()=>({title:"",content:""})}},emits:["close"],setup(s,{emit:f}){const o=f,r=()=>{o("close")};return(D,n)=>K((u(),I($e,null,{default:V(()=>[e("div",Ze,[e("div",He,[e("h2",Qe," Previsualización del Documento: "+C(s.documentData.title),1),e("button",{onClick:r},[j(h(Z),{class:"size-6 text-gray-500 hover:text-gray-700"})])]),e("div",{class:"prose max-w-none",innerHTML:s.documentData.content},null,8,Xe)])]),_:1},512)),[[ie,s.isVisible]])}},be=s=>(ce("data-v-68dfb8fb"),s=s(),de(),s),Ye=["data-document-id"],Je={class:"flex justify-between items-start mb-3"},Ke={class:"flex items-center gap-2"},et={class:"py-1"},tt=["disabled","onClick"],at={class:"space-y-2"},st={class:"text-lg font-semibold text-gray-900 leading-tight"},rt={key:0,class:"text-sm text-gray-600 leading-relaxed"},ot={key:1,class:"pt-2"},nt={class:"flex items-center gap-2 flex-wrap"},it=be(()=>e("span",{class:"text-xs font-medium text-gray-500"},"Etiquetas:",-1)),lt={class:"flex items-center gap-1.5"},ct=["title"],dt={class:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 hidden group-hover:block z-50"},ut={class:"bg-gray-900 text-white text-xs rounded-lg py-1.5 px-2.5 whitespace-nowrap shadow-lg"},mt=be(()=>e("div",{class:"absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-[4px] border-r-[4px] border-t-[4px] border-transparent border-t-gray-900"},null,-1)),gt={__name:"BaseDocumentCard",props:{document:{type:Object,required:!0},cardType:{type:String,default:"default"},cardContext:{type:String,default:"list"},highlightedDocId:{type:[String,Number],default:null},showTags:{type:Boolean,default:!0},additionalClasses:{type:[String,Array,Object],default:""},statusIcon:{type:[String,Object,Function],default:null},statusText:{type:String,default:null},statusBadgeClasses:{type:[String,Object,Array],default:null},menuOptions:{type:Array,default:null},documentStore:{type:Object,default:null},userStore:{type:Object,default:null},promptDocuments:{type:Boolean,default:!1},enableModals:{type:Boolean,default:!0},editModalComponent:{type:String,default:"UseDocumentByClient"},editRoute:{type:String,default:null},enableSignatures:{type:Boolean,default:!0},disableInternalActions:{type:Boolean,default:!1},showMenuOptions:{type:Boolean,default:null}},emits:["click","refresh","remove-from-folder"],setup(s,{emit:f}){const o=ae(),r=s,D=f,{activeModals:n,openModal:w,closeModal:g,getUserRole:v}=ja(r.documentStore,r.userStore),{handlePreviewDocument:y,deleteDocument:$,downloadPDFDocument:l,downloadWordDocument:F,copyDocument:q,publishDocument:N,moveToDraft:t,formalizeDocument:c,signDocument:S,downloadSignedDocument:B}=Ta(r.documentStore,r.userStore,D),b=a=>{a.target.closest(".menu-container")||D("click",r.document,a)},p=()=>{D("refresh")},x={default:{getMenuOptions:(a,i)=>{const m=[];return m.push({label:"Usar Formato",action:"useDocument"}),i==="folder"&&m.push({label:"Quitar de Carpeta",action:"removeFromFolder"}),m}},client:{getMenuOptions:(a,i)=>{const m=[];return m.push({label:a.state==="Completed"?"Editar":"Completar",action:"edit"}),a.state==="Completed"&&m.push({label:"Previsualizar",action:"preview"}),m.push({label:"Eliminar",action:"delete"}),a.state==="Completed"&&m.push({label:"Descargar PDF",action:"downloadPDF"},{label:"Descargar Word",action:"downloadWord"},{label:"Enviar",action:"email"}),i==="folder"&&m.push({label:"Quitar de Carpeta",action:"removeFromFolder"}),m}},lawyer:{getMenuOptions:(a,i)=>{const m=[{label:"Editar",action:"edit"},{label:"Eliminar",action:"delete"},{label:"Previsualización",action:"preview"},{label:"Crear una Copia",action:"copy"}];return a.state==="Draft"?m.push({label:"Publicar",action:"publish",disabled:!De(a)}):a.state==="Published"&&(m.push({label:"Mover a Borrador",action:"draft"}),m.push({label:"Formalizar y Agregar Firmas",action:"formalize"})),(a.state==="Completed"||a.state==="Published")&&m.push({label:"Descargar PDF",action:"downloadPDF"},{label:"Descargar Word",action:"downloadWord"},{label:"Enviar por Email",action:"email"}),a.requires_signature&&(m.push({label:"Ver Firmas",action:"viewSignatures"}),se(a)&&m.push({label:"Firmar documento",action:"sign"})),m}},signatures:{getMenuOptions:(a,i)=>{const m=[{label:"Previsualizar",action:"preview"}];return a.requires_signature&&(a.state==="PendingSignatures"||a.state==="FullySigned")&&m.push({label:"Estado de las firmas",action:"viewSignatures"}),se(a)&&m.push({label:"Firmar documento",action:"sign"}),a.state==="FullySigned"&&m.push({label:"Descargar Documento firmado",action:"downloadSignedDocument"}),a.state==="PendingSignatures"&&m.push({label:"Descargar PDF",action:"downloadPDF"}),i==="folder"&&m.push({label:"Quitar de Carpeta",action:"removeFromFolder"}),m}}},P=z(()=>{if(r.menuOptions!==null)return r.menuOptions;if(r.showMenuOptions===!1)return[];if(r.showMenuOptions===!0){const i=x[r.cardType];return i?i.getMenuOptions(r.document,r.cardContext):[]}const a=x[r.cardType];return a?a.getMenuOptions(r.document,r.cardContext):[]}),k=z(()=>r.promptDocuments?"right-0 left-auto sm:right-auto sm:left-0 sm:-translate-x-[calc(100%-24px)]":"right-0 left-auto sm:left-0 sm:right-auto"),T=z(()=>{switch(r.document.state){case"Completed":case"Published":case"FullySigned":return"border-green-400 bg-green-50/50 shadow-green-100";case"Progress":case"Draft":return"border-blue-300 bg-blue-50/30 shadow-blue-100";case"PendingSignatures":return"border-yellow-400 bg-yellow-50/50 shadow-yellow-100";default:return"border-gray-200 bg-white"}}),A=z(()=>{if(!r.highlightedDocId||String(r.document.id)!==String(r.highlightedDocId))return"";const a=r.document.state;return a==="Published"||a==="FullySigned"||a==="Completed"?"shadow-lg animate-pulse-highlight-green":a==="PendingSignatures"?"shadow-lg animate-pulse-highlight-yellow":"shadow-lg animate-pulse-highlight-blue"}),ye=z(()=>{if(r.statusIcon)return r.statusIcon;switch(r.document.state){case"Published":case"FullySigned":case"Completed":return Le;case"Draft":case"Progress":case"PendingSignatures":default:return Ie}}),we=z(()=>{if(r.statusText)return r.statusText;switch(r.document.state){case"Published":return"Publicado";case"Draft":return"Borrador";case"Progress":return"En progreso";case"Completed":return"Completado";case"PendingSignatures":return"Pendiente de firmas";case"FullySigned":return"Completamente firmado";default:return"Desconocido"}}),ve=z(()=>{if(r.statusBadgeClasses)return r.statusBadgeClasses;switch(r.document.state){case"Published":case"FullySigned":case"Completed":return"bg-green-100 text-green-700 border border-green-200";case"Draft":case"Progress":return"bg-blue-100 text-blue-700 border border-blue-200";case"PendingSignatures":return"bg-yellow-100 text-yellow-700 border border-yellow-200";default:return"bg-gray-100 text-gray-700 border border-gray-200"}}),_e=async(a,i)=>{try{switch(a){case"edit":await xe(i);break;case"preview":await y(i);break;case"delete":await $(i);break;case"downloadPDF":await l(i);break;case"downloadWord":await F(i);break;case"email":w("email",i);break;case"copy":await q(i);break;case"publish":await N(i);break;case"draft":await t(i);break;case"formalize":await c(i);break;case"viewSignatures":w("signatures",i);break;case"sign":await S(i,w);break;case"downloadSignedDocument":await B(i);break;case"removeFromFolder":D("remove-from-folder",i);break;case"useDocument":D("click",i);break;default:console.warn("Unknown action:",a)}}catch(m){console.error(`Error executing action ${a}:`,m)}},xe=async a=>{if(r.editRoute){const i=encodeURIComponent(a.title.trim()),m=r.editRoute.replace(":id",a.id).replace(":title",i);o.push(m)}else w("edit",a,{userRole:v()})},De=a=>!a.variables||a.variables.length===0?!0:a.variables.every(i=>i.name_es&&i.name_es.trim().length>0),se=a=>{var E,R;if(!a.requires_signature||a.state!=="PendingSignatures"||!a.signatures||a.signatures.length===0)return!1;const i=(R=(E=r.userStore)==null?void 0:E.currentUser)==null?void 0:R.email,m=a.signatures.find(X=>X.signer_email===i);return!(!m||m.signed)};return(a,i)=>{var m;return u(),_(W,null,[e("div",{"data-document-id":s.document.id,class:M(["relative bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 p-4 cursor-pointer focus:outline-none focus:ring-0",[T.value,A.value,s.additionalClasses]]),onClick:b},[e("div",Je,[e("div",Ke,[L(a.$slots,"status-badge",{},()=>[e("div",{class:M(["inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium",ve.value])},[(u(),I(le(ye.value),{class:"w-3.5 h-3.5"})),e("span",null,C(we.value),1)],2)],!0),L(a.$slots,"additional-badges",{},void 0,!0)]),L(a.$slots,"right-action",{},()=>[P.value&&P.value.length>0?(u(),I(h(Pe),{key:0,as:"div",class:"relative inline-block text-left menu-container"},{default:V(()=>[j(h(ke),{class:"flex items-center justify-center w-8 h-8 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition-colors focus:outline-none focus:ring-0"},{default:V(()=>[j(h(Ve),{class:"w-5 h-5","aria-hidden":"true"})]),_:1}),j(Ce,{"enter-active-class":"transition ease-out duration-100","enter-from-class":"transform opacity-0 scale-95","enter-to-class":"transform opacity-100 scale-100","leave-active-class":"transition ease-in duration-75","leave-from-class":"transform opacity-100 scale-100","leave-to-class":"transform opacity-0 scale-95"},{default:V(()=>[j(h(Ee),{class:M(["absolute z-50 mt-2 w-56 rounded-md bg-white shadow-lg ring-1 ring-black/5 focus:outline-none",k.value])},{default:V(()=>[e("div",et,[(u(!0),_(W,null,H(P.value,E=>(u(),I(h(Se),{key:E.label},{default:V(()=>[e("button",{class:M(["block w-full text-left px-4 py-2 text-sm font-regular hover:bg-gray-100 transition focus:outline-none focus:ring-0",{"opacity-50 cursor-not-allowed":E.disabled,"cursor-pointer":!E.disabled}]),disabled:E.disabled,onClick:R=>_e(E.action,s.document)},[E.disabled?(u(),I(h(We),{key:0,class:"size-5 text-gray-400 inline mr-2","aria-hidden":"true"})):O("",!0),G(" "+C(E.label),1)],10,tt)]),_:2},1024))),128))])]),_:1},8,["class"])]),_:1})]),_:1})):O("",!0)],!0)]),e("div",at,[e("h3",st,C(s.document.title),1),s.document.description?(u(),_("p",rt,C(s.document.description),1)):O("",!0),L(a.$slots,"additional-content",{},void 0,!0),s.showTags&&s.document.tags&&s.document.tags.length>0?(u(),_("div",ot,[e("div",nt,[it,e("div",lt,[(u(!0),_(W,null,H(s.document.tags,E=>{var R,X;return u(),_("div",{key:E.id,class:"group relative"},[e("div",{class:"w-5 h-5 rounded-full cursor-pointer transition-all duration-200 hover:scale-110 hover:ring-2 hover:ring-offset-1 shadow-sm",style:Fe({backgroundColor:((R=h(re)(E.color_id))==null?void 0:R.hex)||"#9CA3AF",boxShadow:`0 0 0 1px ${((X=h(re)(E.color_id))==null?void 0:X.dark)||"#6B7280"}40`}),title:E.name},null,12,ct),e("div",dt,[e("div",ut,[G(C(E.name)+" ",1),mt])])])}),128))])])])):O("",!0)]),L(a.$slots,"footer",{},void 0,!0),L(a.$slots,"additional-actions",{},void 0,!0)],10,Ye),h(n).edit.isOpen?(u(),I(h($t),{key:0,document:h(n).edit.document,"user-role":h(v)(),onClose:i[0]||(i[0]=E=>h(g)("edit"))},null,8,["document","user-role"])):O("",!0),h(n).email.isOpen?(u(),I(h(Zt),{key:1,document:h(n).email.document,onClose:i[1]||(i[1]=E=>h(g)("email"))},null,8,["document"])):O("",!0),h(n).signatures.isOpen?(u(),I(h(Pa),{key:2,"document-id":(m=h(n).signatures.document)==null?void 0:m.id,onClose:i[2]||(i[2]=E=>h(g)("signatures")),onRefresh:p},null,8,["document-id"])):O("",!0),h(n).electronicSignature.isOpen?(u(),I(h(Ba),{key:3,onClose:i[3]||(i[3]=E=>h(g)("electronicSignature"))})):O("",!0)],64)}}},Wa=he(gt,[["__scopeId","data-v-68dfb8fb"]]),ft={class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"},pt={class:"bg-white rounded-lg p-6 shadow-xl max-w-lg w-full"},ht={class:"flex justify-end"},bt=e("label",{for:"document-name",class:"block text-base font-medium leading-6 text-primary"},[G(" Nombre "),e("span",{class:"text-red-500"},"*")],-1),yt={class:"mt-2"},wt={class:"flex gap-2 mt-2.5"},vt=["disabled"],_t=e("span",null,"Actualizar nombre",-1),xt=[_t],Dt=["disabled"],$t={__name:"EditDocumentModal",props:{document:{type:Object,required:!0},userRole:{type:String,default:"client"}},emits:["close"],setup(s,{emit:f}){const o=s,r=ae(),D=fe(),n=f,w=U(""),g=U(""),v=()=>{n("close")};Me(()=>{var t,c;o.document?(w.value=((t=o.document)==null?void 0:t.title)||"",g.value=((c=o.document)==null?void 0:c.title)||""):(w.value="",g.value="")});const y=t=>{t.key==="Escape"&&v()};Oe(()=>{document.addEventListener("keydown",y)}),ze(()=>{document.removeEventListener("keydown",y)});const $=z(()=>w.value.trim().length>0),l=z(()=>{var t;return!!((t=o.document)!=null&&t.id)}),F=z(()=>l.value&&w.value.trim()!==g.value.trim()&&w.value.trim().length>0);async function q(){if(l.value&&F.value)try{const t={title:w.value.trim()};await D.updateDocument(o.document.id,t),g.value=w.value.trim(),d("Nombre del documento actualizado exitosamente.","success"),v()}catch(t){console.error("Error updating document name:",t),d("Error al actualizar el nombre del documento.","error")}}function N(){var c;const t=encodeURIComponent(w.value.trim());(c=o.document)!=null&&c.id&&!l.value?o.userRole==="lawyer"?r.push(`/dynamic_document_dashboard/lawyer/editor/create/${t}`):r.push(`/dynamic_document_dashboard/document/use/creator/${o.document.id}/${t}`):l.value?o.userRole==="lawyer"?r.push(`/dynamic_document_dashboard/lawyer/editor/edit/${o.document.id}`):r.push(`/dynamic_document_dashboard/document/use/editor/${o.document.id}/${t}`):d("Error: No se pudo continuar. Documento no seleccionado.","error")}return(t,c)=>(u(),_("div",ft,[e("div",pt,[e("div",ht,[e("button",{onClick:v},[j(h(Z),{class:"size-6"})])]),e("form",{onSubmit:J(N,["prevent"])},[e("div",null,[bt,e("div",yt,[K(e("input",{"onUpdate:modelValue":c[0]||(c[0]=S=>w.value=S),type:"text",id:"document-name",class:"block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300",required:""},null,512),[[ue,w.value]])])]),e("div",wt,[l.value?(u(),_("button",{key:0,type:"button",onClick:q,disabled:!F.value,class:M(["p-2.5 text-sm font-medium rounded-md flex gap-2",F.value?"bg-primary text-white cursor-pointer":"bg-gray-200 text-gray-400 cursor-not-allowed opacity-70"])},xt,10,vt)):O("",!0),e("button",{type:"submit",class:M(["p-2.5 text-sm font-medium rounded-md flex gap-2",$.value?"bg-secondary text-white":"bg-gray-200 text-secondary border-2 border-dashed border-secondary cursor-not-allowed bg-opacity-50"]),disabled:!$.value},[e("span",null,C(l.value?"Editar Documento":"Continuar"),1)],10,Dt)])],32)])]))}},kt={class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"},Ct={class:"bg-white rounded-lg p-6 shadow-xl max-w-lg w-full"},Et={class:"flex justify-end"},St=e("label",{for:"email",class:"block text-base font-medium leading-6 text-primary"},[G(" Correo electrónico "),e("span",{class:"text-red-500"},"*")],-1),Pt={class:"mt-2"},Ft={class:"mt-4"},Mt=e("label",{for:"files",class:"block text-base font-medium leading-6 text-primary"}," Anexos ",-1),Ot={key:0,class:"text-center"},zt={class:"mt-4 flex text-sm/6 text-gray-600"},Bt={for:"file-upload",class:"relative cursor-pointer rounded-md bg-white font-semibold text-indigo-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-indigo-600 focus-within:ring-offset-2 hover:text-indigo-500"},jt=e("span",null,"Sube un archivo",-1),Tt=e("p",{class:"pl-1"},"o arrastra y suelta",-1),It=e("p",{class:"text-xs/5 text-gray-600"}," PNG, JPG, PDF, DOCX de hasta 20MB ",-1),Ut={key:1,class:"w-full flex flex-wrap gap-3"},At=["onMouseenter","onMouseleave"],qt=["onClick"],Nt={class:"text-center text-xs truncate w-20"},Rt=["disabled"],Lt=e("span",null,"Enviar",-1),Vt=[Lt],Wt="dynamic-documents/send_email_with_attachments/",Gt=20*1024*1024,Zt={__name:"SendDocumentModal",props:{document:{type:Object,required:!0}},emits:["close"],setup(s,{emit:f}){const o=f,{sendEmail:r}=Ge(),D=U(null),n=s,w=()=>{g.email="",v.value=[],D.value=null},g=Be({email:""}),v=U([]),y=b=>{const p=Array.from(b.target.files);l(p),b.target.value=null},$=b=>{const p=Array.from(b.dataTransfer.files);l(p)},l=b=>{let p=v.value.reduce((x,P)=>x+P.file.size,0);b.forEach(x=>{if(x.size>Gt){d(`The file "${x.name}" exceeds the 20 MB limit.`,"warning");return}const P=x.name.split(".").pop().toLowerCase();let k="",T={general:"",xMark:""};switch(P){case"png":case"jpg":case"jpeg":k=Ne,T.general="border-gray-200 text-gray-400",T.xMark="bg-gray-400";break;case"pdf":k=ee,T.general="border-red-600/20 text-red-600/60",T.xMark="bg-red-600/60";break;case"docx":k=ee,T.general="border-blue-600/20 text-blue-600/60",T.xMark="bg-blue-600/60";break;default:d("Unsupported file type. Only PDF, DOCX, JPG, and PNG are allowed.","warning");return}v.value.push({name:x.name,icon:k,style:T,hover:!1,file:x}),p+=x.size})},F=b=>{v.value.splice(b,1)},q=b=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(b),N=z(()=>q(g.email)),t=z(()=>N.value),c=async b=>{try{const p=await te(`dynamic-documents/${b}/download-pdf/`,"blob");if(!p||!p.data)throw new Error("Invalid response from server");return new File([p.data],`document_${b}.pdf`,{type:"application/pdf"})}catch(p){return console.error("Error downloading PDF:",p),d("No se pudo descargar el documento PDF.","error"),null}};me(()=>n.document,b=>{b&&Object.keys(b).length>0&&b.id&&c(b.id)},{immediate:!0});const S=async()=>{try{if(n.document.id){const p=await c(n.document.id);p&&v.value.push({name:p.name,file:p,icon:ee,style:{general:"border-blue-600/20 text-blue-600/60",xMark:"bg-blue-600/60"},hover:!1})}const b=v.value.map(p=>p.file);await r(Wt,g.email,n.document.title,"Attached is the requested document along with additional attachments.",b,{documentId:n.document.id})}catch(b){console.error("Error sending the email:",b)}finally{B()}},B=()=>{w(),o("close")};return(b,p)=>(u(),_("div",kt,[e("div",Ct,[e("div",Et,[e("button",{onClick:p[0]||(p[0]=x=>B())},[j(h(Z),{class:"size-6"})])]),e("form",{onSubmit:J(S,["prevent"])},[e("div",null,[St,e("div",Pt,[K(e("input",{"onUpdate:modelValue":p[1]||(p[1]=x=>g.email=x),type:"text",name:"email",id:"email",class:"block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-secondary sm:text-sm sm:leading-6",required:""},null,512),[[ue,g.email]])])]),e("div",Ft,[Mt,e("div",{class:"mt-2 flex justify-center rounded-lg border border-dashed border-gray-900/25 bg-white px-6 py-10",onDragover:p[2]||(p[2]=J(()=>{},["prevent"])),onDrop:J($,["prevent"])},[v.value.length<1?(u(),_("div",Ot,[j(h(qe),{class:"mx-auto size-12 text-gray-300","aria-hidden":"true"}),e("div",zt,[e("label",Bt,[jt,e("input",{id:"file-upload",name:"file-upload",type:"file",class:"sr-only",onChange:y},null,32)]),Tt]),It])):(u(),_("div",Ut,[(u(!0),_(W,null,H(v.value,(x,P)=>(u(),_("div",{key:P,class:M(["relative p-4 grid rounded-md bg-white border-2",x.style.general]),onMouseenter:k=>x.hover=!0,onMouseleave:k=>x.hover=!1},[K(e("div",{class:M(["absolute p-0.5 mt-2 ml-2 rounded-full",x.style.xMark]),onClick:k=>F(P)},[j(h(Z),{class:"size-3 text-white"})],10,qt),[[ie,x.hover]]),(u(),I(le(x.icon),{class:"size-12 mx-auto"})),e("span",Nt,C(x.name),1)],42,At))),128))]))],32)]),e("button",{type:"submit",class:M(["mt-4 p-2.5 text-sm font-medium rounded-md flex gap-2",t.value?"bg-secondary text-white":"bg-gray-200 text-secondary border-2 border-dashed border-secondary cursor-not-allowed bg-opacity-50"]),disabled:!t.value},Vt,10,Rt)],32)])]))}},Q=s=>(ce("data-v-bdb27c61"),s=s(),de(),s),Ht={class:"fixed inset-0 z-50 flex items-center justify-center"},Qt={class:"relative bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col"},Xt=Q(()=>e("h2",{class:"text-xl font-semibold text-gray-800"},"Estado de firmas del documento",-1)),Yt=Q(()=>e("svg",{class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)),Jt=[Yt],Kt={class:"p-6 overflow-y-auto flex-grow"},ea={key:0,class:"text-center py-10"},ta=Q(()=>e("div",{class:"spinner"},null,-1)),aa=Q(()=>e("p",{class:"mt-4 text-gray-500"},"Cargando información de firmas...",-1)),sa=[ta,aa],ra={key:1},oa={class:"mb-4"},na={class:"text-lg font-medium text-gray-900"},ia={class:"text-sm text-gray-500"},la={class:"inline-flex items-center"},ca={key:0,class:"text-sm text-gray-500 mt-1"},da={class:"text-sm text-gray-500 mt-1"},ua={class:"mt-6"},ma={class:"min-w-full divide-y divide-gray-200"},ga=Q(()=>e("thead",null,[e("tr",null,[e("th",{class:"px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Usuario"),e("th",{class:"px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Estado"),e("th",{class:"px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Fecha de firma")])],-1)),fa={class:"bg-white divide-y divide-gray-200"},pa={class:"px-4 py-4 whitespace-nowrap"},ha={class:"flex items-center"},ba={class:"text-sm font-medium text-gray-900 flex items-center"},ya={key:0,class:"ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full"},wa={class:"text-sm text-gray-500"},va={class:"px-4 py-4 whitespace-nowrap"},_a={class:"px-4 py-4 whitespace-nowrap text-sm text-gray-500"},xa={class:"px-4 py-4 whitespace-nowrap"},Da={class:"flex items-center"},$a={class:"text-sm font-medium text-gray-900"},ka={class:"text-sm text-gray-500"},Ca={class:"px-4 py-4 whitespace-nowrap"},Ea={class:"px-4 py-4 whitespace-nowrap text-sm text-gray-500"},Sa={__name:"DocumentSignaturesModal",props:{documentId:Number},emits:["close","refresh"],setup(s,{emit:f}){const o=s,r=f;fe();const D=ge(),n=U(null),w=()=>{r("close")},g=y=>y?new Date(y).toLocaleString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"—",v=async()=>{if(!o.documentId){console.error("No document ID provided");return}try{const y=D.currentUser.id,$=await te(`dynamic-documents/user/${y}/pending-documents-full/`);if($.status!==200)throw new Error(`Error loading documents: ${$.status}`);const l=$.data.find(F=>F.id===o.documentId);if(l)n.value=l;else{const F=await te(`dynamic-documents/${o.documentId}/`);if(F.status!==200)throw new Error(`Error loading document: ${F.status}`);n.value=F.data}}catch(y){console.error("Error loading document data:",y),y.response&&console.error("Error response data:",y.response.data),n.value=null,await d("Error al cargar la información de firmas","error")}};return me(()=>o.documentId,y=>{y&&v()},{immediate:!0}),(y,$)=>(u(),_("div",Ht,[e("div",{class:"absolute inset-0 bg-black opacity-50",onClick:w}),e("div",Qt,[e("div",{class:"px-6 py-4 border-b border-gray-200"},[Xt,e("button",{onClick:w,class:"absolute top-4 right-4 text-gray-400 hover:text-gray-500"},Jt)]),e("div",Kt,[n.value?(u(),_("div",ra,[e("div",oa,[e("h3",na,C(n.value.title),1),e("p",ia,[e("span",la,[e("span",{class:M(["inline-block w-3 h-3 rounded-full mr-2",n.value.fully_signed?"bg-green-500":"bg-yellow-500"])},null,2),G(" "+C(n.value.fully_signed?"Documento completamente firmado":"Pendiente de firmas"),1)])]),n.value.creator?(u(),_("p",ca," Creado por: "+C(n.value.creator.name)+" ("+C(n.value.creator.email)+") ",1)):O("",!0),e("p",da," Firmas: "+C(n.value.completed_signatures||0)+"/"+C(n.value.total_signatures||0),1)]),e("div",ua,[e("table",ma,[ga,e("tbody",fa,[(u(!0),_(W,null,H(n.value.signers||[],l=>(u(),_("tr",{key:"sig_"+l.signature_id,class:M({"bg-blue-50":l.is_current_user})},[e("td",pa,[e("div",ha,[e("div",null,[e("div",ba,[G(C(l.signer_name)+" ",1),l.is_current_user?(u(),_("span",ya,"Tú")):O("",!0)]),e("div",wa,C(l.signer_email),1)])])]),e("td",va,[e("span",{class:M(["px-2 inline-flex text-xs leading-5 font-semibold rounded-full",l.signed?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"])},C(l.signed?"Firmado":"Pendiente"),3)]),e("td",_a,C(l.signed_at?g(l.signed_at):"—"),1)],2))),128)),!n.value.signers&&n.value.signatures?(u(!0),_(W,{key:0},H(n.value.signatures,l=>(u(),_("tr",{key:"old_"+l.id},[e("td",xa,[e("div",Da,[e("div",null,[e("div",$a,C(l.signer_name||l.signer_email),1),e("div",ka,C(l.signer_email),1)])])]),e("td",Ca,[e("span",{class:M(["px-2 inline-flex text-xs leading-5 font-semibold rounded-full",l.signed?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"])},C(l.signed?"Firmado":"Pendiente"),3)]),e("td",Ea,C(l.signed_at?g(l.signed_at):"—"),1)]))),128)):O("",!0)])])])])):(u(),_("div",ea,sa))]),e("div",{class:"px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end"},[e("button",{onClick:w,class:"px-4 py-2 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-400"}," Cerrar ")])])]))}},Pa=he(Sa,[["__scopeId","data-v-bdb27c61"]]),Fa={class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"},Ma={class:"bg-white rounded-lg p-6 max-w-2xl w-full mx-auto shadow-xl"},Oa={class:"flex justify-between items-center mb-4"},za=e("h2",{class:"text-lg font-medium text-primary"},"Firma Electrónica",-1),Ba={__name:"ElectronicSignatureModal",emits:["close"],setup(s,{emit:f}){const o=ge(),r=f,D=()=>{r("close")},n=async w=>{o.currentUser&&(o.currentUser.has_signature=!0),d("Firma electrónica guardada correctamente","success"),setTimeout(()=>{D()},500)};return(w,g)=>(u(),_("div",Fa,[e("div",Ma,[e("div",Oa,[za,e("button",{onClick:D,class:"text-gray-400 hover:text-gray-500"},[j(h(Z),{class:"h-6 w-6"})])]),j(je,{initialShowOptions:!0,"user-id":h(o).currentUser.id,onSignatureSaved:n,onCancel:D},null,8,["user-id"])])]))}};function Y(s){return Te.fire({title:s,icon:"question",showCancelButton:!0,confirmButtonText:"Aceptar",cancelButtonText:"Cancelar",buttonsStyling:!1}).then(f=>f.isConfirmed)}function ja(s,f){const o=U({edit:{isOpen:!1,document:null},email:{isOpen:!1,document:null},preview:{isOpen:!1,document:null},signatures:{isOpen:!1,document:null},electronicSignature:{isOpen:!1,document:null}}),r=(g,v,y={})=>{switch(n(),g){case"edit":o.value.edit={isOpen:!0,document:v,...y};break;case"email":o.value.email={isOpen:!0,document:v};break;case"preview":pe(v);break;case"signatures":o.value.signatures={isOpen:!0,document:v};break;case"electronic-signature":o.value.electronicSignature={isOpen:!0,document:v};break;default:console.warn(`Unknown modal type: ${g}`)}},D=g=>{o.value[g]&&(o.value[g]={isOpen:!1,document:null})},n=()=>{Object.keys(o.value).forEach(g=>{o.value[g]={isOpen:!1,document:null}})};return{activeModals:o,openModal:r,closeModal:D,closeAllModals:n,getUserRole:()=>{var g;return((g=f==null?void 0:f.currentUser)==null?void 0:g.role)||"client"}}}function Ta(s,f,o){const{registerView:r}=Ue(),D=ae();return{handlePreviewDocument:async t=>{await r("document",t.id),pe(t)},deleteDocument:async t=>{if(await Y(`¿Estás seguro de que deseas eliminar el documento "${t.title}"?`)&&s)try{await s.deleteDocument(t.id),await d("Documento eliminado exitosamente","success"),o("refresh")}catch(S){throw await d("Error al eliminar el documento","error"),S}},downloadPDFDocument:async t=>{if(s)try{await s.downloadPDF(t.id,t.title),await d("PDF descargado exitosamente","success")}catch(c){throw await d("Error al descargar el PDF","error"),c}},downloadWordDocument:async t=>{if(s)try{await s.downloadWord(t.id,t.title),await d("Documento Word descargado exitosamente","success")}catch(c){throw await d("Error al descargar el documento Word","error"),c}},copyDocument:async t=>{var c;if(!s){await d("Funcionalidad de duplicar no implementada aún","info");return}try{const S=new Date,B=String(S.getDate()).padStart(2,"0"),b=String(S.getMonth()+1).padStart(2,"0"),p=S.getFullYear(),x=`${B}${b}${p}`,P=`${t.title} ${x}`,k={title:P,content:t.content,state:"Draft",variables:((c=t.variables)==null?void 0:c.map(A=>({name_en:A.name_en,name_es:A.name_es,tooltip:A.tooltip,field_type:A.field_type,select_options:A.select_options,value:""})))||[],requires_signature:!1};if(!await Y(`¿Deseas crear una copia del documento '${t.title}'?`))return;await s.createDocument(k),await d(`Copia creada exitosamente: "${P}"`,"success"),o("refresh")}catch(S){console.error("Error creating document copy:",S),await d("Error al crear la copia del documento","error")}},publishDocument:async t=>{if(s)try{const c={...t,state:"Published"};await s.updateDocument(t.id,c),await d("Documento publicado exitosamente","success"),o("refresh")}catch(c){throw await d("Error al publicar el documento","error"),c}},moveToDraft:async t=>{if(s)try{const c={...t,state:"Draft"};await s.updateDocument(t.id,c),await d("Documento movido a borrador exitosamente","success"),o("refresh")}catch(c){throw await d("Error al mover el documento a borrador","error"),c}},formalizeDocument:async t=>{try{D.push(`/dynamic_document_dashboard/document/use/formalize/${t.id}/${t.title}`)}catch(c){console.error("Error al formalizar el documento:",c),await d("Error al formalizar el documento","error")}},signDocument:async(t,c)=>{var S;try{const B=f.currentUser.id,b=f.currentUser.email;if(!t.requires_signature){await d("Este documento no requiere firmas","error");return}const p=(S=t.signatures)==null?void 0:S.find(k=>k.signer_email===b);if(!p){await d("No estás autorizado para firmar este documento","error");return}if(p.signed){await d("Ya has firmado este documento","info");return}if(!f.currentUser.has_signature){await d("Para firmar documentos necesitas tener una firma registrada.","info"),await Y("¿Deseas crear una firma electrónica ahora?")?c("electronic-signature",t):await d("Necesitas una firma para poder firmar documentos.","warning");return}if(!await Y(`¿Estás seguro de que deseas firmar el documento "${t.title}"?`)){await d("Operación de firma cancelada","info");return}const P=`dynamic-documents/${t.id}/sign/${B}/`;try{await d("Procesando firma del documento...","info");const k=await ne(P,{});if(k.status===200||k.status===201)await d(`¡Documento "${t.title}" firmado correctamente!`,"success"),o("refresh");else throw new Error(`Unexpected server response: ${k.status} ${k.statusText}`)}catch(k){throw console.error("Error in HTTP request:",k),k}}catch(B){console.error("General error signing document:",B),await d(`Error al firmar el documento: ${B.message}`,"error")}},downloadSignedDocument:async t=>{try{if(t.state!=="FullySigned"){d("El documento debe estar completamente firmado para descargarlo","warning");return}if(!t.signatures||t.signatures.length===0){d("El documento no tiene firmas registradas","warning");return}const c=`dynamic-documents/${t.id}/generate-signatures-pdf/`;await Ae(c,`firmas_${t.title}.pdf`)}catch(c){console.error("Error downloading signed document:",c),d("Error al descargar el documento firmado","error")}}}}export{Wa as B,Va as _,Ve as a,Le as r,Ge as u};
