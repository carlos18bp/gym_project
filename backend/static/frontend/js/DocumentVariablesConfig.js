import{P as Y,r as D,c as O,s as v,aj as L,o as Z,e as u,f as m,l as t,g as e,j as S,p as B,F as N,M as U,n as P,b1 as j,t as C,h as F,i as T,G,w as I,v as z,bb as K,u as H,S as J,x as Q}from"./index.js";import{u as A}from"./index2.js";import{a as W,g as X,_ as ee}from"./DocumentPermissionsManager.js";import{r as te}from"./PlusIcon.js";import{r as oe}from"./PencilIcon.js";import{r as se}from"./TrashIcon.js";function ne(){const b=A(),$=Y(),o=D([]),y=D(!1),_=D(!1),g=D({name:"",color_id:1}),x=O(()=>{var n;return((n=$.getCurrentUser)==null?void 0:n.role)==="lawyer"}),h=O(()=>W()),q=async n=>{x.value&&(await b.initTags(),n!=null&&n.tags&&n.tags.length>0?o.value=[...n.tags]:o.value=[])},M=()=>{g.value={name:"",color_id:1},_.value=!1,y.value=!0},E=n=>{g.value={...n},_.value=!0,y.value=!0},w=()=>{y.value=!1,g.value={name:"",color_id:1},_.value=!1};return{selectedTags:o,showTagModal:y,isEditingTag:_,currentTag:g,isLawyer:x,availableColors:h,initializeTags:q,openCreateTagModal:M,openEditTagModal:E,closeTagModal:w,saveTag:async()=>{if(!g.value.name.trim()){await v("El nombre de la etiqueta es requerido","error");return}try{_.value?(await b.updateTag(g.value.id,{name:g.value.name,color_id:g.value.color_id}),await v("Etiqueta actualizada exitosamente","success")):(await b.createTag({name:g.value.name,color_id:g.value.color_id}),await v("Etiqueta creada exitosamente","success")),w()}catch(n){console.error("Error saving tag:",n),await v("Error al guardar la etiqueta","error")}},deleteTag:async n=>{if((await L.fire({title:"¿Estás seguro?",text:`¿Deseas eliminar la etiqueta "${n.name}"?`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"})).isConfirmed)try{await b.deleteTag(n.id)?(o.value=o.value.filter(d=>d.id!==n.id),await v("Etiqueta eliminada exitosamente","success")):await v("Error al eliminar la etiqueta","error")}catch(k){console.error("Error deleting tag:",k),await v("Error al eliminar la etiqueta","error")}},toggleTagSelection:n=>{const c=o.value.findIndex(k=>k.id===n.id);c>=0?o.value.splice(c,1):o.value.push(n)},isTagSelected:n=>o.value.some(c=>c.id===n.id),getTagColorStyles:n=>{const c=X(n);return{backgroundColor:c.light,borderColor:c.dark,color:c.dark}},getTagIds:()=>o.value.map(n=>n.id)}}const ae={key:0,class:"mt-6"},re={class:"flex items-center justify-between mb-4"},le=e("h3",{class:"text-lg font-medium text-primary"},"Etiquetas del Documento",-1),ie={class:"space-y-3"},de={key:0},ce=e("h4",{class:"text-sm font-medium text-gray-700 mb-2"},"Etiquetas Disponibles:",-1),ue={class:"flex flex-wrap gap-2"},me=["onClick"],pe={class:"mr-2"},ge=["onClick"],fe=["onClick"],_e={key:1},ye=e("h4",{class:"text-sm font-medium text-gray-700 mb-2"},"Etiquetas Seleccionadas:",-1),he={class:"flex flex-wrap gap-2"},xe={class:"mr-2"},ve=["onClick"],be={key:2,class:"text-center py-6"},we=e("p",{class:"text-gray-500"},"No hay etiquetas disponibles.",-1),ke=e("p",{class:"text-gray-400 text-sm mt-1"},"Crea la primera etiqueta para organizar tus documentos.",-1),Te=[we,ke],De={class:"mt-3"},Ce={class:"text-lg font-medium text-gray-900 mb-4"},$e={class:"mb-4"},Ee=e("label",{for:"tag-name",class:"block text-sm font-medium text-gray-700 mb-2"}," Nombre de la etiqueta ",-1),Se={class:"mb-6"},qe=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"}," Color de la etiqueta ",-1),Me={class:"grid grid-cols-8 gap-2"},Ne=["onClick","title"],Ie={class:"flex justify-end space-x-3"},Ve={__name:"DocumentTagsManager",props:{document:{type:Object,default:null}},setup(b,{expose:$}){const o=b,y=A(),{selectedTags:_,showTagModal:g,isEditingTag:x,currentTag:h,isLawyer:q,availableColors:M,initializeTags:E,openCreateTagModal:w,openEditTagModal:V,closeTagModal:s,saveTag:r,deleteTag:i,toggleTagSelection:p,isTagSelected:l,getTagColorStyles:n,getTagIds:c}=ne();return Z(async()=>{o.document&&await E(o.document)}),$({getTagIds:c}),(k,d)=>(u(),m(N,null,[t(q)?(u(),m("div",ae,[e("div",re,[le,e("button",{onClick:d[0]||(d[0]=(...a)=>t(w)&&t(w)(...a)),type:"button",class:"inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-secondary hover:bg-secondary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary"},[S(t(te),{class:"h-4 w-4 mr-2"}),B(" Nueva Etiqueta ")])]),e("div",ie,[t(y).tags&&t(y).tags.length>0?(u(),m("div",de,[ce,e("div",ue,[(u(!0),m(N,null,U(t(y).sortedTags,a=>(u(),m("div",{key:a.id,class:P(["inline-flex items-center px-3 py-1 rounded-full text-sm font-medium border-2 cursor-pointer transition-all duration-200",{"ring-2 ring-secondary":t(l)(a),"hover:shadow-md":!0}]),style:j(t(n)(a.color_id)),onClick:f=>t(p)(a)},[e("span",pe,C(a.name),1),e("button",{onClick:F(f=>t(V)(a),["stop"]),class:"ml-2 p-1 hover:bg-black hover:bg-opacity-10 rounded",title:"Editar etiqueta"},[S(t(oe),{class:"h-3 w-3"})],8,ge),e("button",{onClick:F(f=>t(i)(a),["stop"]),class:"ml-1 p-1 hover:bg-red-500 hover:bg-opacity-20 rounded",title:"Eliminar etiqueta"},[S(t(se),{class:"h-3 w-3"})],8,fe)],14,me))),128))])])):T("",!0),t(_).length>0?(u(),m("div",_e,[ye,e("div",he,[(u(!0),m(N,null,U(t(_),a=>(u(),m("div",{key:a.id,class:"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium border-2 ring-2 ring-secondary",style:j(t(n)(a.color_id))},[e("span",xe,C(a.name),1),e("button",{onClick:f=>t(p)(a),class:"ml-2 p-1 hover:bg-red-500 hover:bg-opacity-20 rounded",title:"Remover etiqueta"},[S(t(G),{class:"h-3 w-3"})],8,ve)],4))),128))])])):T("",!0),!t(y).tags||t(y).tags.length===0?(u(),m("div",be,Te)):T("",!0)])])):T("",!0),t(g)?(u(),m("div",{key:1,class:"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50",onClick:d[6]||(d[6]=(...a)=>t(s)&&t(s)(...a))},[e("div",{class:"relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white",onClick:d[5]||(d[5]=F(()=>{},["stop"]))},[e("div",De,[e("h3",Ce,C(t(x)?"Editar Etiqueta":"Nueva Etiqueta"),1),e("div",$e,[Ee,I(e("input",{id:"tag-name","onUpdate:modelValue":d[1]||(d[1]=a=>t(h).name=a),type:"text",class:"block w-full rounded-md border-gray-300 shadow-sm focus:border-secondary focus:ring-secondary sm:text-sm",placeholder:"Ingresa el nombre de la etiqueta",onKeydown:d[2]||(d[2]=K((...a)=>t(r)&&t(r)(...a),["enter"]))},null,544),[[z,t(h).name]])]),e("div",Se,[qe,e("div",Me,[(u(!0),m(N,null,U(t(M),a=>(u(),m("div",{key:a.id,class:P(["w-8 h-8 rounded-full cursor-pointer border-2 transition-all duration-200",{"ring-2 ring-secondary":t(h).color_id===a.id,"border-gray-300":t(h).color_id!==a.id,"border-secondary":t(h).color_id===a.id}]),style:j({backgroundColor:a.hex}),onClick:f=>t(h).color_id=a.id,title:a.name},null,14,Ne))),128))])]),e("div",Ie,[e("button",{onClick:d[3]||(d[3]=(...a)=>t(s)&&t(s)(...a)),type:"button",class:"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"}," Cancelar "),e("button",{onClick:d[4]||(d[4]=(...a)=>t(r)&&t(r)(...a)),type:"button",class:"px-4 py-2 text-sm font-medium text-white bg-secondary rounded-md hover:bg-secondary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary"},C(t(x)?"Actualizar":"Crear"),1)])])])])):T("",!0)],64))}},Ue={class:"pb-10 px-4 sm:px-6 lg:px-8 lg:pt-10"},ze={class:"w-full p-5 rounded-lg border-2 border-stroke bg-terciary"},Be={class:"text-primary text-xl font-semibold"},Re={class:"mt-4 space-y-4"},je={class:"text-primary text-lg font-semibold col-span-12"},Fe={class:"col-span-4"},Oe=["for"],Ae=e("span",{class:"text-red-500"},"*",-1),Pe=["onUpdate:modelValue","id"],Ye={key:0,class:"text-red-500 text-sm mt-1"},Le={class:"col-span-4"},Ze=e("label",{for:"tooltip",class:"block text-sm font-medium leading-6 text-primary"}," Tooltip ",-1),Ge=["onUpdate:modelValue"],Ke={class:"col-span-4"},He=e("label",{for:"field_type",class:"block text-sm font-medium leading-6 text-primary"},[B(" Tipo de input "),e("span",{class:"text-red-500"},"*")],-1),Je=["onUpdate:modelValue"],Qe=Q('<option value="input">Texto simple</option><option value="text_area">Texto largo</option><option value="number">Número</option><option value="date">Fecha</option><option value="email">Correo electrónico</option><option value="select">Selector</option>',6),We=[Qe],Xe={key:0,class:"col-span-12 mt-2"},et=e("label",{class:"block text-sm font-medium leading-6 text-primary"},[B(" Opciones del selector (separadas por coma) "),e("span",{class:"text-red-500"},"*")],-1),tt=["onUpdate:modelValue","onInput"],ot={class:"mt-6 flex space-x-4"},dt={__name:"DocumentVariablesConfig",setup(b){const $=H(),o=A(),y=Y(),_=D([]),g=D(null),x=D(null);O(()=>{var s;return((s=y.getCurrentUser)==null?void 0:s.role)==="lawyer"}),Z(async()=>{var s;if(!o.selectedDocument){console.error("No selected document found");return}if(o.selectedDocument.id&&(!o.selectedDocument.tags||o.selectedDocument.tags.length===0))try{const r=await o.fetchDocumentById(o.selectedDocument.id,!0);o.selectedDocument=r}catch(r){console.error("Error fetching full document:",r)}(s=o.selectedDocument)!=null&&s.variables&&o.selectedDocument.variables.forEach(r=>{r.field_type==="select"&&(r.select_options||(r.select_options=[]),r.select_options_text=r.select_options.join(", "))})});const h={input:s=>s&&s.trim().length>0,text_area:s=>s&&s.trim().length>0,number:s=>!isNaN(parseFloat(s))&&isFinite(s),date:s=>{if(!s||!/^\d{4}-\d{2}-\d{2}$/.test(s))return!1;const i=new Date(s);return i instanceof Date&&!isNaN(i)},email:s=>s?/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(s):!1},q=(s,r)=>{const i=s.target.value;r.select_options_text=i,r.select_options=i?i.split(",").map(p=>p.trim()).filter(p=>p!==""):[]},M=()=>{var r;_.value=[];let s=!0;return(r=o.selectedDocument)==null||r.variables.forEach((i,p)=>{const l=[];if((!i.name_es||i.name_es.trim()==="")&&l.push("El nombre en pantalla es obligatorio."),i.value&&i.value.trim()!==""){const n=h[i.field_type];if(n&&!n(i.value))switch(i.field_type){case"number":l.push("El valor debe ser un número válido.");break;case"date":l.push("El valor debe ser una fecha válida en formato YYYY-MM-DD.");break;case"email":l.push("El valor debe ser un correo electrónico válido.");break;default:l.push("El valor no es válido para este tipo de campo.")}}i.field_type==="select"&&(!i.select_options||i.select_options.length===0)&&l.push("Debe ingresar al menos una opción para el selector."),l.length>0&&(_.value[p]=l.join(" "),s=!1)}),s||L.fire({title:"Campos incompletos",text:"Por favor, verifica los campos obligatorios y sus formatos.",icon:"warning"}),s},E=s=>{M()&&w(s)},w=async s=>{var r,i;try{const p=((r=g.value)==null?void 0:r.getPermissionsData())||{},l=((i=x.value)==null?void 0:i.getTagIds())||[],n={title:o.selectedDocument.title,content:o.selectedDocument.content,state:s,variables:o.selectedDocument.variables.map(f=>({name_en:f.name_en,name_es:f.name_es,tooltip:f.tooltip||"",field_type:f.field_type,value:f.value,select_options:f.field_type==="select"?f.select_options:null})),tag_ids:l,...p},c=o.selectedDocument.title,k=o.selectedDocument.content;let d,a;if(o.selectedDocument.id?(d=o.selectedDocument.id,a=await o.updateDocument(d,n)):(a=await o.createDocument(n),a&&a.id&&(d=a.id)),o.selectedDocument=null,await o.init(),!d){const f=o.documents.find(R=>R.title===c&&R.content===k&&R.state===s);f&&(d=f.id)}d&&(window.localStorage.setItem("lastUpdatedDocumentId",d.toString()),o.lastUpdatedDocumentId=d),await v(s==="Draft"?"Documento guardado como borrador":"Documento publicado exitosamente","success"),setTimeout(()=>{$.push("/dynamic_document_dashboard")},300)}catch(p){console.error("Error saving document:",p)}},V=()=>{$.push("/dynamic_document_dashboard")};return(s,r)=>{var i,p;return u(),m("div",Ue,[e("div",ze,[e("h1",Be,C((i=t(o).selectedDocument)==null?void 0:i.title),1),e("div",Re,[(u(!0),m(N,null,U(((p=t(o).selectedDocument)==null?void 0:p.variables)||[],(l,n)=>(u(),m("div",{key:n,class:"grid grid-cols-12 gap-4 items-center"},[e("h2",je,C(l.name_en),1),e("div",Fe,[e("label",{for:"name_es_"+n,class:"block text-sm font-medium leading-6 text-primary"},[B(" Nombre en pantalla "),Ae],8,Oe),I(e("input",{type:"text","onUpdate:modelValue":c=>l.name_es=c,id:"name_es_"+n,class:"block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300",required:""},null,8,Pe),[[z,l.name_es]]),_.value[n]?(u(),m("p",Ye,C(_.value[n]),1)):T("",!0)]),e("div",Le,[Ze,I(e("input",{type:"text","onUpdate:modelValue":c=>l.tooltip=c,id:"tooltip",class:"block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300",placeholder:"Opcional"},null,8,Ge),[[z,l.tooltip]])]),e("div",Ke,[He,I(e("select",{"onUpdate:modelValue":c=>l.field_type=c,id:"field_type",class:"block w-full rounded-md border-0 py-1.5 text-primary shadow-sm"},We,8,Je),[[J,l.field_type]])]),l.field_type==="select"?(u(),m("div",Xe,[et,I(e("input",{type:"text","onUpdate:modelValue":c=>l.select_options_text=c,onInput:c=>q(c,l),class:"block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300",placeholder:"Opción 1, Opción 2, Opción 3"},null,40,tt),[[z,l.select_options_text]])])):T("",!0)]))),128))]),S(Ve,{ref_key:"tagsManagerRef",ref:x,document:t(o).selectedDocument},null,8,["document"]),S(ee,{ref_key:"permissionsManagerRef",ref:g,document:t(o).selectedDocument},null,8,["document"]),e("div",ot,[e("button",{onClick:r[0]||(r[0]=l=>E("Draft")),class:"p-2.5 text-sm font-medium rounded-md bg-secondary text-white"}," Guardar como borrador "),e("button",{onClick:r[1]||(r[1]=l=>E("Published")),class:"p-2.5 text-sm font-medium rounded-md bg-gray-200 text-secondary border-2"}," Publicar "),e("button",{onClick:r[2]||(r[2]=l=>V()),type:"button",class:"p-2.5 text-sm font-medium rounded-md flex gap-2 bg-red-600/80 text-white cursor-pointer"}," Cancelar ")])])])}}};export{dt as default};
