import{r as w,X as g,N as D,Y as y,ai as l,aj as u,Z as P,$ as C}from"./index.js";const L=w(!1),E=w({title:"",content:""}),$=e=>{let t=e.content;["Completed","PendingSignatures","FullySigned"].includes(e.state)&&e.variables&&Array.isArray(e.variables)&&e.variables.forEach(a=>{const o=new RegExp(`{{s*${a.name_en}s*}}`,"g");t=t.replace(o,a.value||"")}),E.value={title:e.title,content:t},L.value=!0;const n=I();e&&e.id&&(n.lastUpdatedDocumentId=e.id,localStorage.setItem("lastUpdatedDocumentId",e.id.toString()))},p=async(e,t,s="application/pdf")=>{let n=null;try{const a=await g(e,"blob");if(!a||!a.data)throw new Error("[ERROR] No response data received.");if(a.data instanceof Blob&&a.data.size<1e3){const d=await a.data.text();if(d.includes("error")||d.includes("Error"))throw new Error(`[ERROR] Server returned error: ${d}`)}const o=new Blob([a.data],{type:s}),c=document.createElement("a");n=window.URL.createObjectURL(o),c.href=n,c.download=t,document.body.appendChild(c),c.click()}catch(a){throw console.error("[ERROR] Error downloading file:",a),a}finally{n&&window.URL.revokeObjectURL(n);const a=document.querySelector("a[download]");a&&document.body.removeChild(a)}},I=D("dynamicDocument",{state:()=>({documents:[],selectedDocument:null,dataLoaded:!1,lastUpdatedDocumentId:null,isLoading:!1,lastFetchTime:null,documentCache:{},pagination:{currentPage:1,itemsPerPage:20,totalItems:0,totalPages:0,hasMore:!1}}),getters:{documentById:e=>t=>e.documentCache[t]?e.documentCache[t]:e.documents.find(s=>s.id==t)||null,publishedDocumentsUnassigned:e=>e.documents.filter(t=>t.state==="Published"&&!t.assigned_to),draftAndPublishedDocumentsUnassigned:e=>e.documents.filter(t=>(t.state==="Draft"||t.state==="Published")&&!t.assigned_to),progressDocumentsByClient:e=>e.documents.filter(t=>t.state==="Progress"),pendingSignatureDocuments:e=>e.documents.filter(t=>t.state==="PendingSignatures"),fullySignedDocuments:e=>e.documents.filter(t=>t.state==="FullySigned"),completedDocumentsByClient:e=>e.documents.filter(t=>t.state==="Completed"),progressAndCompletedDocumentsByClient:e=>t=>t?e.documents.filter(n=>{const a=n.assigned_to?String(n.assigned_to):null,o=String(t);return a===o&&(n.state==="Progress"||n.state==="Completed")}):[],filteredDocuments:e=>(t,s)=>{if(!t)return e.documents;const n=t.toLowerCase();return e.documents.filter(a=>{var o,c,d,h,i,m,f,r;return a.title.toLowerCase().includes(n)||a.state.toLowerCase().includes(n)||a.assigned_to&&s&&(((c=(o=s.userById(a.assigned_to))==null?void 0:o.first_name)==null?void 0:c.toLowerCase().includes(n))||((h=(d=s.userById(a.assigned_to))==null?void 0:d.last_name)==null?void 0:h.toLowerCase().includes(n))||((m=(i=s.userById(a.assigned_to))==null?void 0:i.email)==null?void 0:m.toLowerCase().includes(n))||((r=(f=s.userById(a.assigned_to))==null?void 0:f.identification)==null?void 0:r.toLowerCase().includes(n)))})},documentsByClient:e=>t=>t?e.documents.filter(n=>n.client_id===parseInt(t)):[],getDocumentsByLawyerId:e=>t=>t?e.documents.filter(s=>s.created_by===parseInt(t)&&(s.state==="Draft"||s.state==="Published")):[]},actions:{async init(e=!1){const t=!this.lastFetchTime||Date.now()-this.lastFetchTime>3e5;(!this.dataLoaded||t||e)&&await this.fetchDocuments({forceRefresh:e});const s=localStorage.getItem("lastUpdatedDocumentId");s&&(this.lastUpdatedDocumentId=parseInt(s))},async fetchDocuments(e={}){const{page:t=1,limit:s=this.pagination.itemsPerPage,state:n="",clientId:a=null,lawyerId:o=null,forceRefresh:c=!1,append:d=!1}=e;if(!(this.isLoading||this.lastFetchTime&&Date.now()-this.lastFetchTime<30*1e3&&!c&&this.dataLoaded)){this.isLoading=!0;try{const i=new URLSearchParams;i.append("page",t),i.append("limit",s),n&&i.append("state",n),a&&i.append("client_id",a),o&&i.append("lawyer_id",o);const m=`dynamic-documents/?${i.toString()}`;let r=(await g(m)).data;return!r.items&&Array.isArray(r)&&(r={items:r,totalItems:r.length,totalPages:1,currentPage:1}),this.pagination={currentPage:t,itemsPerPage:s,totalItems:r.totalItems||r.items.length,totalPages:r.totalPages||1,hasMore:r.totalPages&&t<r.totalPages||!1},d&&t>1?this.documents=[...this.documents,...r.items]:this.documents=r.items||[],this.dataLoaded=!0,this.lastFetchTime=Date.now(),this.pagination}catch(i){throw console.error("Error fetching documents:",i),t===1&&(this.documents=[]),i}finally{this.isLoading=!1}}},async loadMoreDocuments(e={}){if(!this.pagination.hasMore||this.isLoading)return;const t=this.pagination.currentPage+1;return this.fetchDocuments({...e,page:t,append:!0})},async fetchDocumentById(e,t=!1){if(this.documentCache[e]&&!t)return this.documentCache[e];try{const n=(await g(`dynamic-documents/${e}/`)).data;this.documentCache[e]=n;const a=this.documents.findIndex(o=>o.id==e);return a>=0&&(this.documents[a]=n),n}catch(s){throw console.error(`Error fetching document ID ${e}:`,s),s}},async createDocument(e){try{const t=await y("dynamic-documents/create/",e);return this.documents.unshift(t.data),this.documentCache[t.data.id]=t.data,this.lastUpdatedDocumentId=t.data.id,localStorage.setItem("lastUpdatedDocumentId",t.data.id),await l(u.CREATE,`Creaste el nuevo documento ${e.title||"sin título"}`),t.data}catch(t){throw console.error("Error creating document:",t),t}},async updateDocument(e,t){try{const s=await P(`dynamic-documents/${e}/update/`,t);this.documentCache[e]=s.data;const n=this.documents.findIndex(a=>a.id==e);return n>=0&&(this.documents[n]=s.data),this.lastUpdatedDocumentId=e,localStorage.setItem("lastUpdatedDocumentId",e),await l(u.UPDATE,`Actualizaste el documento ${t.title||"sin título"}`),s.data}catch(s){throw console.error(`Error updating document ID ${e}:`,s),s}},async deleteDocument(e){try{let t="document";const s=this.documentById(e);return s&&(t=s.title),(await C(`dynamic-documents/${e}/delete/`)).status===204?(delete this.documentCache[e],this.documents=this.documents.filter(a=>a.id!=e),await l(u.DELETE,`Eliminaste el documento ${t}`),!0):!1}catch(t){return console.error(`Error deleting document ID ${e}:`,t),!1}},async downloadPDF(e,t){try{await p(`dynamic-documents/${e}/download-pdf/`,`${t}.pdf`),await l(u.DOWNLOAD,`Descargaste en PDF "${t}"`)}catch(s){throw console.error(`Error downloading PDF for document ID ${e}:`,s),s}},async downloadWord(e,t){try{await p(`dynamic-documents/${e}/download-word/`,`${t}.docx`),await l(u.DOWNLOAD,`Descargaste en Word "${t}"`)}catch(s){throw console.error(`Error downloading Word document for document ID ${e}:`,s),s}},clearSelectedDocument(){this.selectedDocument=null}}});export{p as d,$ as o,E as p,L as s,I as u};
