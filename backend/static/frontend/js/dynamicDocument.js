import{r as D,X as g,N as w,Y as y,ah as d,ai as l,Z as C,$ as P}from"./index.js";const L=D(!1),E=D({title:"",content:""}),$=t=>{let e=t.content;t.variables.forEach(a=>{const n=new RegExp(`{{s*${a.name_en}s*}}`,"g");e=e.replace(n,a.value)||""}),E.value={title:t.title,content:t.assigned_to?e:t.content},L.value=!0;const s=I();t&&t.id&&(s.lastUpdatedDocumentId=t.id,localStorage.setItem("lastUpdatedDocumentId",t.id.toString()))},p=async(t,e,s="application/pdf")=>{try{const a=await g(t,"blob");if(!a||!a.data)throw new Error("[ERROR] No response data received.");const n=new Blob([a.data],{type:s}),r=document.createElement("a");r.href=window.URL.createObjectURL(n),r.download=e,document.body.appendChild(r),r.click(),document.body.removeChild(r)}catch(a){console.error("[ERROR] Error downloading file:",a)}},I=w("dynamicDocument",{state:()=>({documents:[],selectedDocument:null,dataLoaded:!1,lastUpdatedDocumentId:null,isLoading:!1,lastFetchTime:null,documentCache:{},pagination:{currentPage:1,itemsPerPage:20,totalItems:0,totalPages:0,hasMore:!1}}),getters:{documentById:t=>e=>t.documentCache[e]?t.documentCache[e]:t.documents.find(s=>s.id==e)||null,publishedDocumentsUnassigned:t=>t.documents.filter(e=>e.state==="Published"&&!e.assigned_to),draftAndPublishedDocumentsUnassigned:t=>t.documents.filter(e=>(e.state==="Draft"||e.state==="Published")&&!e.assigned_to),progressDocumentsByClient:t=>t.documents.filter(e=>e.state==="Progress"),completedDocumentsByClient:t=>t.documents.filter(e=>e.state==="Completed"),progressAndCompletedDocumentsByClient:t=>e=>e?t.documents.filter(a=>{const n=a.assigned_to?String(a.assigned_to):null,r=String(e);return n===r&&(a.state==="Progress"||a.state==="Completed")}):[],filteredDocuments:t=>(e,s)=>{if(!e)return t.documents;const a=e.toLowerCase();return t.documents.filter(n=>{var r,c,u,h,i,m,f,o;return n.title.toLowerCase().includes(a)||n.state.toLowerCase().includes(a)||n.assigned_to&&s&&(((c=(r=s.userById(n.assigned_to))==null?void 0:r.first_name)==null?void 0:c.toLowerCase().includes(a))||((h=(u=s.userById(n.assigned_to))==null?void 0:u.last_name)==null?void 0:h.toLowerCase().includes(a))||((m=(i=s.userById(n.assigned_to))==null?void 0:i.email)==null?void 0:m.toLowerCase().includes(a))||((o=(f=s.userById(n.assigned_to))==null?void 0:f.identification)==null?void 0:o.toLowerCase().includes(a)))})},documentsByClient:t=>e=>e?t.documents.filter(a=>a.client_id===parseInt(e)):[],getDocumentsByLawyerId:t=>e=>e?t.documents.filter(s=>s.created_by===parseInt(e)&&(s.state==="Draft"||s.state==="Published")):[]},actions:{async init(){const t=!this.lastFetchTime||Date.now()-this.lastFetchTime>3e5;(!this.dataLoaded||t)&&await this.fetchDocuments();const e=localStorage.getItem("lastUpdatedDocumentId");e&&(this.lastUpdatedDocumentId=parseInt(e))},async fetchDocuments(t={}){const{page:e=1,limit:s=this.pagination.itemsPerPage,state:a="",clientId:n=null,lawyerId:r=null,forceRefresh:c=!1,append:u=!1}=t;if(!(this.isLoading||this.lastFetchTime&&Date.now()-this.lastFetchTime<30*1e3&&!c&&this.dataLoaded)){this.isLoading=!0;try{const i=new URLSearchParams;i.append("page",e),i.append("limit",s),a&&i.append("state",a),n&&i.append("client_id",n),r&&i.append("lawyer_id",r);const m=`dynamic-documents/?${i.toString()}`;let o=(await g(m)).data;return!o.items&&Array.isArray(o)&&(o={items:o,totalItems:o.length,totalPages:1,currentPage:1}),this.pagination={currentPage:e,itemsPerPage:s,totalItems:o.totalItems||o.items.length,totalPages:o.totalPages||1,hasMore:o.totalPages&&e<o.totalPages||!1},u&&e>1?this.documents=[...this.documents,...o.items]:this.documents=o.items||[],this.dataLoaded=!0,this.lastFetchTime=Date.now(),this.pagination}catch(i){throw console.error("Error fetching documents:",i),e===1&&(this.documents=[]),i}finally{this.isLoading=!1}}},async loadMoreDocuments(t={}){if(!this.pagination.hasMore||this.isLoading)return;const e=this.pagination.currentPage+1;return this.fetchDocuments({...t,page:e,append:!0})},async fetchDocumentById(t,e=!1){if(this.documentCache[t]&&!e)return this.documentCache[t];try{const a=(await g(`dynamic-documents/${t}/`)).data;this.documentCache[t]=a;const n=this.documents.findIndex(r=>r.id==t);return n>=0&&(this.documents[n]=a),a}catch(s){throw console.error(`Error fetching document ID ${t}:`,s),s}},async createDocument(t){try{const e=await y("dynamic-documents/create/",t);return this.documents.unshift(e.data),this.documentCache[e.data.id]=e.data,this.lastUpdatedDocumentId=e.data.id,localStorage.setItem("lastUpdatedDocumentId",e.data.id),await d(l.CREATE,`Creaste el nuevo documento ${t.title||"sin título"}`),e.data}catch(e){throw console.error("Error creating document:",e),e}},async updateDocument(t,e){try{const s=await C(`dynamic-documents/${t}/update/`,e);this.documentCache[t]=s.data;const a=this.documents.findIndex(n=>n.id==t);return a>=0&&(this.documents[a]=s.data),this.lastUpdatedDocumentId=t,localStorage.setItem("lastUpdatedDocumentId",t),await d(l.UPDATE,`Actualizaste el documento ${e.title||"sin título"}`),s.data}catch(s){throw console.error(`Error updating document ID ${t}:`,s),s}},async deleteDocument(t){try{let e="document";const s=this.documentById(t);return s&&(e=s.title),(await P(`dynamic-documents/${t}/delete/`)).status===204?(delete this.documentCache[t],this.documents=this.documents.filter(n=>n.id!=t),await d(l.DELETE,`Eliminaste el documento ${e}`),!0):!1}catch(e){return console.error(`Error deleting document ID ${t}:`,e),!1}},async downloadPDF(t,e){try{await p(`dynamic-documents/${t}/download-pdf/`,`${e}.pdf`),await d(l.DOWNLOAD,`Descargaste en PDF "${e}"`)}catch(s){throw console.error(`Error downloading PDF for document ID ${t}:`,s),s}},async downloadWord(t,e){try{await p(`dynamic-documents/${t}/download-word/`,`${e}.docx`),await d(l.DOWNLOAD,`Descargaste en Word "${e}"`)}catch(s){throw console.error(`Error downloading Word document for document ID ${t}:`,s),s}},clearSelectedDocument(){this.selectedDocument=null}}});export{$ as o,E as p,L as s,I as u};
