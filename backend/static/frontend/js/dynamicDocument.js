import{r as E,D as f,C as P,E as w,ak as l,al as u,$ as D,a0 as C}from"./index.js";const _=E(!1),$=E({title:"",content:""}),B=t=>{let e=t.content;["Completed","PendingSignatures","FullySigned"].includes(t.state)&&t.variables&&Array.isArray(t.variables)&&t.variables.forEach(a=>{const r=new RegExp(`{{s*${a.name_en}s*}}`,"g");e=e.replace(r,a.value||"")}),$.value={title:t.title,content:e},_.value=!0;const n=T();t&&t.id&&(n.lastUpdatedDocumentId=t.id,localStorage.setItem("lastUpdatedDocumentId",t.id.toString()))},L=async(t,e,s="application/pdf")=>{let n=null;try{const a=await f(t,"blob");if(!a||!a.data)throw new Error("[ERROR] No response data received.");if(a.data instanceof Blob&&a.data.size<1e3){const c=await a.data.text();if(c.includes("error")||c.includes("Error"))throw new Error(`[ERROR] Server returned error: ${c}`)}const r=new Blob([a.data],{type:s}),i=document.createElement("a");n=window.URL.createObjectURL(r),i.href=n,i.download=e,document.body.appendChild(i),i.click()}catch(a){throw console.error("[ERROR] Error downloading file:",a),a}finally{n&&window.URL.revokeObjectURL(n);const a=document.querySelector("a[download]");a&&document.body.removeChild(a)}},T=P("dynamicDocument",{state:()=>({documents:[],selectedDocument:null,dataLoaded:!1,lastUpdatedDocumentId:null,isLoading:!1,lastFetchTime:null,documentCache:{},tags:[],tagsLoaded:!1,isLoadingTags:!1,pagination:{currentPage:1,itemsPerPage:20,totalItems:0,totalPages:0,hasMore:!1}}),getters:{documentById:t=>e=>t.documentCache[e]?t.documentCache[e]:t.documents.find(s=>s.id==e)||null,tagById:t=>e=>t.tags.find(s=>s.id==e)||null,sortedTags:t=>[...t.tags].sort((e,s)=>e.name.localeCompare(s.name)),publishedDocumentsUnassigned:t=>t.documents.filter(e=>e.state==="Published"&&!e.assigned_to),draftAndPublishedDocumentsUnassigned:t=>t.documents.filter(e=>(e.state==="Draft"||e.state==="Published")&&!e.assigned_to),progressDocumentsByClient:t=>t.documents.filter(e=>e.state==="Progress"),pendingSignatureDocuments:t=>t.documents.filter(e=>e.state==="PendingSignatures"),fullySignedDocuments:t=>t.documents.filter(e=>e.state==="FullySigned"),completedDocumentsByClient:t=>t.documents.filter(e=>e.state==="Completed"),progressAndCompletedDocumentsByClient:t=>e=>e?t.documents.filter(n=>{const a=n.assigned_to?String(n.assigned_to):null,r=String(e);return a===r&&(n.state==="Progress"||n.state==="Completed")}):[],filteredDocuments:t=>(e,s)=>{if(!e)return t.documents;const n=e.toLowerCase();return t.documents.filter(a=>{var r,i,c,g,d,m,h,o;return a.title.toLowerCase().includes(n)||a.state.toLowerCase().includes(n)||a.assigned_to&&s&&(((i=(r=s.userById(a.assigned_to))==null?void 0:r.first_name)==null?void 0:i.toLowerCase().includes(n))||((g=(c=s.userById(a.assigned_to))==null?void 0:c.last_name)==null?void 0:g.toLowerCase().includes(n))||((m=(d=s.userById(a.assigned_to))==null?void 0:d.email)==null?void 0:m.toLowerCase().includes(n))||((o=(h=s.userById(a.assigned_to))==null?void 0:h.identification)==null?void 0:o.toLowerCase().includes(n)))})},filteredDocumentsByTags:t=>e=>!e||e.length===0?t.documents:t.documents.filter(s=>!s.tags||s.tags.length===0?!1:s.tags.some(n=>e.includes(n.id))),filteredDocumentsBySearchAndTags:t=>(e,s,n)=>{let a=t.documents;if(e){const r=e.toLowerCase();a=a.filter(i=>{var c,g,d,m,h,o,p,y;return i.title.toLowerCase().includes(r)||i.state.toLowerCase().includes(r)||i.assigned_to&&s&&(((g=(c=s.userById(i.assigned_to))==null?void 0:c.first_name)==null?void 0:g.toLowerCase().includes(r))||((m=(d=s.userById(i.assigned_to))==null?void 0:d.last_name)==null?void 0:m.toLowerCase().includes(r))||((o=(h=s.userById(i.assigned_to))==null?void 0:h.email)==null?void 0:o.toLowerCase().includes(r))||((y=(p=s.userById(i.assigned_to))==null?void 0:p.identification)==null?void 0:y.toLowerCase().includes(r)))})}return n&&n.length>0&&(a=a.filter(r=>!r.tags||r.tags.length===0?!1:r.tags.some(i=>n.includes(i.id)))),a},documentsByClient:t=>e=>e?t.documents.filter(n=>n.client_id===parseInt(e)):[],getDocumentsByLawyerId:t=>e=>e?t.documents.filter(s=>s.created_by===parseInt(e)&&(s.state==="Draft"||s.state==="Published")):[]},actions:{async init(t=!1){const e=!this.lastFetchTime||Date.now()-this.lastFetchTime>3e5;(!this.dataLoaded||e||t)&&await this.fetchDocuments({forceRefresh:t});const s=localStorage.getItem("lastUpdatedDocumentId");s&&(this.lastUpdatedDocumentId=parseInt(s))},async fetchDocuments(t={}){const{page:e=1,limit:s=this.pagination.itemsPerPage,state:n="",clientId:a=null,lawyerId:r=null,forceRefresh:i=!1,append:c=!1}=t;if(!(this.isLoading||this.lastFetchTime&&Date.now()-this.lastFetchTime<30*1e3&&!i&&this.dataLoaded)){this.isLoading=!0;try{const d=new URLSearchParams;d.append("page",e),d.append("limit",s),n&&d.append("state",n),a&&d.append("client_id",a),r&&d.append("lawyer_id",r);const m=`dynamic-documents/?${d.toString()}`;let o=(await f(m)).data;return!o.items&&Array.isArray(o)&&(o={items:o,totalItems:o.length,totalPages:1,currentPage:1}),this.pagination={currentPage:e,itemsPerPage:s,totalItems:o.totalItems||o.items.length,totalPages:o.totalPages||1,hasMore:o.totalPages&&e<o.totalPages||!1},c&&e>1?this.documents=[...this.documents,...o.items]:this.documents=o.items||[],this.dataLoaded=!0,this.lastFetchTime=Date.now(),this.pagination}catch(d){throw console.error("Error fetching documents:",d),e===1&&(this.documents=[]),d}finally{this.isLoading=!1}}},async loadMoreDocuments(t={}){if(!this.pagination.hasMore||this.isLoading)return;const e=this.pagination.currentPage+1;return this.fetchDocuments({...t,page:e,append:!0})},async fetchDocumentById(t,e=!1){if(this.documentCache[t]&&!e)return this.documentCache[t];try{const n=(await f(`dynamic-documents/${t}/`)).data;this.documentCache[t]=n;const a=this.documents.findIndex(r=>r.id==t);return a>=0&&(this.documents[a]=n),n}catch(s){throw console.error(`Error fetching document ID ${t}:`,s),s}},async createDocument(t){try{const e=await w("dynamic-documents/create/",t);return this.documents.unshift(e.data),this.documentCache[e.data.id]=e.data,this.lastUpdatedDocumentId=e.data.id,localStorage.setItem("lastUpdatedDocumentId",e.data.id),await l(u.CREATE,`Creaste el nuevo documento ${t.title||"sin título"}`),e.data}catch(e){throw console.error("Error creating document:",e),e}},async updateDocument(t,e){try{const s=await D(`dynamic-documents/${t}/update/`,e);this.documentCache[t]=s.data;const n=this.documents.findIndex(a=>a.id==t);return n>=0&&(this.documents[n]=s.data),this.lastUpdatedDocumentId=t,localStorage.setItem("lastUpdatedDocumentId",t),await l(u.UPDATE,`Actualizaste el documento ${e.title||"sin título"}`),s.data}catch(s){throw console.error(`Error updating document ID ${t}:`,s),s}},async deleteDocument(t){try{let e="document";const s=this.documentById(t);return s&&(e=s.title),(await C(`dynamic-documents/${t}/delete/`)).status===204?(delete this.documentCache[t],this.documents=this.documents.filter(a=>a.id!=t),await l(u.DELETE,`Eliminaste el documento ${e}`),!0):!1}catch(e){return console.error(`Error deleting document ID ${t}:`,e),!1}},async downloadPDF(t,e){try{await L(`dynamic-documents/${t}/download-pdf/`,`${e}.pdf`),await l(u.DOWNLOAD,`Descargaste en PDF "${e}"`)}catch(s){throw console.error(`Error downloading PDF for document ID ${t}:`,s),s}},async downloadWord(t,e){try{await L(`dynamic-documents/${t}/download-word/`,`${e}.docx`),await l(u.DOWNLOAD,`Descargaste en Word "${e}"`)}catch(s){throw console.error(`Error downloading Word document for document ID ${t}:`,s),s}},clearSelectedDocument(){this.selectedDocument=null},async fetchTags(t=!1){if(this.isLoadingTags)return this.tags;if(this.tagsLoaded&&!t)return this.tags;this.isLoadingTags=!0;try{const e=await f("dynamic-documents/tags/");return this.tags=e.data||[],this.tagsLoaded=!0,this.tags}catch(e){throw console.error("Error fetching tags:",e),this.tags=[],e}finally{this.isLoadingTags=!1}},async createTag(t){try{const e=await w("dynamic-documents/tags/create/",t);return this.tags.push(e.data),await l(u.CREATE,`Creaste la etiqueta "${t.name}"`),e.data}catch(e){throw console.error("Error creating tag:",e),e}},async updateTag(t,e){try{const s=await D(`dynamic-documents/tags/${t}/update/`,e),n=this.tags.findIndex(a=>a.id==t);return n>=0&&(this.tags[n]=s.data),await l(u.UPDATE,`Actualizaste la etiqueta "${e.name||"sin nombre"}"`),s.data}catch(s){throw console.error(`Error updating tag ID ${t}:`,s),s}},async deleteTag(t){try{let e="etiqueta";const s=this.tagById(t);return s&&(e=s.name),(await C(`dynamic-documents/tags/${t}/delete/`)).status===204?(this.tags=this.tags.filter(a=>a.id!=t),await l(u.DELETE,`Eliminaste la etiqueta "${e}"`),!0):!1}catch(e){return console.error(`Error deleting tag ID ${t}:`,e),!1}},async initTags(t=!1){(!this.tagsLoaded||t)&&await this.fetchTags(t)}}});export{L as d,B as o,$ as p,_ as s,T as u};
