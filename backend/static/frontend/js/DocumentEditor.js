import{P as w,ao as z,aV as V,r as k,T as E,o as U,U as M,a0 as x,aW as L,V as R,u as $,a7 as F,e as T,f as N,j as K,l as G,s as B}from"./index.js";import{u as H}from"./dynamicDocument.js";var q=["onActivate","onAddUndo","onBeforeAddUndo","onBeforeExecCommand","onBeforeGetContent","onBeforeRenderUI","onBeforeSetContent","onBeforePaste","onBlur","onChange","onClearUndos","onClick","onContextMenu","onCopy","onCut","onDblclick","onDeactivate","onDirty","onDrag","onDragDrop","onDragEnd","onDragGesture","onDragOver","onDrop","onExecCommand","onFocus","onFocusIn","onFocusOut","onGetContent","onHide","onInit","onKeyDown","onKeyPress","onKeyUp","onLoadContent","onMouseDown","onMouseEnter","onMouseLeave","onMouseMove","onMouseOut","onMouseOver","onMouseUp","onNodeChange","onObjectResizeStart","onObjectResized","onObjectSelected","onPaste","onPostProcess","onPostRender","onPreProcess","onProgressState","onRedo","onRemove","onReset","onSaveContent","onSelectionChange","onSetAttrib","onSetContent","onShow","onSubmit","onUndo","onVisualAid"],W=function(e){return q.map(function(n){return n.toLowerCase()}).indexOf(e.toLowerCase())!==-1},J=function(e,n,o){Object.keys(n).filter(W).forEach(function(s){var t=n[s];typeof t=="function"&&(s==="onInit"?t(e,o):o.on(s.substring(2),function(f){return t(f,o)}))})},Q=function(e,n,o,s){var t=e.modelEvents?e.modelEvents:null,f=Array.isArray(t)?t.join(" "):t;w(s,function(v,m){o&&typeof v=="string"&&v!==m&&v!==o.getContent({format:e.outputFormat})&&o.setContent(v)}),o.on(f||"change input undo redo",function(){n.emit("update:modelValue",o.getContent({format:e.outputFormat}))})},X=function(e,n,o,s,t,f){s.setContent(f()),o.attrs["onUpdate:modelValue"]&&Q(n,o,s,t),J(e,o.attrs,s)},I=0,P=function(e){var n=Date.now(),o=Math.floor(Math.random()*1e9);return I++,e+"_"+o+I+String(n)},Y=function(e){return e!==null&&e.tagName.toLowerCase()==="textarea"},A=function(e){return typeof e>"u"||e===""?[]:Array.isArray(e)?e:e.split(" ")},Z=function(e,n){return A(e).concat(A(n))},ee=function(e){return e==null},O=function(){return{listeners:[],scriptId:P("tiny-script"),scriptLoaded:!1}},te=function(){var e=O(),n=function(t,f,v,m){var c=f.createElement("script");c.referrerPolicy="origin",c.type="application/javascript",c.id=t,c.src=v;var g=function(){c.removeEventListener("load",g),m()};c.addEventListener("load",g),f.head&&f.head.appendChild(c)},o=function(t,f,v){e.scriptLoaded?v():(e.listeners.push(v),t.getElementById(e.scriptId)||n(e.scriptId,t,f,function(){e.listeners.forEach(function(m){return m()}),e.scriptLoaded=!0}))},s=function(){e=O()};return{load:o,reinitialize:s}},ne=te(),oe=function(){return typeof window<"u"?window:global},C=function(){var e=oe();return e&&e.tinymce?e.tinymce:null},re={apiKey:String,cloudChannel:String,id:String,init:Object,initialValue:String,inline:Boolean,modelEvents:[String,Array],plugins:[String,Array],tagName:String,toolbar:[String,Array],modelValue:String,disabled:Boolean,tinymceScriptSrc:String,outputFormat:{type:String,validator:function(e){return e==="html"||e==="text"}}},h=function(){return h=Object.assign||function(e){for(var n,o=1,s=arguments.length;o<s;o++){n=arguments[o];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e},h.apply(this,arguments)},ae=function(e,n,o,s){return e(s||"div",{id:n,ref:o})},ie=function(e,n,o){return e("textarea",{id:n,visibility:"hidden",ref:o})},S={selector:void 0,target:void 0},le=z({props:re,setup:function(e,n){var o=e.init?h(h({},e.init),S):h({},S),s=V(e),t=s.disabled,f=s.modelValue,v=s.tagName,m=k(null),c=null,g=e.id||P("tiny-vue"),_=e.init&&e.init.inline||e.inline,D=!!n.attrs["onUpdate:modelValue"],b=!0,i=e.initialValue?e.initialValue:"",r="",l=function(a){return D?function(){return f!=null&&f.value?f.value:""}:function(){return a?i:r}},u=function(){var a=l(b),d=h(h({},o),{readonly:e.disabled,target:m.value,plugins:Z(o.plugins,e.plugins),toolbar:e.toolbar||o.toolbar,inline:_,setup:function(p){c=p,p.on("init",function(j){return X(j,e,n,p,f,a)}),typeof o.setup=="function"&&o.setup(p)}});Y(m.value)&&(m.value.style.visibility=""),C().init(d),b=!1};w(t,function(a){var d;c!==null&&(typeof((d=c.mode)===null||d===void 0?void 0:d.set)=="function"?c.mode.set(a?"readonly":"design"):c.setMode(a?"readonly":"design"))}),w(v,function(a){var d;D||(r=c.getContent()),(d=C())===null||d===void 0||d.remove(c),E(function(){return u()})}),U(function(){if(C()!==null)u();else if(m.value&&m.value.ownerDocument){var a=e.cloudChannel?e.cloudChannel:"6",d=e.apiKey?e.apiKey:"no-api-key",p=ee(e.tinymceScriptSrc)?"https://cdn.tiny.cloud/1/".concat(d,"/tinymce/").concat(a,"/tinymce.min.js"):e.tinymceScriptSrc;ne.load(m.value.ownerDocument,p,u)}}),M(function(){C()!==null&&C().remove(c)}),_||(x(function(){b||u()}),L(function(){var a;D||(r=c.getContent()),(a=C())===null||a===void 0||a.remove(c)}));var y=function(a){var d;r=c.getContent(),(d=C())===null||d===void 0||d.remove(c),o=h(h(h({},o),a),S),E(function(){return u()})};return n.expose({rerender:y,getEditor:function(){return c}}),function(){return _?ae(R,g,m,e.tagName):ie(R,g,m)}}});const ue={class:"flex h-screen w-full"},de={__name:"DocumentEditor",setup(e){const n=k(""),o=$(),s=F(),t=H();U(async()=>{var r;const i=s.params.id;i&&(t.selectedDocument=await t.documentById(i),n.value=((r=t.selectedDocument)==null?void 0:r.content)||"")});const f=()=>{const i=/{{(.*?)}}/g;return Array.from(new Set([...n.value.matchAll(i)].map(r=>r[1])))},v=i=>{var u;const r=((u=t.selectedDocument)==null?void 0:u.variables)||[],l=i.map(y=>{const a=r.find(d=>d.name_en===y);return{name_en:y,name_es:(a==null?void 0:a.name_es)||"",tooltip:(a==null?void 0:a.tooltip)||"",field_type:(a==null?void 0:a.field_type)||"input",value:(a==null?void 0:a.value)||""}});t.selectedDocument.variables=l},m=async()=>{var i,r;try{const l=f();t.selectedDocument?(t.selectedDocument.content=n.value,t.selectedDocument.state="Draft",l.length>0&&v(l)):(t.selectedDocument={title:((i=t.selectedDocument)==null?void 0:i.title)||s.params.title||"Untitled Document",content:n.value,state:"Draft",variables:[]},l.length>0&&v(l));let u,y;(r=t.selectedDocument)!=null&&r.id?(u=t.selectedDocument.id,y=await t.updateDocument(u,t.selectedDocument)):(y=await t.createDocument(t.selectedDocument),y&&y.id&&(u=y.id));const a=t.selectedDocument;if(t.selectedDocument=null,await t.init(),!u&&a&&a.title){const d=t.documents.find(p=>p.title===a.title&&p.content===a.content&&p.state==="Draft");d&&(u=d.id)}u&&(localStorage.setItem("lastUpdatedDocumentId",u.toString()),t.lastUpdatedDocumentId=u),await B("Â¡Borrador guardado exitosamente!","success"),setTimeout(()=>{window.location.href="/dynamic_document_dashboard"},500)}catch(l){console.error("Error saving draft:",l),await B("Error al guardar el borrador.","error")}},c=async()=>{const i=f();i.length>0?(t.selectedDocument?t.selectedDocument.content=n.value:t.selectedDocument={title:s.params.title||"Untitled Document",content:n.value,variables:[]},v(i),o.push("/dynamic_document_dashboard/lawyer/variables-config")):await m()};let g=!1;function _(i){if(!i||typeof i!="string")return i;try{return i.replace(/(font-family\s*:\s*)([^;!]*)([;!])/gi,"font-family: 'Carlito', sans-serif$3").replace(/<([a-z][a-z0-9]*)\b([^>]*)(?!\bstyle=)([^>]*)>/gi,function(r,l,u,y){return/style=/i.test(u)?r:`<${l}${u} style="font-family: 'Carlito', sans-serif;"${y}>`})}catch(r){return console.error("[ERROR] Failed to apply Carlito font:",r),i}}const D={language:"es",plugins:"lists link image table code wordcount autolink searchreplace textpattern",menubar:"",toolbar:"save continue return | undo redo | formatselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | outdent indent | blocks fontsize lineheight | forecolor | removeformat | hr",height:"100vh",width:"100%",content_style:`
    @import url('https://fonts.googleapis.com/css2?family=Carlito&display=swap');
    body, p, span, div, strong, em, u, i, b {
      font-family: 'Carlito', sans-serif !important;
    }
  `,font_formats:"Carlito=Carlito, sans-serif;",paste_webkit_styles:"all",paste_remove_styles_if_webkit:!1,paste_merge_formats:!0,paste_as_text:!1,keep_styles:!0,forced_root_block:"p",forced_root_block_attrs:{style:"font-family: 'Carlito', sans-serif;"},setup:i=>{i.ui.registry.addButton("save",{text:"Guardar como borrador",icon:"save",onAction:()=>{m()}}),i.ui.registry.addButton("continue",{text:"Continuar",icon:"chevron-right",onAction:()=>{c()}}),i.ui.registry.addButton("return",{text:"Regresar",icon:"chevron-left",onAction:()=>{b()}}),i.on("init",()=>{try{setTimeout(()=>{try{const r=i.getContent(),l=_(r);r!==l&&(g=!0,i.setContent(l),g=!1)}catch(r){console.error("[ERROR] Failed to initialize content:",r)}},100)}catch(r){console.error("[ERROR] Initialization failed:",r)}}),i.on("BeforeSetContent",r=>{r.content&&(r.content=r.content.replace(/<([a-z][a-z0-9]*)\b([^>]*)(style=["'])([^"']*)["']([^>]*)>/gi,function(l,u,y,a,d,p){return d.includes("font-family")?l.replace(/(font-family\s*:\s*)([^;"]*)([;"])/gi,"font-family: 'Carlito', sans-serif$3"):`<${u}${y}${a}font-family: 'Carlito', sans-serif; ${d}"${p}>`}))}),i.on("SetContent",r=>{if(!g)try{(r.source_view||r.paste||r.setup)&&(g=!0,setTimeout(()=>{try{const l=i.getContent(),u=_(l);l!==u&&i.setContent(u,{format:"raw",no_events:!0})}catch(l){console.error("[ERROR] Failed to process SetContent:",l)}finally{g=!1}},50))}catch(l){console.error("[ERROR] SetContent event error:",l),g=!1}}),i.on("input",()=>{})}},b=()=>{o.push("/dynamic_document_dashboard")};return(i,r)=>(T(),N("main",ue,[K(G(le),{"api-key":"tmizyezb3c6j68qwkp8d5hrr3vgk5va6uouidoe2hj7nxp3p",modelValue:n.value,"onUpdate:modelValue":r[0]||(r[0]=l=>n.value=l),init:D},null,8,["modelValue"])]))}};export{de as default};
