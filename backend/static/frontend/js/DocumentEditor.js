import{T as z,B as J,b9 as Q,r as B,W as F,o as X,X as Z,a2 as ee,ba as te,Y as K,u as ne,aa as oe,P as ae,c as G,e as re,f as ie,j as se,l as le,s as S}from"./index.js";import{u as ce}from"./index2.js";var ue=["onActivate","onAddUndo","onBeforeAddUndo","onBeforeExecCommand","onBeforeGetContent","onBeforeRenderUI","onBeforeSetContent","onBeforePaste","onBlur","onChange","onClearUndos","onClick","onContextMenu","onCopy","onCut","onDblclick","onDeactivate","onDirty","onDrag","onDragDrop","onDragEnd","onDragGesture","onDragOver","onDrop","onExecCommand","onFocus","onFocusIn","onFocusOut","onGetContent","onHide","onInit","onKeyDown","onKeyPress","onKeyUp","onLoadContent","onMouseDown","onMouseEnter","onMouseLeave","onMouseMove","onMouseOut","onMouseOver","onMouseUp","onNodeChange","onObjectResizeStart","onObjectResized","onObjectSelected","onPaste","onPostProcess","onPostRender","onPreProcess","onProgressState","onRedo","onRemove","onReset","onSaveContent","onSelectionChange","onSetAttrib","onSetContent","onShow","onSubmit","onUndo","onVisualAid"],de=function(n){return ue.map(function(i){return i.toLowerCase()}).indexOf(n.toLowerCase())!==-1},fe=function(n,i,c){Object.keys(i).filter(de).forEach(function(u){var a=i[u];typeof a=="function"&&(u==="onInit"?a(n,c):c.on(u.substring(2),function(m){return a(m,c)}))})},me=function(n,i,c,u){var a=n.modelEvents?n.modelEvents:null,m=Array.isArray(a)?a.join(" "):a;z(u,function(v,f){c&&typeof v=="string"&&v!==f&&v!==c.getContent({format:n.outputFormat})&&c.setContent(v)}),c.on(m||"change input undo redo",function(){i.emit("update:modelValue",c.getContent({format:n.outputFormat}))})},ve=function(n,i,c,u,a,m){u.setContent(m()),c.attrs["onUpdate:modelValue"]&&me(i,c,u,a),fe(n,c.attrs,u)},H=0,Y=function(n){var i=Date.now(),c=Math.floor(Math.random()*1e9);return H++,n+"_"+c+H+String(i)},pe=function(n){return n!==null&&n.tagName.toLowerCase()==="textarea"},W=function(n){return typeof n>"u"||n===""?[]:Array.isArray(n)?n:n.split(" ")},ge=function(n,i){return W(n).concat(W(i))},ye=function(n){return n==null},q=function(){return{listeners:[],scriptId:Y("tiny-script"),scriptLoaded:!1}},be=function(){var n=q(),i=function(a,m,v,f){var d=m.createElement("script");d.referrerPolicy="origin",d.type="application/javascript",d.id=a,d.src=v;var C=function(){d.removeEventListener("load",C),f()};d.addEventListener("load",C),m.head&&m.head.appendChild(d)},c=function(a,m,v){n.scriptLoaded?v():(n.listeners.push(v),a.getElementById(n.scriptId)||i(n.scriptId,a,m,function(){n.listeners.forEach(function(f){return f()}),n.scriptLoaded=!0}))},u=function(){n=q()};return{load:c,reinitialize:u}},he=be(),Ce=function(){return typeof window<"u"?window:global},E=function(){var n=Ce();return n&&n.tinymce?n.tinymce:null},_e={apiKey:String,cloudChannel:String,id:String,init:Object,initialValue:String,inline:Boolean,modelEvents:[String,Array],plugins:[String,Array],tagName:String,toolbar:[String,Array],modelValue:String,disabled:Boolean,tinymceScriptSrc:String,outputFormat:{type:String,validator:function(n){return n==="html"||n==="text"}}},h=function(){return h=Object.assign||function(n){for(var i,c=1,u=arguments.length;c<u;c++){i=arguments[c];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(n[a]=i[a])}return n},h.apply(this,arguments)},De=function(n,i,c,u){return n(u||"div",{id:i,ref:c})},we=function(n,i,c){return n("textarea",{id:i,visibility:"hidden",ref:c})},I={selector:void 0,target:void 0},Se=J({props:_e,setup:function(n,i){var c=n.init?h(h({},n.init),I):h({},I),u=Q(n),a=u.disabled,m=u.modelValue,v=u.tagName,f=B(null),d=null,C=n.id||Y("tiny-vue"),k=n.init&&n.init.inline||n.inline,_=!!i.attrs["onUpdate:modelValue"],R=!0,N=n.initialValue?n.initialValue:"",D="",P=function(y){return _?function(){return m!=null&&m.value?m.value:""}:function(){return y?N:D}},g=function(){var y=P(R),b=h(h({},c),{readonly:n.disabled,target:f.value,plugins:ge(c.plugins,n.plugins),toolbar:n.toolbar||c.toolbar,inline:k,setup:function(e){d=e,e.on("init",function(r){return ve(r,n,i,e,m,y)}),typeof c.setup=="function"&&c.setup(e)}});pe(f.value)&&(f.value.style.visibility=""),E().init(b),R=!1};z(a,function(y){var b;d!==null&&(typeof((b=d.mode)===null||b===void 0?void 0:b.set)=="function"?d.mode.set(y?"readonly":"design"):d.setMode(y?"readonly":"design"))}),z(v,function(y){var b;_||(D=d.getContent()),(b=E())===null||b===void 0||b.remove(d),F(function(){return g()})}),X(function(){if(E()!==null)g();else if(f.value&&f.value.ownerDocument){var y=n.cloudChannel?n.cloudChannel:"6",b=n.apiKey?n.apiKey:"no-api-key",e=ye(n.tinymceScriptSrc)?"https://cdn.tiny.cloud/1/".concat(b,"/tinymce/").concat(y,"/tinymce.min.js"):n.tinymceScriptSrc;he.load(f.value.ownerDocument,e,g)}}),Z(function(){E()!==null&&E().remove(d)}),k||(ee(function(){R||g()}),te(function(){var y;_||(D=d.getContent()),(y=E())===null||y===void 0||y.remove(d)}));var x=function(y){var b;D=d.getContent(),(b=E())===null||b===void 0||b.remove(d),c=h(h(h({},c),y),I),F(function(){return g()})};return i.expose({rerender:x,getEditor:function(){return d}}),function(){return k?De(K,C,f,n.tagName):we(K,C,f)}}});const Ee={class:"flex h-screen w-full"},Ae={__name:"DocumentEditor",setup(n){const i=B(""),c=ne(),u=oe(),a=ce(),m=ae(),v=G(()=>{var e;return u.path.includes("/client/editor/")||((e=m.currentUser)==null?void 0:e.role)!=="lawyer"}),f=B("");B(""),X(async()=>{var r;const e=u.params.id;if(e)try{const o=await a.fetchDocumentById(e,!0);a.selectedDocument=o,f.value=(o==null?void 0:o.content)||"",v.value?i.value=C(f.value):i.value=f.value}catch(o){console.error("Error fetching document:",o),a.selectedDocument=await a.documentById(e),f.value=((r=a.selectedDocument)==null?void 0:r.content)||"",v.value?i.value=C(f.value):i.value=f.value}});const d=(e=null)=>{const r=e||i.value,o=/{{(.*?)}}/g;return Array.from(new Set([...r.matchAll(o)].map(t=>t[1])))},C=e=>{var o;if(!e||!((o=a.selectedDocument)!=null&&o.variables))return e;let r=e;return a.selectedDocument.variables.forEach(t=>{const l=new RegExp(`{{${t.name_en}}}`,"g"),s=t.value||`[${t.name_es||t.name_en}]`,p=`<span 
      class="variable-protected mceNonEditable" 
      data-variable="${t.name_en}" 
      data-mce-contenteditable="false"
      contenteditable="false" 
      unselectable="on"
      style="background-color: #ffeb3b !important; color: #d32f2f !important; padding: 2px 4px !important; border-radius: 3px !important; font-weight: bold !important; cursor: not-allowed !important; user-select: none !important; -webkit-user-select: none !important; -moz-user-select: none !important; -ms-user-select: none !important; display: inline-block !important;"
      title="Variable protegida: ${t.name_es||t.name_en} - No se puede editar"
      onmousedown="return false;"
      onselectstart="return false;"
      ondragstart="return false;"
    >${s}</span>`;r=r.replace(l,p)}),r},k=e=>e&&e.replace(/<span[^>]*(?:class="[^"]*variable-protected[^"]*"|data-variable="([^"]*)")(?:[^>]*data-variable="([^"]*)")?[^>]*>[\s\S]*?<\/span>/g,(r,o,t)=>{const l=o||t;return l?`{{${l}}}`:r}),_=e=>{var t;const r=((t=a.selectedDocument)==null?void 0:t.variables)||[],o=e.map(l=>{const s=r.find(p=>p.name_en===l);return{name_en:l,name_es:(s==null?void 0:s.name_es)||"",tooltip:(s==null?void 0:s.tooltip)||"",field_type:(s==null?void 0:s.field_type)||"input",value:(s==null?void 0:s.value)||"",select_options:(s==null?void 0:s.field_type)==="select"?(s==null?void 0:s.select_options)||[]:null}});a.selectedDocument.variables=o},R=async()=>{try{const e=k(i.value);if(a.selectedDocument){const r={...a.selectedDocument,content:e};await a.updateDocument(a.selectedDocument.id,r)&&(await S("Documento guardado exitosamente.","success"),setTimeout(()=>{window.location.href="/dynamic_document_dashboard"},500))}else await S("Error: No se encontró el documento para guardar.","error")}catch(e){console.error("Error saving document content:",e),await S("Error al guardar el documento.","error")}},N=async()=>{var e,r;try{const o=i.value;if(D(o)){await S("No puedes guardar un documento vacío. Por favor, agrega contenido al documento antes de guardarlo.","warning");return}const t=d();a.selectedDocument?(a.selectedDocument.content=o,a.selectedDocument.state="Draft",t.length>0&&_(t)):(a.selectedDocument={title:((e=a.selectedDocument)==null?void 0:e.title)||u.params.title||"Untitled Document",content:o,state:"Draft",variables:[]},t.length>0&&_(t));let l,s;(r=a.selectedDocument)!=null&&r.id?(l=a.selectedDocument.id,s=await a.updateDocument(l,a.selectedDocument)):(s=await a.createDocument(a.selectedDocument),s&&s.id&&(l=s.id));const p=a.selectedDocument;if(a.selectedDocument=null,await a.init(),!l&&p&&p.title){const w=a.documents.find(A=>A.title===p.title&&A.content===p.content&&A.state==="Draft");w&&(l=w.id)}l&&(localStorage.setItem("lastUpdatedDocumentId",l.toString()),a.lastUpdatedDocumentId=l),await S("¡Borrador guardado exitosamente!","success"),setTimeout(()=>{window.location.href="/dynamic_document_dashboard"},500)}catch(o){console.error("Error saving draft:",o),await S("Error al guardar el borrador.","error")}},D=e=>{if(!e||e.trim()==="")return!0;const r=e.replace(/<[^>]*>/g,"").trim();return r===""||r==="&nbsp;"},P=async()=>{if(D(i.value)){await S("No puedes continuar con un documento vacío. Por favor, agrega contenido al documento antes de continuar.","warning");return}const e=d();e.length>0?(a.selectedDocument?a.selectedDocument.content=i.value:a.selectedDocument={title:u.params.title||"Untitled Document",content:i.value,variables:[]},_(e),c.push("/dynamic_document_dashboard/lawyer/variables-config")):await N()};let g=!1;function x(e){if(!e||typeof e!="string")return e;try{return e.replace(/(font-family\s*:\s*)([^;!]*)([;!])/gi,"font-family: 'Carlito', sans-serif$3").replace(/<([a-z][a-z0-9]*)\b([^>]*)(?!\bstyle=)([^>]*)>/gi,function(r,o,t,l){return/style=/i.test(t)?r:`<${o}${t} style="font-family: 'Carlito', sans-serif;"${l}>`})}catch(r){return console.error("[ERROR] Failed to apply Carlito font:",r),e}}const y=G(()=>({language:"es",plugins:v.value?"lists link image table code wordcount autolink searchreplace textpattern noneditable":"lists link image table code wordcount autolink searchreplace textpattern",menubar:"",toolbar:v.value?"save return | undo redo | formatselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | outdent indent | blocks fontsize lineheight | forecolor | removeformat | hr":"save continue return | undo redo | formatselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | outdent indent | blocks fontsize lineheight | forecolor | removeformat | hr",height:"100vh",width:"100%",content_style:`
    @import url('https://fonts.googleapis.com/css2?family=Carlito&display=swap');
    body, p, span, div, strong, em, u, i, b {
      font-family: 'Carlito', sans-serif !important;
    }
    .variable-protected {
      background-color: #ffeb3b !important;
      color: #d32f2f !important;
      padding: 2px 4px !important;
      border-radius: 3px !important;
      font-weight: bold !important;
      cursor: not-allowed !important;
      user-select: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
    }
  `,font_formats:"Carlito=Carlito, sans-serif;",paste_webkit_styles:"all",paste_remove_styles_if_webkit:!1,paste_merge_formats:!0,paste_as_text:!1,keep_styles:!0,forced_root_block:"p",forced_root_block_attrs:{style:"font-family: 'Carlito', sans-serif;"},...v.value&&{noneditable_noneditable_class:"variable-protected",noneditable_editable_class:"mce-editable",content_css_cors:!0},setup:e=>{if(e.ui.registry.addButton("save",{text:v.value?"Guardar":"Guardar como borrador",icon:"save",onAction:()=>{v.value?R():N()}}),e.ui.registry.addButton("continue",{text:"Continuar",icon:"chevron-right",onAction:()=>{P()}}),e.ui.registry.addButton("return",{text:"Regresar",icon:"chevron-left",onAction:()=>{b()}}),e.on("init",()=>{try{setTimeout(()=>{try{const r=e.getContent(),o=x(r);r!==o&&(g=!0,e.setContent(o),g=!1)}catch(r){console.error("[ERROR] Failed to initialize content:",r)}},100)}catch(r){console.error("[ERROR] Initialization failed:",r)}}),e.on("BeforeSetContent",r=>{r.content&&(r.content=r.content.replace(/<([a-z][a-z0-9]*)\b([^>]*)(style=["'])([^"']*)["']([^>]*)>/gi,function(o,t,l,s,p,w){return p.includes("font-family")?o.replace(/(font-family\s*:\s*)([^;"]*)([;"])/gi,"font-family: 'Carlito', sans-serif$3"):`<${t}${l}${s}font-family: 'Carlito', sans-serif; ${p}"${w}>`}))}),e.on("SetContent",r=>{if(!g)try{(r.source_view||r.paste||r.setup)&&(g=!0,setTimeout(()=>{try{const o=e.getContent(),t=x(o);o!==t&&e.setContent(t,{format:"raw",no_events:!0})}catch(o){console.error("[ERROR] Failed to process SetContent:",o)}finally{g=!1}},50))}catch(o){console.error("[ERROR] SetContent event error:",o),g=!1}}),e.on("input",()=>{}),v.value){const r=()=>{e.dom.select(".variable-protected").forEach(t=>{t.setAttribute("contenteditable","false"),t.setAttribute("data-mce-contenteditable","false"),t.setAttribute("unselectable","on"),t.className=t.className.replace("mceNonEditable","")+" mceNonEditable",t.style.userSelect="none",t.style.webkitUserSelect="none",t.style.mozUserSelect="none",t.style.msUserSelect="none",t.style.pointerEvents="none",t.style.cursor="not-allowed",t.onmousedown=()=>!1,t.onselectstart=()=>!1,t.ondragstart=()=>!1,t.oncontextmenu=()=>!1,t.style.backgroundColor="#ffeb3b",t.style.color="#d32f2f",t.style.fontWeight="bold",t.style.padding="2px 4px",t.style.borderRadius="3px",t.style.display="inline-block",t.style.border="1px solid #fbc02d",t.title="Variable protegida - No se puede editar"})};e.on("keydown",o=>{var L,O,T,V,j;const t=e.selection,l=t.getNode(),s=t.getRng(),p=((L=l.classList)==null?void 0:L.contains("variable-protected"))||l.closest(".variable-protected")||((V=(T=(O=s.commonAncestorContainer)==null?void 0:O.parentElement)==null?void 0:T.classList)==null?void 0:V.contains("variable-protected")),w=t.getContent(),A=w.includes("variable-protected")||w.includes("data-variable=");if((o.key==="Backspace"||o.key==="Delete"||o.key==="x"&&(o.ctrlKey||o.metaKey))&&(p||A)){if(o.preventDefault(),o.stopPropagation(),p){const U=(j=l.classList)!=null&&j.contains("variable-protected")?l:l.closest(".variable-protected");if(U){const $=U.nextSibling;if($)t.select($),t.collapse(!0);else{const M=e.dom.create("span",{}," ");e.dom.insertAfter(M,U),t.select(M),t.collapse(!0)}}}return!1}if(p&&!["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(o.key))return o.preventDefault(),!1}),e.on("paste",o=>{var p;const t=e.selection,l=t.getNode(),s=t.getContent();if((p=l.classList)!=null&&p.contains("variable-protected")||l.closest(".variable-protected")||s.includes("variable-protected"))return o.preventDefault(),!1}),e.on("BeforeSetContent",o=>{!g&&o.content&&e.getContent()}),e.on("SetContent",o=>{g||setTimeout(()=>{r()},10)}),e.on("input",()=>{if(g)return;const o=e.getContent(),t=(f.value.match(/{{.*?}}/g)||[]).length;if((o.match(/variable-protected/g)||[]).length<t){g=!0;const s=C(f.value);e.setContent(s),setTimeout(()=>{r(),g=!1},10);return}r()}),e.on("dragstart",o=>{var l;const t=o.target;if((l=t.classList)!=null&&l.contains("variable-protected")||t.closest(".variable-protected"))return o.preventDefault(),!1}),e.on("selectionchange",()=>{const o=e.selection.getContent();if(o.includes("variable-protected")||o.includes("mceNonEditable")){const t=e.selection;t.getRng();const l=e.getBody(),s=e.dom.select("p,div",l);if(s.length>0){const p=s[0];t.select(p),t.collapse(!0)}}}),e.on("beforeinput",o=>{var s;const t=e.selection,l=t.getNode();if((s=l.classList)!=null&&s.contains("variable-protected")||l.closest(".variable-protected")||t.getContent().includes("variable-protected"))return o.preventDefault(),!1}),e.on("init",()=>{setTimeout(()=>{r()},100)}),e.on("LoadContent",()=>{setTimeout(()=>{r()},50)})}}})),b=()=>{c.push("/dynamic_document_dashboard")};return(e,r)=>(re(),ie("main",Ee,[se(le(Se),{"api-key":"tmizyezb3c6j68qwkp8d5hrr3vgk5va6uouidoe2hj7nxp3p",modelValue:i.value,"onUpdate:modelValue":r[0]||(r[0]=o=>i.value=o),init:y.value},null,8,["modelValue","init"])]))}};export{Ae as default};
