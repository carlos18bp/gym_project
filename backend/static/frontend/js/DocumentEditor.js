import{W as F,K as Y,bb as ee,r as O,Z as H,o as Q,$ as te,a6 as ne,bc as oe,a0 as q,u as re,H as ae,I as ie,c as L,e as se,f as le,h as ce,j as ue,s as w}from"./index.js";import{u as de}from"./index2.js";var fe=["onActivate","onAddUndo","onBeforeAddUndo","onBeforeExecCommand","onBeforeGetContent","onBeforeRenderUI","onBeforeSetContent","onBeforePaste","onBlur","onChange","onClearUndos","onClick","onContextMenu","onCopy","onCut","onDblclick","onDeactivate","onDirty","onDrag","onDragDrop","onDragEnd","onDragGesture","onDragOver","onDrop","onExecCommand","onFocus","onFocusIn","onFocusOut","onGetContent","onHide","onInit","onKeyDown","onKeyPress","onKeyUp","onLoadContent","onMouseDown","onMouseEnter","onMouseLeave","onMouseMove","onMouseOut","onMouseOver","onMouseUp","onNodeChange","onObjectResizeStart","onObjectResized","onObjectSelected","onPaste","onPostProcess","onPostRender","onPreProcess","onProgressState","onRedo","onRemove","onReset","onSaveContent","onSelectionChange","onSetAttrib","onSetContent","onShow","onSubmit","onUndo","onVisualAid"],me=function(o){return fe.map(function(l){return l.toLowerCase()}).indexOf(o.toLowerCase())!==-1},pe=function(o,l,c){Object.keys(l).filter(me).forEach(function(d){var r=l[d];typeof r=="function"&&(d==="onInit"?r(o,c):c.on(d.substring(2),function(f){return r(f,c)}))})},ve=function(o,l,c,d){var r=o.modelEvents?o.modelEvents:null,f=Array.isArray(r)?r.join(" "):r;F(d,function(h,p){c&&typeof h=="string"&&h!==p&&h!==c.getContent({format:o.outputFormat})&&c.setContent(h)}),c.on(f||"change input undo redo",function(){l.emit("update:modelValue",c.getContent({format:o.outputFormat}))})},ge=function(o,l,c,d,r,f){d.setContent(f()),c.attrs["onUpdate:modelValue"]&&ve(l,c,d,r),pe(o,c.attrs,d)},W=0,X=function(o){var l=Date.now(),c=Math.floor(Math.random()*1e9);return W++,o+"_"+c+W+String(l)},ye=function(o){return o!==null&&o.tagName.toLowerCase()==="textarea"},Z=function(o){return typeof o>"u"||o===""?[]:Array.isArray(o)?o:o.split(" ")},be=function(o,l){return Z(o).concat(Z(l))},he=function(o){return o==null},J=function(){return{listeners:[],scriptId:X("tiny-script"),scriptLoaded:!1}},_e=function(){var o=J(),l=function(r,f,h,p){var m=f.createElement("script");m.referrerPolicy="origin",m.type="application/javascript",m.id=r,m.src=h;var b=function(){m.removeEventListener("load",b),p()};m.addEventListener("load",b),f.head&&f.head.appendChild(m)},c=function(r,f,h){o.scriptLoaded?h():(o.listeners.push(h),r.getElementById(o.scriptId)||l(o.scriptId,r,f,function(){o.listeners.forEach(function(p){return p()}),o.scriptLoaded=!0}))},d=function(){o=J()};return{load:c,reinitialize:d}},Ce=_e(),we=function(){return typeof window<"u"?window:global},R=function(){var o=we();return o&&o.tinymce?o.tinymce:null},De={apiKey:String,cloudChannel:String,id:String,init:Object,initialValue:String,inline:Boolean,modelEvents:[String,Array],plugins:[String,Array],tagName:String,toolbar:[String,Array],modelValue:String,disabled:Boolean,tinymceScriptSrc:String,outputFormat:{type:String,validator:function(o){return o==="html"||o==="text"}}},D=function(){return D=Object.assign||function(o){for(var l,c=1,d=arguments.length;c<d;c++){l=arguments[c];for(var r in l)Object.prototype.hasOwnProperty.call(l,r)&&(o[r]=l[r])}return o},D.apply(this,arguments)},Se=function(o,l,c,d){return o(d||"div",{id:l,ref:c})},Ee=function(o,l,c){return o("textarea",{id:l,visibility:"hidden",ref:c})},V={selector:void 0,target:void 0},Ne=Y({props:De,setup:function(o,l){var c=o.init?D(D({},o.init),V):D({},V),d=ee(o),r=d.disabled,f=d.modelValue,h=d.tagName,p=O(null),m=null,b=o.id||X("tiny-vue"),B=o.init&&o.init.inline||o.inline,k=!!l.attrs["onUpdate:modelValue"],x=!0,T=o.initialValue?o.initialValue:"",P="",j=function(u){return k?function(){return f!=null&&f.value?f.value:""}:function(){return u?T:P}},N=function(){var u=j(x),y=D(D({},c),{readonly:o.disabled,target:p.value,plugins:be(c.plugins,o.plugins),toolbar:o.toolbar||c.toolbar,inline:B,setup:function(A){m=A,A.on("init",function(M){return ge(M,o,l,A,f,u)}),typeof c.setup=="function"&&c.setup(A)}});ye(p.value)&&(p.value.style.visibility=""),R().init(y),x=!1};F(r,function(u){var y;m!==null&&(typeof((y=m.mode)===null||y===void 0?void 0:y.set)=="function"?m.mode.set(u?"readonly":"design"):m.setMode(u?"readonly":"design"))}),F(h,function(u){var y;k||(P=m.getContent()),(y=R())===null||y===void 0||y.remove(m),H(function(){return N()})}),Q(function(){if(R()!==null)N();else if(p.value&&p.value.ownerDocument){var u=o.cloudChannel?o.cloudChannel:"6",y=o.apiKey?o.apiKey:"no-api-key",A=he(o.tinymceScriptSrc)?"https://cdn.tiny.cloud/1/".concat(y,"/tinymce/").concat(u,"/tinymce.min.js"):o.tinymceScriptSrc;Ce.load(p.value.ownerDocument,A,N)}}),te(function(){R()!==null&&R().remove(m)}),B||(ne(function(){x||N()}),oe(function(){var u;k||(P=m.getContent()),(u=R())===null||u===void 0||u.remove(m)}));var $=function(u){var y;P=m.getContent(),(y=R())===null||y===void 0||y.remove(m),c=D(D(D({},c),u),V),H(function(){return N()})};return l.expose({rerender:$,getEditor:function(){return m}}),function(){return B?Se(q,b,p,o.tagName):Ee(q,b,p)}}});const Ae={class:"flex h-screen w-full"},Be={__name:"DocumentEditor",setup(o){const l=O(""),c=re(),d=ae(),r=de(),f=ie(),h=L(()=>d.path.includes("/dynamic_document_dashboard/client/editor/edit/")),p=L(()=>{var e;const n=(e=f.currentUser)==null?void 0:e.role,a=n==="basic";return h.value&&!a?!0:n==="client"||n==="corporate_client"}),m=L(()=>d.path.includes("/creator/")),b=O("");O(""),Q(async()=>{var a;const n=d.params.id;if(n)try{const e=await r.fetchDocumentById(n,!0);r.selectedDocument=e,b.value=(e==null?void 0:e.content)||"",p.value?l.value=k(b.value):l.value=b.value}catch(e){console.error("Error fetching document:",e),r.selectedDocument=await r.documentById(n),b.value=((a=r.selectedDocument)==null?void 0:a.content)||"",p.value?l.value=k(b.value):l.value=b.value}});const B=(n=null)=>{const a=n||l.value,e=/{{(.*?)}}/g;return Array.from(new Set([...a.matchAll(e)].map(t=>t[1])))},k=n=>{var e;if(!n||!((e=r.selectedDocument)!=null&&e.variables))return n;let a=n;return r.selectedDocument.variables.forEach(t=>{const s=new RegExp(`{{${t.name_en}}}`,"g"),i=t.value||`[${t.name_es||t.name_en}]`,v=`<span 
      class="variable-protected mceNonEditable" 
      data-variable="${t.name_en}" 
      data-mce-contenteditable="false"
      contenteditable="false" 
      unselectable="on"
      style="background-color: #ffeb3b !important; color: #d32f2f !important; padding: 2px 4px !important; border-radius: 3px !important; font-weight: bold !important; cursor: not-allowed !important; user-select: none !important; -webkit-user-select: none !important; -moz-user-select: none !important; -ms-user-select: none !important; display: inline-block !important;"
      title="Variable protegida: ${t.name_es||t.name_en} - No se puede editar"
      onmousedown="return false;"
      onselectstart="return false;"
      ondragstart="return false;"
    >${i}</span>`;a=a.replace(s,v)}),a},x=n=>n&&n.replace(/<span[^>]*(?:class="[^"]*variable-protected[^"]*"|data-variable="([^"]*)")(?:[^>]*data-variable="([^"]*)")?[^>]*>[\s\S]*?<\/span>/g,(a,e,t)=>{const s=e||t;return s?`{{${s}}}`:a}),T=n=>{var t;const a=((t=r.selectedDocument)==null?void 0:t.variables)||[],e=n.map(s=>{const i=a.find(v=>v.name_en===s);return{name_en:s,name_es:(i==null?void 0:i.name_es)||"",tooltip:(i==null?void 0:i.tooltip)||"",field_type:(i==null?void 0:i.field_type)||"input",value:(i==null?void 0:i.value)||"",select_options:(i==null?void 0:i.field_type)==="select"?(i==null?void 0:i.select_options)||[]:null,summary_field:(i==null?void 0:i.summary_field)||"none",currency:(i==null?void 0:i.currency)||null}});r.selectedDocument.variables=e},P=async()=>{var n;try{const a=x(l.value);if(r.selectedDocument){const e=r.selectedDocument,t=f.getCurrentUser,s=e.assigned_to?String(e.assigned_to):null,i=t!=null&&t.id?String(t.id):null,v=s&&i&&s===i,S=e.state==="Published"&&!e.assigned_to;if(m.value||S||!v){const C=f.getCurrentUser;let _=C==null?void 0:C.id;if(_||(_=(n=f.getCurrentUser)==null?void 0:n.id),!_&&C&&(_=C.id),!_){await w("Error: No se pudo identificar al usuario. Por favor, recarga la página.","error");return}const E={title:String(e.title||"Untitled"),content:String(a||""),state:"Progress",assigned_to:Number(_),variables:Array.isArray(e.variables)?e.variables.map(g=>({name_en:g.name_en||"",name_es:g.name_es||"",tooltip:g.tooltip||"",field_type:g.field_type||"input",value:g.value||"",select_options:g.select_options||null,summary_field:g.summary_field||"none",currency:g.summary_field==="value"&&g.currency||null})):[],tag_ids:Array.isArray(e.tags)?e.tags.map(g=>{const z=typeof g=="object"?g.id:g;return Number(z)}).filter(g=>!isNaN(g)):[],requires_signature:!!e.requires_signature,is_public:!1};E.state!=="Progress"&&(E.state="Progress"),(!E.assigned_to||E.assigned_to!==_)&&(E.assigned_to=Number(_));const U=await r.createDocument(E);U&&U.id?(await w("Documento creado exitosamente desde la plantilla.","success"),await r.init(!0),await new Promise(g=>setTimeout(g,300)),window.location.href="/dynamic_document_dashboard"):(console.error("Failed to create document - no ID returned:",U),await w("Error: No se pudo crear el documento.","error"))}else{const C={...e,content:a};await r.updateDocument(e.id,C)&&(await w("Documento guardado exitosamente.","success"),setTimeout(()=>{window.location.href="/dynamic_document_dashboard"},500))}}else await w("Error: No se encontró el documento para guardar.","error")}catch(a){console.error("Error saving document content:",a),await w("Error al guardar el documento.","error")}},j=async()=>{var n,a;try{const e=l.value;if(N(e)){await w("No puedes guardar un documento vacío. Por favor, agrega contenido al documento antes de guardarlo.","warning");return}const t=B();r.selectedDocument?(r.selectedDocument.content=e,r.selectedDocument.state="Draft",t.length>0&&T(t)):(r.selectedDocument={title:((n=r.selectedDocument)==null?void 0:n.title)||d.params.title||"Untitled Document",content:e,state:"Draft",variables:[]},t.length>0&&T(t));let s,i;(a=r.selectedDocument)!=null&&a.id?(s=r.selectedDocument.id,i=await r.updateDocument(s,r.selectedDocument)):(i=await r.createDocument(r.selectedDocument),i&&i.id&&(s=i.id));const v=r.selectedDocument;if(r.selectedDocument=null,await r.init(),!s&&v&&v.title){const S=r.documents.find(I=>I.title===v.title&&I.content===v.content&&I.state==="Draft");S&&(s=S.id)}s&&(localStorage.setItem("lastUpdatedDocumentId",s.toString()),r.lastUpdatedDocumentId=s),await w("¡Borrador guardado exitosamente!","success"),setTimeout(()=>{window.location.href="/dynamic_document_dashboard"},500)}catch(e){console.error("Error saving draft:",e),await w("Error al guardar el borrador.","error")}},N=n=>{if(!n||n.trim()==="")return!0;const a=n.replace(/<[^>]*>/g,"").trim();return a===""||a==="&nbsp;"},$=async()=>{if(N(l.value)){await w("No puedes continuar con un documento vacío. Por favor, agrega contenido al documento antes de continuar.","warning");return}const n=B();r.selectedDocument?r.selectedDocument.content=l.value:r.selectedDocument={title:d.params.title||"Untitled Document",content:l.value,variables:[]},T(n),c.push("/dynamic_document_dashboard/lawyer/variables-config")};let u=!1;function y(n){if(!n||typeof n!="string")return n;try{return n.replace(/(font-family\s*:\s*)([^;!]*)([;!])/gi,"font-family: 'Carlito', sans-serif$3").replace(/<([a-z][a-z0-9]*)\b([^>]*)(?!\bstyle=)([^>]*)>/gi,function(a,e,t,s){return/style=/i.test(t)?a:`<${e}${t} style="font-family: 'Carlito', sans-serif;"${s}>`})}catch(a){return console.error("[ERROR] Failed to apply Carlito font:",a),n}}const A=L(()=>({language:"es",plugins:"lists link image table code wordcount autolink searchreplace",menubar:"",toolbar:p.value?"save return | undo redo | formatselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | outdent indent | blocks fontsize lineheight | forecolor | removeformat | hr":"save continue return | undo redo | formatselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | outdent indent | blocks fontsize lineheight | forecolor | removeformat | hr",height:"100vh",width:"100%",content_style:`
    @import url('https://fonts.googleapis.com/css2?family=Carlito&display=swap');
    body, p, span, div, strong, em, u, i, b {
      font-family: 'Carlito', sans-serif !important;
    }
    .variable-protected {
      background-color: #ffeb3b !important;
      color: #d32f2f !important;
      padding: 2px 4px !important;
      border-radius: 3px !important;
      font-weight: bold !important;
      cursor: not-allowed !important;
      user-select: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
    }
  `,font_formats:"Carlito=Carlito, sans-serif;",paste_webkit_styles:"all",paste_remove_styles_if_webkit:!1,paste_merge_formats:!0,paste_as_text:!1,keep_styles:!0,forced_root_block:"p",forced_root_block_attrs:{style:"font-family: 'Carlito', sans-serif;"},...p.value&&{noneditable_noneditable_class:"variable-protected",noneditable_editable_class:"mce-editable",content_css_cors:!0},setup:n=>{if(n.ui.registry.addButton("save",{text:p.value?"Guardar":"Guardar como borrador",icon:"save",onAction:()=>{p.value?P():j()}}),n.ui.registry.addButton("continue",{text:"Continuar",icon:"chevron-right",onAction:()=>{$()}}),n.ui.registry.addButton("return",{text:"Regresar",icon:"chevron-left",onAction:()=>{M()}}),n.on("init",()=>{try{setTimeout(()=>{try{const a=n.getContent(),e=y(a);a!==e&&(u=!0,n.setContent(e),u=!1)}catch(a){console.error("[ERROR] Failed to initialize content:",a)}},100)}catch(a){console.error("[ERROR] Initialization failed:",a)}}),n.on("BeforeSetContent",a=>{a.content&&(a.content=a.content.replace(/<([a-z][a-z0-9]*)\b([^>]*)(style=["'])([^"']*)["']([^>]*)>/gi,function(e,t,s,i,v,S){return v.includes("font-family")?e.replace(/(font-family\s*:\s*)([^;"]*)([;"])/gi,"font-family: 'Carlito', sans-serif$3"):`<${t}${s}${i}font-family: 'Carlito', sans-serif; ${v}"${S}>`}))}),n.on("SetContent",a=>{if(!u)try{(a.source_view||a.paste||a.setup)&&(u=!0,setTimeout(()=>{try{const e=n.getContent(),t=y(e);e!==t&&n.setContent(t,{format:"raw",no_events:!0})}catch(e){console.error("[ERROR] Failed to process SetContent:",e)}finally{u=!1}},50))}catch(e){console.error("[ERROR] SetContent event error:",e),u=!1}}),n.on("input",()=>{}),p.value){const a=()=>{n.dom.select(".variable-protected").forEach(t=>{t.setAttribute("contenteditable","false"),t.setAttribute("data-mce-contenteditable","false"),t.setAttribute("unselectable","on"),t.className=t.className.replace("mceNonEditable","")+" mceNonEditable",t.style.userSelect="none",t.style.webkitUserSelect="none",t.style.mozUserSelect="none",t.style.msUserSelect="none",t.style.pointerEvents="none",t.style.cursor="not-allowed",t.onmousedown=()=>!1,t.onselectstart=()=>!1,t.ondragstart=()=>!1,t.oncontextmenu=()=>!1,t.style.backgroundColor="#ffeb3b",t.style.color="#d32f2f",t.style.fontWeight="bold",t.style.padding="2px 4px",t.style.borderRadius="3px",t.style.display="inline-block",t.style.border="1px solid #fbc02d",t.title="Variable protegida - No se puede editar"})};n.on("keydown",e=>{var C,_,E,U,g;const t=n.selection,s=t.getNode(),i=t.getRng(),v=((C=s.classList)==null?void 0:C.contains("variable-protected"))||s.closest(".variable-protected")||((U=(E=(_=i.commonAncestorContainer)==null?void 0:_.parentElement)==null?void 0:E.classList)==null?void 0:U.contains("variable-protected")),S=t.getContent(),I=S.includes("variable-protected")||S.includes("data-variable=");if((e.key==="Backspace"||e.key==="Delete"||e.key==="x"&&(e.ctrlKey||e.metaKey))&&(v||I)){if(e.preventDefault(),e.stopPropagation(),v){const z=(g=s.classList)!=null&&g.contains("variable-protected")?s:s.closest(".variable-protected");if(z){const K=z.nextSibling;if(K)t.select(K),t.collapse(!0);else{const G=n.dom.create("span",{}," ");n.dom.insertAfter(G,z),t.select(G),t.collapse(!0)}}}return!1}if(v&&!["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(e.key))return e.preventDefault(),!1}),n.on("paste",e=>{var v;const t=n.selection,s=t.getNode(),i=t.getContent();if((v=s.classList)!=null&&v.contains("variable-protected")||s.closest(".variable-protected")||i.includes("variable-protected"))return e.preventDefault(),!1}),n.on("BeforeSetContent",e=>{!u&&e.content&&n.getContent()}),n.on("SetContent",e=>{u||setTimeout(()=>{a()},10)}),n.on("input",()=>{if(u)return;const e=n.getContent(),t=(b.value.match(/{{.*?}}/g)||[]).length;if((e.match(/variable-protected/g)||[]).length<t){u=!0;const i=k(b.value);n.setContent(i),setTimeout(()=>{a(),u=!1},10);return}a()}),n.on("dragstart",e=>{var s;const t=e.target;if((s=t.classList)!=null&&s.contains("variable-protected")||t.closest(".variable-protected"))return e.preventDefault(),!1}),n.on("selectionchange",()=>{const e=n.selection.getContent();if(e.includes("variable-protected")||e.includes("mceNonEditable")){const t=n.selection;t.getRng();const s=n.getBody(),i=n.dom.select("p,div",s);if(i.length>0){const v=i[0];t.select(v),t.collapse(!0)}}}),n.on("beforeinput",e=>{var i;const t=n.selection,s=t.getNode();if((i=s.classList)!=null&&i.contains("variable-protected")||s.closest(".variable-protected")||t.getContent().includes("variable-protected"))return e.preventDefault(),!1}),n.on("init",()=>{setTimeout(()=>{a()},100)}),n.on("LoadContent",()=>{setTimeout(()=>{a()},50)})}}})),M=()=>{c.push("/dynamic_document_dashboard")};return(n,a)=>(se(),le("main",Ae,[ce(ue(Ne),{"api-key":"tmizyezb3c6j68qwkp8d5hrr3vgk5va6uouidoe2hj7nxp3p",modelValue:l.value,"onUpdate:modelValue":a[0]||(a[0]=e=>l.value=e),init:A.value},null,8,["modelValue","init"])]))}};export{Be as default};
