import{T as w,B as P,aY as M,r as k,W as E,o as U,X as L,a2 as $,aZ as F,Y as R,u as T,a9 as V,e as x,f as N,j as K,l as G,s as B}from"./index.js";import{u as H}from"./dynamicDocument.js";var q=["onActivate","onAddUndo","onBeforeAddUndo","onBeforeExecCommand","onBeforeGetContent","onBeforeRenderUI","onBeforeSetContent","onBeforePaste","onBlur","onChange","onClearUndos","onClick","onContextMenu","onCopy","onCut","onDblclick","onDeactivate","onDirty","onDrag","onDragDrop","onDragEnd","onDragGesture","onDragOver","onDrop","onExecCommand","onFocus","onFocusIn","onFocusOut","onGetContent","onHide","onInit","onKeyDown","onKeyPress","onKeyUp","onLoadContent","onMouseDown","onMouseEnter","onMouseLeave","onMouseMove","onMouseOut","onMouseOver","onMouseUp","onNodeChange","onObjectResizeStart","onObjectResized","onObjectSelected","onPaste","onPostProcess","onPostRender","onPreProcess","onProgressState","onRedo","onRemove","onReset","onSaveContent","onSelectionChange","onSetAttrib","onSetContent","onShow","onSubmit","onUndo","onVisualAid"],W=function(e){return q.map(function(o){return o.toLowerCase()}).indexOf(e.toLowerCase())!==-1},Y=function(e,o,r){Object.keys(o).filter(W).forEach(function(s){var t=o[s];typeof t=="function"&&(s==="onInit"?t(e,r):r.on(s.substring(2),function(f){return t(f,r)}))})},X=function(e,o,r,s){var t=e.modelEvents?e.modelEvents:null,f=Array.isArray(t)?t.join(" "):t;w(s,function(v,m){r&&typeof v=="string"&&v!==m&&v!==r.getContent({format:e.outputFormat})&&r.setContent(v)}),r.on(f||"change input undo redo",function(){o.emit("update:modelValue",r.getContent({format:e.outputFormat}))})},Z=function(e,o,r,s,t,f){s.setContent(f()),r.attrs["onUpdate:modelValue"]&&X(o,r,s,t),Y(e,r.attrs,s)},I=0,j=function(e){var o=Date.now(),r=Math.floor(Math.random()*1e9);return I++,e+"_"+r+I+String(o)},J=function(e){return e!==null&&e.tagName.toLowerCase()==="textarea"},A=function(e){return typeof e>"u"||e===""?[]:Array.isArray(e)?e:e.split(" ")},Q=function(e,o){return A(e).concat(A(o))},ee=function(e){return e==null},O=function(){return{listeners:[],scriptId:j("tiny-script"),scriptLoaded:!1}},te=function(){var e=O(),o=function(t,f,v,m){var c=f.createElement("script");c.referrerPolicy="origin",c.type="application/javascript",c.id=t,c.src=v;var g=function(){c.removeEventListener("load",g),m()};c.addEventListener("load",g),f.head&&f.head.appendChild(c)},r=function(t,f,v){e.scriptLoaded?v():(e.listeners.push(v),t.getElementById(e.scriptId)||o(e.scriptId,t,f,function(){e.listeners.forEach(function(m){return m()}),e.scriptLoaded=!0}))},s=function(){e=O()};return{load:r,reinitialize:s}},ne=te(),oe=function(){return typeof window<"u"?window:global},C=function(){var e=oe();return e&&e.tinymce?e.tinymce:null},re={apiKey:String,cloudChannel:String,id:String,init:Object,initialValue:String,inline:Boolean,modelEvents:[String,Array],plugins:[String,Array],tagName:String,toolbar:[String,Array],modelValue:String,disabled:Boolean,tinymceScriptSrc:String,outputFormat:{type:String,validator:function(e){return e==="html"||e==="text"}}},h=function(){return h=Object.assign||function(e){for(var o,r=1,s=arguments.length;r<s;r++){o=arguments[r];for(var t in o)Object.prototype.hasOwnProperty.call(o,t)&&(e[t]=o[t])}return e},h.apply(this,arguments)},ae=function(e,o,r,s){return e(s||"div",{id:o,ref:r})},ie=function(e,o,r){return e("textarea",{id:o,visibility:"hidden",ref:r})},S={selector:void 0,target:void 0},le=P({props:re,setup:function(e,o){var r=e.init?h(h({},e.init),S):h({},S),s=M(e),t=s.disabled,f=s.modelValue,v=s.tagName,m=k(null),c=null,g=e.id||j("tiny-vue"),_=e.init&&e.init.inline||e.inline,D=!!o.attrs["onUpdate:modelValue"],b=!0,i=e.initialValue?e.initialValue:"",a="",l=function(n){return D?function(){return f!=null&&f.value?f.value:""}:function(){return n?i:a}},u=function(){var n=l(b),d=h(h({},r),{readonly:e.disabled,target:m.value,plugins:Q(r.plugins,e.plugins),toolbar:e.toolbar||r.toolbar,inline:_,setup:function(p){c=p,p.on("init",function(z){return Z(z,e,o,p,f,n)}),typeof r.setup=="function"&&r.setup(p)}});J(m.value)&&(m.value.style.visibility=""),C().init(d),b=!1};w(t,function(n){var d;c!==null&&(typeof((d=c.mode)===null||d===void 0?void 0:d.set)=="function"?c.mode.set(n?"readonly":"design"):c.setMode(n?"readonly":"design"))}),w(v,function(n){var d;D||(a=c.getContent()),(d=C())===null||d===void 0||d.remove(c),E(function(){return u()})}),U(function(){if(C()!==null)u();else if(m.value&&m.value.ownerDocument){var n=e.cloudChannel?e.cloudChannel:"6",d=e.apiKey?e.apiKey:"no-api-key",p=ee(e.tinymceScriptSrc)?"https://cdn.tiny.cloud/1/".concat(d,"/tinymce/").concat(n,"/tinymce.min.js"):e.tinymceScriptSrc;ne.load(m.value.ownerDocument,p,u)}}),L(function(){C()!==null&&C().remove(c)}),_||($(function(){b||u()}),F(function(){var n;D||(a=c.getContent()),(n=C())===null||n===void 0||n.remove(c)}));var y=function(n){var d;a=c.getContent(),(d=C())===null||d===void 0||d.remove(c),r=h(h(h({},r),n),S),E(function(){return u()})};return o.expose({rerender:y,getEditor:function(){return c}}),function(){return _?ae(R,g,m,e.tagName):ie(R,g,m)}}});const ue={class:"flex h-screen w-full"},de={__name:"DocumentEditor",setup(e){const o=k(""),r=T(),s=V(),t=H();U(async()=>{var a;const i=s.params.id;if(i)try{const l=await t.fetchDocumentById(i,!0);t.selectedDocument=l,o.value=(l==null?void 0:l.content)||""}catch(l){console.error("Error fetching document:",l),t.selectedDocument=await t.documentById(i),o.value=((a=t.selectedDocument)==null?void 0:a.content)||""}});const f=()=>{const i=/{{(.*?)}}/g;return Array.from(new Set([...o.value.matchAll(i)].map(a=>a[1])))},v=i=>{var u;const a=((u=t.selectedDocument)==null?void 0:u.variables)||[],l=i.map(y=>{const n=a.find(d=>d.name_en===y);return{name_en:y,name_es:(n==null?void 0:n.name_es)||"",tooltip:(n==null?void 0:n.tooltip)||"",field_type:(n==null?void 0:n.field_type)||"input",value:(n==null?void 0:n.value)||"",select_options:(n==null?void 0:n.field_type)==="select"?(n==null?void 0:n.select_options)||[]:null}});t.selectedDocument.variables=l},m=async()=>{var i,a;try{const l=f();t.selectedDocument?(t.selectedDocument.content=o.value,t.selectedDocument.state="Draft",l.length>0&&v(l)):(t.selectedDocument={title:((i=t.selectedDocument)==null?void 0:i.title)||s.params.title||"Untitled Document",content:o.value,state:"Draft",variables:[]},l.length>0&&v(l));let u,y;(a=t.selectedDocument)!=null&&a.id?(u=t.selectedDocument.id,y=await t.updateDocument(u,t.selectedDocument)):(y=await t.createDocument(t.selectedDocument),y&&y.id&&(u=y.id));const n=t.selectedDocument;if(t.selectedDocument=null,await t.init(),!u&&n&&n.title){const d=t.documents.find(p=>p.title===n.title&&p.content===n.content&&p.state==="Draft");d&&(u=d.id)}u&&(localStorage.setItem("lastUpdatedDocumentId",u.toString()),t.lastUpdatedDocumentId=u),await B("Â¡Borrador guardado exitosamente!","success"),setTimeout(()=>{window.location.href="/dynamic_document_dashboard"},500)}catch(l){console.error("Error saving draft:",l),await B("Error al guardar el borrador.","error")}},c=async()=>{const i=f();i.length>0?(t.selectedDocument?t.selectedDocument.content=o.value:t.selectedDocument={title:s.params.title||"Untitled Document",content:o.value,variables:[]},v(i),r.push("/dynamic_document_dashboard/lawyer/variables-config")):await m()};let g=!1;function _(i){if(!i||typeof i!="string")return i;try{return i.replace(/(font-family\s*:\s*)([^;!]*)([;!])/gi,"font-family: 'Carlito', sans-serif$3").replace(/<([a-z][a-z0-9]*)\b([^>]*)(?!\bstyle=)([^>]*)>/gi,function(a,l,u,y){return/style=/i.test(u)?a:`<${l}${u} style="font-family: 'Carlito', sans-serif;"${y}>`})}catch(a){return console.error("[ERROR] Failed to apply Carlito font:",a),i}}const D={language:"es",plugins:"lists link image table code wordcount autolink searchreplace textpattern",menubar:"",toolbar:"save continue return | undo redo | formatselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | outdent indent | blocks fontsize lineheight | forecolor | removeformat | hr",height:"100vh",width:"100%",content_style:`
    @import url('https://fonts.googleapis.com/css2?family=Carlito&display=swap');
    body, p, span, div, strong, em, u, i, b {
      font-family: 'Carlito', sans-serif !important;
    }
  `,font_formats:"Carlito=Carlito, sans-serif;",paste_webkit_styles:"all",paste_remove_styles_if_webkit:!1,paste_merge_formats:!0,paste_as_text:!1,keep_styles:!0,forced_root_block:"p",forced_root_block_attrs:{style:"font-family: 'Carlito', sans-serif;"},setup:i=>{i.ui.registry.addButton("save",{text:"Guardar como borrador",icon:"save",onAction:()=>{m()}}),i.ui.registry.addButton("continue",{text:"Continuar",icon:"chevron-right",onAction:()=>{c()}}),i.ui.registry.addButton("return",{text:"Regresar",icon:"chevron-left",onAction:()=>{b()}}),i.on("init",()=>{try{setTimeout(()=>{try{const a=i.getContent(),l=_(a);a!==l&&(g=!0,i.setContent(l),g=!1)}catch(a){console.error("[ERROR] Failed to initialize content:",a)}},100)}catch(a){console.error("[ERROR] Initialization failed:",a)}}),i.on("BeforeSetContent",a=>{a.content&&(a.content=a.content.replace(/<([a-z][a-z0-9]*)\b([^>]*)(style=["'])([^"']*)["']([^>]*)>/gi,function(l,u,y,n,d,p){return d.includes("font-family")?l.replace(/(font-family\s*:\s*)([^;"]*)([;"])/gi,"font-family: 'Carlito', sans-serif$3"):`<${u}${y}${n}font-family: 'Carlito', sans-serif; ${d}"${p}>`}))}),i.on("SetContent",a=>{if(!g)try{(a.source_view||a.paste||a.setup)&&(g=!0,setTimeout(()=>{try{const l=i.getContent(),u=_(l);l!==u&&i.setContent(u,{format:"raw",no_events:!0})}catch(l){console.error("[ERROR] Failed to process SetContent:",l)}finally{g=!1}},50))}catch(l){console.error("[ERROR] SetContent event error:",l),g=!1}}),i.on("input",()=>{})}},b=()=>{r.push("/dynamic_document_dashboard")};return(i,a)=>(x(),N("main",ue,[K(G(le),{"api-key":"tmizyezb3c6j68qwkp8d5hrr3vgk5va6uouidoe2hj7nxp3p",modelValue:o.value,"onUpdate:modelValue":a[0]||(a[0]=l=>o.value=l),init:D},null,8,["modelValue"])]))}};export{de as default};
