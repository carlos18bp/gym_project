import{T as P,B as Y,aZ as Z,r as x,W as M,o as q,X as J,a2 as Q,a_ as ee,Y as F,u as te,aa as ne,P as oe,c as K,e as ae,f as re,j as ie,l as se,s as A}from"./index.js";import{u as le}from"./index3.js";var ce=["onActivate","onAddUndo","onBeforeAddUndo","onBeforeExecCommand","onBeforeGetContent","onBeforeRenderUI","onBeforeSetContent","onBeforePaste","onBlur","onChange","onClearUndos","onClick","onContextMenu","onCopy","onCut","onDblclick","onDeactivate","onDirty","onDrag","onDragDrop","onDragEnd","onDragGesture","onDragOver","onDrop","onExecCommand","onFocus","onFocusIn","onFocusOut","onGetContent","onHide","onInit","onKeyDown","onKeyPress","onKeyUp","onLoadContent","onMouseDown","onMouseEnter","onMouseLeave","onMouseMove","onMouseOut","onMouseOver","onMouseUp","onNodeChange","onObjectResizeStart","onObjectResized","onObjectSelected","onPaste","onPostProcess","onPostRender","onPreProcess","onProgressState","onRedo","onRemove","onReset","onSaveContent","onSelectionChange","onSetAttrib","onSetContent","onShow","onSubmit","onUndo","onVisualAid"],ue=function(n){return ce.map(function(s){return s.toLowerCase()}).indexOf(n.toLowerCase())!==-1},de=function(n,s,c){Object.keys(s).filter(ue).forEach(function(u){var a=s[u];typeof a=="function"&&(u==="onInit"?a(n,c):c.on(u.substring(2),function(m){return a(m,c)}))})},fe=function(n,s,c,u){var a=n.modelEvents?n.modelEvents:null,m=Array.isArray(a)?a.join(" "):a;P(u,function(v,f){c&&typeof v=="string"&&v!==f&&v!==c.getContent({format:n.outputFormat})&&c.setContent(v)}),c.on(m||"change input undo redo",function(){s.emit("update:modelValue",c.getContent({format:n.outputFormat}))})},me=function(n,s,c,u,a,m){u.setContent(m()),c.attrs["onUpdate:modelValue"]&&fe(s,c,u,a),de(n,c.attrs,u)},G=0,X=function(n){var s=Date.now(),c=Math.floor(Math.random()*1e9);return G++,n+"_"+c+G+String(s)},ve=function(n){return n!==null&&n.tagName.toLowerCase()==="textarea"},H=function(n){return typeof n>"u"||n===""?[]:Array.isArray(n)?n:n.split(" ")},pe=function(n,s){return H(n).concat(H(s))},ge=function(n){return n==null},W=function(){return{listeners:[],scriptId:X("tiny-script"),scriptLoaded:!1}},ye=function(){var n=W(),s=function(a,m,v,f){var d=m.createElement("script");d.referrerPolicy="origin",d.type="application/javascript",d.id=a,d.src=v;var h=function(){d.removeEventListener("load",h),f()};d.addEventListener("load",h),m.head&&m.head.appendChild(d)},c=function(a,m,v){n.scriptLoaded?v():(n.listeners.push(v),a.getElementById(n.scriptId)||s(n.scriptId,a,m,function(){n.listeners.forEach(function(f){return f()}),n.scriptLoaded=!0}))},u=function(){n=W()};return{load:c,reinitialize:u}},be=ye(),he=function(){return typeof window<"u"?window:global},w=function(){var n=he();return n&&n.tinymce?n.tinymce:null},Ce={apiKey:String,cloudChannel:String,id:String,init:Object,initialValue:String,inline:Boolean,modelEvents:[String,Array],plugins:[String,Array],tagName:String,toolbar:[String,Array],modelValue:String,disabled:Boolean,tinymceScriptSrc:String,outputFormat:{type:String,validator:function(n){return n==="html"||n==="text"}}},b=function(){return b=Object.assign||function(n){for(var s,c=1,u=arguments.length;c<u;c++){s=arguments[c];for(var a in s)Object.prototype.hasOwnProperty.call(s,a)&&(n[a]=s[a])}return n},b.apply(this,arguments)},_e=function(n,s,c,u){return n(u||"div",{id:s,ref:c})},De=function(n,s,c){return n("textarea",{id:s,visibility:"hidden",ref:c})},I={selector:void 0,target:void 0},we=Y({props:Ce,setup:function(n,s){var c=n.init?b(b({},n.init),I):b({},I),u=Z(n),a=u.disabled,m=u.modelValue,v=u.tagName,f=x(null),d=null,h=n.id||X("tiny-vue"),E=n.init&&n.init.inline||n.inline,_=!!s.attrs["onUpdate:modelValue"],k=!0,N=n.initialValue?n.initialValue:"",S="",y=function(g){return _?function(){return m!=null&&m.value?m.value:""}:function(){return g?N:S}},C=function(){var g=y(k),e=b(b({},c),{readonly:n.disabled,target:f.value,plugins:pe(c.plugins,n.plugins),toolbar:n.toolbar||c.toolbar,inline:E,setup:function(r){d=r,r.on("init",function(o){return me(o,n,s,r,m,g)}),typeof c.setup=="function"&&c.setup(r)}});ve(f.value)&&(f.value.style.visibility=""),w().init(e),k=!1};P(a,function(g){var e;d!==null&&(typeof((e=d.mode)===null||e===void 0?void 0:e.set)=="function"?d.mode.set(g?"readonly":"design"):d.setMode(g?"readonly":"design"))}),P(v,function(g){var e;_||(S=d.getContent()),(e=w())===null||e===void 0||e.remove(d),M(function(){return C()})}),q(function(){if(w()!==null)C();else if(f.value&&f.value.ownerDocument){var g=n.cloudChannel?n.cloudChannel:"6",e=n.apiKey?n.apiKey:"no-api-key",r=ge(n.tinymceScriptSrc)?"https://cdn.tiny.cloud/1/".concat(e,"/tinymce/").concat(g,"/tinymce.min.js"):n.tinymceScriptSrc;be.load(f.value.ownerDocument,r,C)}}),J(function(){w()!==null&&w().remove(d)}),E||(Q(function(){k||C()}),ee(function(){var g;_||(S=d.getContent()),(g=w())===null||g===void 0||g.remove(d)}));var B=function(g){var e;S=d.getContent(),(e=w())===null||e===void 0||e.remove(d),c=b(b(b({},c),g),I),M(function(){return C()})};return s.expose({rerender:B,getEditor:function(){return d}}),function(){return E?_e(F,h,f,n.tagName):De(F,h,f)}}});const Se={class:"flex h-screen w-full"},Re={__name:"DocumentEditor",setup(n){const s=x(""),c=te(),u=ne(),a=le(),m=oe(),v=K(()=>{var e;return u.path.includes("/client/editor/")||((e=m.currentUser)==null?void 0:e.role)!=="lawyer"}),f=x("");x(""),q(async()=>{var r;const e=u.params.id;if(e)try{const o=await a.fetchDocumentById(e,!0);a.selectedDocument=o,f.value=(o==null?void 0:o.content)||"",v.value?s.value=h(f.value):s.value=f.value}catch(o){console.error("Error fetching document:",o),a.selectedDocument=await a.documentById(e),f.value=((r=a.selectedDocument)==null?void 0:r.content)||"",v.value?s.value=h(f.value):s.value=f.value}});const d=(e=null)=>{const r=e||s.value,o=/{{(.*?)}}/g;return Array.from(new Set([...r.matchAll(o)].map(t=>t[1])))},h=e=>{var o;if(!e||!((o=a.selectedDocument)!=null&&o.variables))return e;let r=e;return a.selectedDocument.variables.forEach(t=>{const l=new RegExp(`{{${t.name_en}}}`,"g"),i=t.value||`[${t.name_es||t.name_en}]`,p=`<span 
      class="variable-protected mceNonEditable" 
      data-variable="${t.name_en}" 
      data-mce-contenteditable="false"
      contenteditable="false" 
      unselectable="on"
      style="background-color: #ffeb3b !important; color: #d32f2f !important; padding: 2px 4px !important; border-radius: 3px !important; font-weight: bold !important; cursor: not-allowed !important; user-select: none !important; -webkit-user-select: none !important; -moz-user-select: none !important; -ms-user-select: none !important; display: inline-block !important;"
      title="Variable protegida: ${t.name_es||t.name_en} - No se puede editar"
      onmousedown="return false;"
      onselectstart="return false;"
      ondragstart="return false;"
    >${i}</span>`;r=r.replace(l,p)}),r},E=e=>e&&e.replace(/<span[^>]*(?:class="[^"]*variable-protected[^"]*"|data-variable="([^"]*)")(?:[^>]*data-variable="([^"]*)")?[^>]*>[\s\S]*?<\/span>/g,(r,o,t)=>{const l=o||t;return l?`{{${l}}}`:r}),_=e=>{var t;const r=((t=a.selectedDocument)==null?void 0:t.variables)||[],o=e.map(l=>{const i=r.find(p=>p.name_en===l);return{name_en:l,name_es:(i==null?void 0:i.name_es)||"",tooltip:(i==null?void 0:i.tooltip)||"",field_type:(i==null?void 0:i.field_type)||"input",value:(i==null?void 0:i.value)||"",select_options:(i==null?void 0:i.field_type)==="select"?(i==null?void 0:i.select_options)||[]:null}});a.selectedDocument.variables=o},k=async()=>{try{const e=E(s.value);if(a.selectedDocument){const r={...a.selectedDocument,content:e};await a.updateDocument(a.selectedDocument.id,r)&&(await A("Documento guardado exitosamente.","success"),setTimeout(()=>{window.location.href="/dynamic_document_dashboard"},500))}else await A("Error: No se encontró el documento para guardar.","error")}catch(e){console.error("Error saving document content:",e),await A("Error al guardar el documento.","error")}},N=async()=>{var e,r;try{const o=s.value,t=d();a.selectedDocument?(a.selectedDocument.content=o,a.selectedDocument.state="Draft",t.length>0&&_(t)):(a.selectedDocument={title:((e=a.selectedDocument)==null?void 0:e.title)||u.params.title||"Untitled Document",content:o,state:"Draft",variables:[]},t.length>0&&_(t));let l,i;(r=a.selectedDocument)!=null&&r.id?(l=a.selectedDocument.id,i=await a.updateDocument(l,a.selectedDocument)):(i=await a.createDocument(a.selectedDocument),i&&i.id&&(l=i.id));const p=a.selectedDocument;if(a.selectedDocument=null,await a.init(),!l&&p&&p.title){const D=a.documents.find(R=>R.title===p.title&&R.content===p.content&&R.state==="Draft");D&&(l=D.id)}l&&(localStorage.setItem("lastUpdatedDocumentId",l.toString()),a.lastUpdatedDocumentId=l),await A("¡Borrador guardado exitosamente!","success"),setTimeout(()=>{window.location.href="/dynamic_document_dashboard"},500)}catch(o){console.error("Error saving draft:",o),await A("Error al guardar el borrador.","error")}},S=async()=>{const e=d();e.length>0?(a.selectedDocument?a.selectedDocument.content=s.value:a.selectedDocument={title:u.params.title||"Untitled Document",content:s.value,variables:[]},_(e),c.push("/dynamic_document_dashboard/lawyer/variables-config")):await N()};let y=!1;function C(e){if(!e||typeof e!="string")return e;try{return e.replace(/(font-family\s*:\s*)([^;!]*)([;!])/gi,"font-family: 'Carlito', sans-serif$3").replace(/<([a-z][a-z0-9]*)\b([^>]*)(?!\bstyle=)([^>]*)>/gi,function(r,o,t,l){return/style=/i.test(t)?r:`<${o}${t} style="font-family: 'Carlito', sans-serif;"${l}>`})}catch(r){return console.error("[ERROR] Failed to apply Carlito font:",r),e}}const B=K(()=>({language:"es",plugins:v.value?"lists link image table code wordcount autolink searchreplace textpattern noneditable":"lists link image table code wordcount autolink searchreplace textpattern",menubar:"",toolbar:v.value?"save return | undo redo | formatselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | outdent indent | blocks fontsize lineheight | forecolor | removeformat | hr":"save continue return | undo redo | formatselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | outdent indent | blocks fontsize lineheight | forecolor | removeformat | hr",height:"100vh",width:"100%",content_style:`
    @import url('https://fonts.googleapis.com/css2?family=Carlito&display=swap');
    body, p, span, div, strong, em, u, i, b {
      font-family: 'Carlito', sans-serif !important;
    }
    .variable-protected {
      background-color: #ffeb3b !important;
      color: #d32f2f !important;
      padding: 2px 4px !important;
      border-radius: 3px !important;
      font-weight: bold !important;
      cursor: not-allowed !important;
      user-select: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
    }
  `,font_formats:"Carlito=Carlito, sans-serif;",paste_webkit_styles:"all",paste_remove_styles_if_webkit:!1,paste_merge_formats:!0,paste_as_text:!1,keep_styles:!0,forced_root_block:"p",forced_root_block_attrs:{style:"font-family: 'Carlito', sans-serif;"},...v.value&&{noneditable_noneditable_class:"variable-protected",noneditable_editable_class:"mce-editable",content_css_cors:!0},setup:e=>{if(e.ui.registry.addButton("save",{text:v.value?"Guardar":"Guardar como borrador",icon:"save",onAction:()=>{v.value?k():N()}}),e.ui.registry.addButton("continue",{text:"Continuar",icon:"chevron-right",onAction:()=>{S()}}),e.ui.registry.addButton("return",{text:"Regresar",icon:"chevron-left",onAction:()=>{g()}}),e.on("init",()=>{try{setTimeout(()=>{try{const r=e.getContent(),o=C(r);r!==o&&(y=!0,e.setContent(o),y=!1)}catch(r){console.error("[ERROR] Failed to initialize content:",r)}},100)}catch(r){console.error("[ERROR] Initialization failed:",r)}}),e.on("BeforeSetContent",r=>{r.content&&(r.content=r.content.replace(/<([a-z][a-z0-9]*)\b([^>]*)(style=["'])([^"']*)["']([^>]*)>/gi,function(o,t,l,i,p,D){return p.includes("font-family")?o.replace(/(font-family\s*:\s*)([^;"]*)([;"])/gi,"font-family: 'Carlito', sans-serif$3"):`<${t}${l}${i}font-family: 'Carlito', sans-serif; ${p}"${D}>`}))}),e.on("SetContent",r=>{if(!y)try{(r.source_view||r.paste||r.setup)&&(y=!0,setTimeout(()=>{try{const o=e.getContent(),t=C(o);o!==t&&e.setContent(t,{format:"raw",no_events:!0})}catch(o){console.error("[ERROR] Failed to process SetContent:",o)}finally{y=!1}},50))}catch(o){console.error("[ERROR] SetContent event error:",o),y=!1}}),e.on("input",()=>{}),v.value){const r=()=>{e.dom.select(".variable-protected").forEach(t=>{t.setAttribute("contenteditable","false"),t.setAttribute("data-mce-contenteditable","false"),t.setAttribute("unselectable","on"),t.className=t.className.replace("mceNonEditable","")+" mceNonEditable",t.style.userSelect="none",t.style.webkitUserSelect="none",t.style.mozUserSelect="none",t.style.msUserSelect="none",t.style.pointerEvents="none",t.style.cursor="not-allowed",t.onmousedown=()=>!1,t.onselectstart=()=>!1,t.ondragstart=()=>!1,t.oncontextmenu=()=>!1,t.style.backgroundColor="#ffeb3b",t.style.color="#d32f2f",t.style.fontWeight="bold",t.style.padding="2px 4px",t.style.borderRadius="3px",t.style.display="inline-block",t.style.border="1px solid #fbc02d",t.title="Variable protegida - No se puede editar"})};e.on("keydown",o=>{var z,L,O,T,V;const t=e.selection,l=t.getNode(),i=t.getRng(),p=((z=l.classList)==null?void 0:z.contains("variable-protected"))||l.closest(".variable-protected")||((T=(O=(L=i.commonAncestorContainer)==null?void 0:L.parentElement)==null?void 0:O.classList)==null?void 0:T.contains("variable-protected")),D=t.getContent(),R=D.includes("variable-protected")||D.includes("data-variable=");if((o.key==="Backspace"||o.key==="Delete"||o.key==="x"&&(o.ctrlKey||o.metaKey))&&(p||R)){if(o.preventDefault(),o.stopPropagation(),p){const U=(V=l.classList)!=null&&V.contains("variable-protected")?l:l.closest(".variable-protected");if(U){const j=U.nextSibling;if(j)t.select(j),t.collapse(!0);else{const $=e.dom.create("span",{}," ");e.dom.insertAfter($,U),t.select($),t.collapse(!0)}}}return!1}if(p&&!["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(o.key))return o.preventDefault(),!1}),e.on("paste",o=>{var p;const t=e.selection,l=t.getNode(),i=t.getContent();if((p=l.classList)!=null&&p.contains("variable-protected")||l.closest(".variable-protected")||i.includes("variable-protected"))return o.preventDefault(),!1}),e.on("BeforeSetContent",o=>{!y&&o.content&&e.getContent()}),e.on("SetContent",o=>{y||setTimeout(()=>{r()},10)}),e.on("input",()=>{if(y)return;const o=e.getContent(),t=(f.value.match(/{{.*?}}/g)||[]).length;if((o.match(/variable-protected/g)||[]).length<t){y=!0;const i=h(f.value);e.setContent(i),setTimeout(()=>{r(),y=!1},10);return}r()}),e.on("dragstart",o=>{var l;const t=o.target;if((l=t.classList)!=null&&l.contains("variable-protected")||t.closest(".variable-protected"))return o.preventDefault(),!1}),e.on("selectionchange",()=>{const o=e.selection.getContent();if(o.includes("variable-protected")||o.includes("mceNonEditable")){const t=e.selection;t.getRng();const l=e.getBody(),i=e.dom.select("p,div",l);if(i.length>0){const p=i[0];t.select(p),t.collapse(!0)}}}),e.on("beforeinput",o=>{var i;const t=e.selection,l=t.getNode();if((i=l.classList)!=null&&i.contains("variable-protected")||l.closest(".variable-protected")||t.getContent().includes("variable-protected"))return o.preventDefault(),!1}),e.on("init",()=>{setTimeout(()=>{r()},100)}),e.on("LoadContent",()=>{setTimeout(()=>{r()},50)})}}})),g=()=>{c.push("/dynamic_document_dashboard")};return(e,r)=>(ae(),re("main",Se,[ie(se(we),{"api-key":"tmizyezb3c6j68qwkp8d5hrr3vgk5va6uouidoe2hj7nxp3p",modelValue:s.value,"onUpdate:modelValue":r[0]||(r[0]=o=>s.value=o),init:B.value},null,8,["modelValue","init"])]))}};export{Re as default};
