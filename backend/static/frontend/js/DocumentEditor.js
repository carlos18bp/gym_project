import{T as M,B as Q,ba as Z,r as O,W as G,o as Y,X as ee,a3 as te,bb as ne,Y as q,u as oe,ab as ae,I as re,c as j,e as ie,f as se,h as le,j as ce,s as w}from"./index.js";import{u as ue}from"./index2.js";var de=["onActivate","onAddUndo","onBeforeAddUndo","onBeforeExecCommand","onBeforeGetContent","onBeforeRenderUI","onBeforeSetContent","onBeforePaste","onBlur","onChange","onClearUndos","onClick","onContextMenu","onCopy","onCut","onDblclick","onDeactivate","onDirty","onDrag","onDragDrop","onDragEnd","onDragGesture","onDragOver","onDrop","onExecCommand","onFocus","onFocusIn","onFocusOut","onGetContent","onHide","onInit","onKeyDown","onKeyPress","onKeyUp","onLoadContent","onMouseDown","onMouseEnter","onMouseLeave","onMouseMove","onMouseOut","onMouseOver","onMouseUp","onNodeChange","onObjectResizeStart","onObjectResized","onObjectSelected","onPaste","onPostProcess","onPostRender","onPreProcess","onProgressState","onRedo","onRemove","onReset","onSaveContent","onSelectionChange","onSetAttrib","onSetContent","onShow","onSubmit","onUndo","onVisualAid"],fe=function(o){return de.map(function(l){return l.toLowerCase()}).indexOf(o.toLowerCase())!==-1},me=function(o,l,c){Object.keys(l).filter(fe).forEach(function(d){var a=l[d];typeof a=="function"&&(d==="onInit"?a(o,c):c.on(d.substring(2),function(f){return a(f,c)}))})},pe=function(o,l,c,d){var a=o.modelEvents?o.modelEvents:null,f=Array.isArray(a)?a.join(" "):a;M(d,function(p,b){c&&typeof p=="string"&&p!==b&&p!==c.getContent({format:o.outputFormat})&&c.setContent(p)}),c.on(f||"change input undo redo",function(){l.emit("update:modelValue",c.getContent({format:o.outputFormat}))})},ve=function(o,l,c,d,a,f){d.setContent(f()),c.attrs["onUpdate:modelValue"]&&pe(l,c,d,a),me(o,c.attrs,d)},H=0,J=function(o){var l=Date.now(),c=Math.floor(Math.random()*1e9);return H++,o+"_"+c+H+String(l)},ge=function(o){return o!==null&&o.tagName.toLowerCase()==="textarea"},W=function(o){return typeof o>"u"||o===""?[]:Array.isArray(o)?o:o.split(" ")},ye=function(o,l){return W(o).concat(W(l))},be=function(o){return o==null},X=function(){return{listeners:[],scriptId:J("tiny-script"),scriptLoaded:!1}},he=function(){var o=X(),l=function(a,f,p,b){var u=f.createElement("script");u.referrerPolicy="origin",u.type="application/javascript",u.id=a,u.src=p;var N=function(){u.removeEventListener("load",N),b()};u.addEventListener("load",N),f.head&&f.head.appendChild(u)},c=function(a,f,p){o.scriptLoaded?p():(o.listeners.push(p),a.getElementById(o.scriptId)||l(o.scriptId,a,f,function(){o.listeners.forEach(function(b){return b()}),o.scriptLoaded=!0}))},d=function(){o=X()};return{load:c,reinitialize:d}},Ce=he(),_e=function(){return typeof window<"u"?window:global},P=function(){var o=_e();return o&&o.tinymce?o.tinymce:null},we={apiKey:String,cloudChannel:String,id:String,init:Object,initialValue:String,inline:Boolean,modelEvents:[String,Array],plugins:[String,Array],tagName:String,toolbar:[String,Array],modelValue:String,disabled:Boolean,tinymceScriptSrc:String,outputFormat:{type:String,validator:function(o){return o==="html"||o==="text"}}},D=function(){return D=Object.assign||function(o){for(var l,c=1,d=arguments.length;c<d;c++){l=arguments[c];for(var a in l)Object.prototype.hasOwnProperty.call(l,a)&&(o[a]=l[a])}return o},D.apply(this,arguments)},De=function(o,l,c,d){return o(d||"div",{id:l,ref:c})},Se=function(o,l,c){return o("textarea",{id:l,visibility:"hidden",ref:c})},$={selector:void 0,target:void 0},Ee=Q({props:we,setup:function(o,l){var c=o.init?D(D({},o.init),$):D({},$),d=Z(o),a=d.disabled,f=d.modelValue,p=d.tagName,b=O(null),u=null,N=o.id||J("tiny-vue"),A=o.init&&o.init.inline||o.inline,T=!!l.attrs["onUpdate:modelValue"],R=!0,V=o.initialValue?o.initialValue:"",x="",L=function(v){return T?function(){return f!=null&&f.value?f.value:""}:function(){return v?V:x}},B=function(){var v=L(R),g=D(D({},c),{readonly:o.disabled,target:b.value,plugins:ye(c.plugins,o.plugins),toolbar:o.toolbar||c.toolbar,inline:A,setup:function(k){u=k,k.on("init",function(n){return ve(n,o,l,k,f,v)}),typeof c.setup=="function"&&c.setup(k)}});ge(b.value)&&(b.value.style.visibility=""),P().init(g),R=!1};M(a,function(v){var g;u!==null&&(typeof((g=u.mode)===null||g===void 0?void 0:g.set)=="function"?u.mode.set(v?"readonly":"design"):u.setMode(v?"readonly":"design"))}),M(p,function(v){var g;T||(x=u.getContent()),(g=P())===null||g===void 0||g.remove(u),G(function(){return B()})}),Y(function(){if(P()!==null)B();else if(b.value&&b.value.ownerDocument){var v=o.cloudChannel?o.cloudChannel:"6",g=o.apiKey?o.apiKey:"no-api-key",k=be(o.tinymceScriptSrc)?"https://cdn.tiny.cloud/1/".concat(g,"/tinymce/").concat(v,"/tinymce.min.js"):o.tinymceScriptSrc;Ce.load(b.value.ownerDocument,k,B)}}),ee(function(){P()!==null&&P().remove(u)}),A||(te(function(){R||B()}),ne(function(){var v;T||(x=u.getContent()),(v=P())===null||v===void 0||v.remove(u)}));var h=function(v){var g;x=u.getContent(),(g=P())===null||g===void 0||g.remove(u),c=D(D(D({},c),v),$),G(function(){return B()})};return l.expose({rerender:h,getEditor:function(){return u}}),function(){return A?De(q,N,b,o.tagName):Se(q,N,b)}}});const Ne={class:"flex h-screen w-full"},Re={__name:"DocumentEditor",setup(o){const l=O(""),c=oe(),d=ae(),a=ue(),f=re(),p=j(()=>{var n;return d.path.includes("/client/editor/")||((n=f.currentUser)==null?void 0:n.role)!=="lawyer"}),b=j(()=>d.path.includes("/creator/")),u=O("");O(""),Y(async()=>{var r;const n=d.params.id;if(n)try{const t=await a.fetchDocumentById(n,!0);a.selectedDocument=t,u.value=(t==null?void 0:t.content)||"",p.value?l.value=A(u.value):l.value=u.value}catch(t){console.error("Error fetching document:",t),a.selectedDocument=await a.documentById(n),u.value=((r=a.selectedDocument)==null?void 0:r.content)||"",p.value?l.value=A(u.value):l.value=u.value}});const N=(n=null)=>{const r=n||l.value,t=/{{(.*?)}}/g;return Array.from(new Set([...r.matchAll(t)].map(e=>e[1])))},A=n=>{var t;if(!n||!((t=a.selectedDocument)!=null&&t.variables))return n;let r=n;return a.selectedDocument.variables.forEach(e=>{const s=new RegExp(`{{${e.name_en}}}`,"g"),i=e.value||`[${e.name_es||e.name_en}]`,m=`<span 
      class="variable-protected mceNonEditable" 
      data-variable="${e.name_en}" 
      data-mce-contenteditable="false"
      contenteditable="false" 
      unselectable="on"
      style="background-color: #ffeb3b !important; color: #d32f2f !important; padding: 2px 4px !important; border-radius: 3px !important; font-weight: bold !important; cursor: not-allowed !important; user-select: none !important; -webkit-user-select: none !important; -moz-user-select: none !important; -ms-user-select: none !important; display: inline-block !important;"
      title="Variable protegida: ${e.name_es||e.name_en} - No se puede editar"
      onmousedown="return false;"
      onselectstart="return false;"
      ondragstart="return false;"
    >${i}</span>`;r=r.replace(s,m)}),r},T=n=>n&&n.replace(/<span[^>]*(?:class="[^"]*variable-protected[^"]*"|data-variable="([^"]*)")(?:[^>]*data-variable="([^"]*)")?[^>]*>[\s\S]*?<\/span>/g,(r,t,e)=>{const s=t||e;return s?`{{${s}}}`:r}),R=n=>{var e;const r=((e=a.selectedDocument)==null?void 0:e.variables)||[],t=n.map(s=>{const i=r.find(m=>m.name_en===s);return{name_en:s,name_es:(i==null?void 0:i.name_es)||"",tooltip:(i==null?void 0:i.tooltip)||"",field_type:(i==null?void 0:i.field_type)||"input",value:(i==null?void 0:i.value)||"",select_options:(i==null?void 0:i.field_type)==="select"?(i==null?void 0:i.select_options)||[]:null}});a.selectedDocument.variables=t},V=async()=>{var n;try{const r=T(l.value);if(a.selectedDocument){const t=a.selectedDocument,e=f.getCurrentUser,s=t.assigned_to?String(t.assigned_to):null,i=e!=null&&e.id?String(e.id):null,m=s&&i&&s===i,S=t.state==="Published"&&!t.assigned_to;if(b.value||S||!m){const _=f.getCurrentUser;let C=_==null?void 0:_.id;if(C||(C=(n=f.getCurrentUser)==null?void 0:n.id),!C&&_&&(C=_.id),!C){await w("Error: No se pudo identificar al usuario. Por favor, recarga la página.","error");return}const E={title:String(t.title||"Untitled"),content:String(r||""),state:"Progress",assigned_to:Number(C),variables:Array.isArray(t.variables)?t.variables.map(y=>({name_en:y.name_en||"",name_es:y.name_es||"",tooltip:y.tooltip||"",field_type:y.field_type||"input",value:y.value||"",select_options:y.select_options||null})):[],tag_ids:Array.isArray(t.tags)?t.tags.map(y=>{const z=typeof y=="object"?y.id:y;return Number(z)}).filter(y=>!isNaN(y)):[],requires_signature:!!t.requires_signature,is_public:!1};E.state!=="Progress"&&(E.state="Progress"),(!E.assigned_to||E.assigned_to!==C)&&(E.assigned_to=Number(C));const U=await a.createDocument(E);U&&U.id?(await w("Documento creado exitosamente desde la plantilla.","success"),await a.init(!0),await new Promise(y=>setTimeout(y,300)),window.location.href="/dynamic_document_dashboard"):(console.error("Failed to create document - no ID returned:",U),await w("Error: No se pudo crear el documento.","error"))}else{const _={...t,content:r};await a.updateDocument(t.id,_)&&(await w("Documento guardado exitosamente.","success"),setTimeout(()=>{window.location.href="/dynamic_document_dashboard"},500))}}else await w("Error: No se encontró el documento para guardar.","error")}catch(r){console.error("Error saving document content:",r),await w("Error al guardar el documento.","error")}},x=async()=>{var n,r;try{const t=l.value;if(L(t)){await w("No puedes guardar un documento vacío. Por favor, agrega contenido al documento antes de guardarlo.","warning");return}const e=N();a.selectedDocument?(a.selectedDocument.content=t,a.selectedDocument.state="Draft",e.length>0&&R(e)):(a.selectedDocument={title:((n=a.selectedDocument)==null?void 0:n.title)||d.params.title||"Untitled Document",content:t,state:"Draft",variables:[]},e.length>0&&R(e));let s,i;(r=a.selectedDocument)!=null&&r.id?(s=a.selectedDocument.id,i=await a.updateDocument(s,a.selectedDocument)):(i=await a.createDocument(a.selectedDocument),i&&i.id&&(s=i.id));const m=a.selectedDocument;if(a.selectedDocument=null,await a.init(),!s&&m&&m.title){const S=a.documents.find(I=>I.title===m.title&&I.content===m.content&&I.state==="Draft");S&&(s=S.id)}s&&(localStorage.setItem("lastUpdatedDocumentId",s.toString()),a.lastUpdatedDocumentId=s),await w("¡Borrador guardado exitosamente!","success"),setTimeout(()=>{window.location.href="/dynamic_document_dashboard"},500)}catch(t){console.error("Error saving draft:",t),await w("Error al guardar el borrador.","error")}},L=n=>{if(!n||n.trim()==="")return!0;const r=n.replace(/<[^>]*>/g,"").trim();return r===""||r==="&nbsp;"},B=async()=>{if(L(l.value)){await w("No puedes continuar con un documento vacío. Por favor, agrega contenido al documento antes de continuar.","warning");return}const n=N();n.length>0?(a.selectedDocument?a.selectedDocument.content=l.value:a.selectedDocument={title:d.params.title||"Untitled Document",content:l.value,variables:[]},R(n),c.push("/dynamic_document_dashboard/lawyer/variables-config")):await x()};let h=!1;function v(n){if(!n||typeof n!="string")return n;try{return n.replace(/(font-family\s*:\s*)([^;!]*)([;!])/gi,"font-family: 'Carlito', sans-serif$3").replace(/<([a-z][a-z0-9]*)\b([^>]*)(?!\bstyle=)([^>]*)>/gi,function(r,t,e,s){return/style=/i.test(e)?r:`<${t}${e} style="font-family: 'Carlito', sans-serif;"${s}>`})}catch(r){return console.error("[ERROR] Failed to apply Carlito font:",r),n}}const g=j(()=>({language:"es",plugins:p.value?"lists link image table code wordcount autolink searchreplace textpattern noneditable":"lists link image table code wordcount autolink searchreplace textpattern",menubar:"",toolbar:p.value?"save return | undo redo | formatselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | outdent indent | blocks fontsize lineheight | forecolor | removeformat | hr":"save continue return | undo redo | formatselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | outdent indent | blocks fontsize lineheight | forecolor | removeformat | hr",height:"100vh",width:"100%",content_style:`
    @import url('https://fonts.googleapis.com/css2?family=Carlito&display=swap');
    body, p, span, div, strong, em, u, i, b {
      font-family: 'Carlito', sans-serif !important;
    }
    .variable-protected {
      background-color: #ffeb3b !important;
      color: #d32f2f !important;
      padding: 2px 4px !important;
      border-radius: 3px !important;
      font-weight: bold !important;
      cursor: not-allowed !important;
      user-select: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
    }
  `,font_formats:"Carlito=Carlito, sans-serif;",paste_webkit_styles:"all",paste_remove_styles_if_webkit:!1,paste_merge_formats:!0,paste_as_text:!1,keep_styles:!0,forced_root_block:"p",forced_root_block_attrs:{style:"font-family: 'Carlito', sans-serif;"},...p.value&&{noneditable_noneditable_class:"variable-protected",noneditable_editable_class:"mce-editable",content_css_cors:!0},setup:n=>{if(n.ui.registry.addButton("save",{text:p.value?"Guardar":"Guardar como borrador",icon:"save",onAction:()=>{p.value?V():x()}}),n.ui.registry.addButton("continue",{text:"Continuar",icon:"chevron-right",onAction:()=>{B()}}),n.ui.registry.addButton("return",{text:"Regresar",icon:"chevron-left",onAction:()=>{k()}}),n.on("init",()=>{try{setTimeout(()=>{try{const r=n.getContent(),t=v(r);r!==t&&(h=!0,n.setContent(t),h=!1)}catch(r){console.error("[ERROR] Failed to initialize content:",r)}},100)}catch(r){console.error("[ERROR] Initialization failed:",r)}}),n.on("BeforeSetContent",r=>{r.content&&(r.content=r.content.replace(/<([a-z][a-z0-9]*)\b([^>]*)(style=["'])([^"']*)["']([^>]*)>/gi,function(t,e,s,i,m,S){return m.includes("font-family")?t.replace(/(font-family\s*:\s*)([^;"]*)([;"])/gi,"font-family: 'Carlito', sans-serif$3"):`<${e}${s}${i}font-family: 'Carlito', sans-serif; ${m}"${S}>`}))}),n.on("SetContent",r=>{if(!h)try{(r.source_view||r.paste||r.setup)&&(h=!0,setTimeout(()=>{try{const t=n.getContent(),e=v(t);t!==e&&n.setContent(e,{format:"raw",no_events:!0})}catch(t){console.error("[ERROR] Failed to process SetContent:",t)}finally{h=!1}},50))}catch(t){console.error("[ERROR] SetContent event error:",t),h=!1}}),n.on("input",()=>{}),p.value){const r=()=>{n.dom.select(".variable-protected").forEach(e=>{e.setAttribute("contenteditable","false"),e.setAttribute("data-mce-contenteditable","false"),e.setAttribute("unselectable","on"),e.className=e.className.replace("mceNonEditable","")+" mceNonEditable",e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.mozUserSelect="none",e.style.msUserSelect="none",e.style.pointerEvents="none",e.style.cursor="not-allowed",e.onmousedown=()=>!1,e.onselectstart=()=>!1,e.ondragstart=()=>!1,e.oncontextmenu=()=>!1,e.style.backgroundColor="#ffeb3b",e.style.color="#d32f2f",e.style.fontWeight="bold",e.style.padding="2px 4px",e.style.borderRadius="3px",e.style.display="inline-block",e.style.border="1px solid #fbc02d",e.title="Variable protegida - No se puede editar"})};n.on("keydown",t=>{var _,C,E,U,y;const e=n.selection,s=e.getNode(),i=e.getRng(),m=((_=s.classList)==null?void 0:_.contains("variable-protected"))||s.closest(".variable-protected")||((U=(E=(C=i.commonAncestorContainer)==null?void 0:C.parentElement)==null?void 0:E.classList)==null?void 0:U.contains("variable-protected")),S=e.getContent(),I=S.includes("variable-protected")||S.includes("data-variable=");if((t.key==="Backspace"||t.key==="Delete"||t.key==="x"&&(t.ctrlKey||t.metaKey))&&(m||I)){if(t.preventDefault(),t.stopPropagation(),m){const z=(y=s.classList)!=null&&y.contains("variable-protected")?s:s.closest(".variable-protected");if(z){const F=z.nextSibling;if(F)e.select(F),e.collapse(!0);else{const K=n.dom.create("span",{}," ");n.dom.insertAfter(K,z),e.select(K),e.collapse(!0)}}}return!1}if(m&&!["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(t.key))return t.preventDefault(),!1}),n.on("paste",t=>{var m;const e=n.selection,s=e.getNode(),i=e.getContent();if((m=s.classList)!=null&&m.contains("variable-protected")||s.closest(".variable-protected")||i.includes("variable-protected"))return t.preventDefault(),!1}),n.on("BeforeSetContent",t=>{!h&&t.content&&n.getContent()}),n.on("SetContent",t=>{h||setTimeout(()=>{r()},10)}),n.on("input",()=>{if(h)return;const t=n.getContent(),e=(u.value.match(/{{.*?}}/g)||[]).length;if((t.match(/variable-protected/g)||[]).length<e){h=!0;const i=A(u.value);n.setContent(i),setTimeout(()=>{r(),h=!1},10);return}r()}),n.on("dragstart",t=>{var s;const e=t.target;if((s=e.classList)!=null&&s.contains("variable-protected")||e.closest(".variable-protected"))return t.preventDefault(),!1}),n.on("selectionchange",()=>{const t=n.selection.getContent();if(t.includes("variable-protected")||t.includes("mceNonEditable")){const e=n.selection;e.getRng();const s=n.getBody(),i=n.dom.select("p,div",s);if(i.length>0){const m=i[0];e.select(m),e.collapse(!0)}}}),n.on("beforeinput",t=>{var i;const e=n.selection,s=e.getNode();if((i=s.classList)!=null&&i.contains("variable-protected")||s.closest(".variable-protected")||e.getContent().includes("variable-protected"))return t.preventDefault(),!1}),n.on("init",()=>{setTimeout(()=>{r()},100)}),n.on("LoadContent",()=>{setTimeout(()=>{r()},50)})}}})),k=()=>{c.push("/dynamic_document_dashboard")};return(n,r)=>(ie(),se("main",Ne,[le(ce(Ee),{"api-key":"tmizyezb3c6j68qwkp8d5hrr3vgk5va6uouidoe2hj7nxp3p",modelValue:l.value,"onUpdate:modelValue":r[0]||(r[0]=t=>l.value=t),init:g.value},null,8,["modelValue","init"])]))}};export{Re as default};
