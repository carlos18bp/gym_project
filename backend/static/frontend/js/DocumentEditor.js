import{W as V,K as X,bb as Y,r as O,Z as G,o as J,$ as ee,a6 as te,bc as ne,a0 as H,u as oe,H as re,I as ae,c as $,e as ie,f as se,h as le,j as ce,s as w}from"./index.js";import{u as ue}from"./index2.js";var de=["onActivate","onAddUndo","onBeforeAddUndo","onBeforeExecCommand","onBeforeGetContent","onBeforeRenderUI","onBeforeSetContent","onBeforePaste","onBlur","onChange","onClearUndos","onClick","onContextMenu","onCopy","onCut","onDblclick","onDeactivate","onDirty","onDrag","onDragDrop","onDragEnd","onDragGesture","onDragOver","onDrop","onExecCommand","onFocus","onFocusIn","onFocusOut","onGetContent","onHide","onInit","onKeyDown","onKeyPress","onKeyUp","onLoadContent","onMouseDown","onMouseEnter","onMouseLeave","onMouseMove","onMouseOut","onMouseOver","onMouseUp","onNodeChange","onObjectResizeStart","onObjectResized","onObjectSelected","onPaste","onPostProcess","onPostRender","onPreProcess","onProgressState","onRedo","onRemove","onReset","onSaveContent","onSelectionChange","onSetAttrib","onSetContent","onShow","onSubmit","onUndo","onVisualAid"],fe=function(o){return de.map(function(l){return l.toLowerCase()}).indexOf(o.toLowerCase())!==-1},me=function(o,l,c){Object.keys(l).filter(fe).forEach(function(d){var r=l[d];typeof r=="function"&&(d==="onInit"?r(o,c):c.on(d.substring(2),function(f){return r(f,c)}))})},pe=function(o,l,c,d){var r=o.modelEvents?o.modelEvents:null,f=Array.isArray(r)?r.join(" "):r;V(d,function(v,b){c&&typeof v=="string"&&v!==b&&v!==c.getContent({format:o.outputFormat})&&c.setContent(v)}),c.on(f||"change input undo redo",function(){l.emit("update:modelValue",c.getContent({format:o.outputFormat}))})},ve=function(o,l,c,d,r,f){d.setContent(f()),c.attrs["onUpdate:modelValue"]&&pe(l,c,d,r),me(o,c.attrs,d)},q=0,Q=function(o){var l=Date.now(),c=Math.floor(Math.random()*1e9);return q++,o+"_"+c+q+String(l)},ge=function(o){return o!==null&&o.tagName.toLowerCase()==="textarea"},W=function(o){return typeof o>"u"||o===""?[]:Array.isArray(o)?o:o.split(" ")},ye=function(o,l){return W(o).concat(W(l))},be=function(o){return o==null},Z=function(){return{listeners:[],scriptId:Q("tiny-script"),scriptLoaded:!1}},he=function(){var o=Z(),l=function(r,f,v,b){var u=f.createElement("script");u.referrerPolicy="origin",u.type="application/javascript",u.id=r,u.src=v;var N=function(){u.removeEventListener("load",N),b()};u.addEventListener("load",N),f.head&&f.head.appendChild(u)},c=function(r,f,v){o.scriptLoaded?v():(o.listeners.push(v),r.getElementById(o.scriptId)||l(o.scriptId,r,f,function(){o.listeners.forEach(function(b){return b()}),o.scriptLoaded=!0}))},d=function(){o=Z()};return{load:c,reinitialize:d}},_e=he(),Ce=function(){return typeof window<"u"?window:global},B=function(){var o=Ce();return o&&o.tinymce?o.tinymce:null},we={apiKey:String,cloudChannel:String,id:String,init:Object,initialValue:String,inline:Boolean,modelEvents:[String,Array],plugins:[String,Array],tagName:String,toolbar:[String,Array],modelValue:String,disabled:Boolean,tinymceScriptSrc:String,outputFormat:{type:String,validator:function(o){return o==="html"||o==="text"}}},D=function(){return D=Object.assign||function(o){for(var l,c=1,d=arguments.length;c<d;c++){l=arguments[c];for(var r in l)Object.prototype.hasOwnProperty.call(l,r)&&(o[r]=l[r])}return o},D.apply(this,arguments)},De=function(o,l,c,d){return o(d||"div",{id:l,ref:c})},Se=function(o,l,c){return o("textarea",{id:l,visibility:"hidden",ref:c})},M={selector:void 0,target:void 0},Ee=X({props:we,setup:function(o,l){var c=o.init?D(D({},o.init),M):D({},M),d=Y(o),r=d.disabled,f=d.modelValue,v=d.tagName,b=O(null),u=null,N=o.id||Q("tiny-vue"),k=o.init&&o.init.inline||o.inline,T=!!l.attrs["onUpdate:modelValue"],R=!0,j=o.initialValue?o.initialValue:"",I="",L=function(g){return T?function(){return f!=null&&f.value?f.value:""}:function(){return g?j:I}},P=function(){var g=L(R),y=D(D({},c),{readonly:o.disabled,target:b.value,plugins:ye(c.plugins,o.plugins),toolbar:o.toolbar||c.toolbar,inline:k,setup:function(A){u=A,A.on("init",function(n){return ve(n,o,l,A,f,g)}),typeof c.setup=="function"&&c.setup(A)}});ge(b.value)&&(b.value.style.visibility=""),B().init(y),R=!1};V(r,function(g){var y;u!==null&&(typeof((y=u.mode)===null||y===void 0?void 0:y.set)=="function"?u.mode.set(g?"readonly":"design"):u.setMode(g?"readonly":"design"))}),V(v,function(g){var y;T||(I=u.getContent()),(y=B())===null||y===void 0||y.remove(u),G(function(){return P()})}),J(function(){if(B()!==null)P();else if(b.value&&b.value.ownerDocument){var g=o.cloudChannel?o.cloudChannel:"6",y=o.apiKey?o.apiKey:"no-api-key",A=be(o.tinymceScriptSrc)?"https://cdn.tiny.cloud/1/".concat(y,"/tinymce/").concat(g,"/tinymce.min.js"):o.tinymceScriptSrc;_e.load(b.value.ownerDocument,A,P)}}),ee(function(){B()!==null&&B().remove(u)}),k||(te(function(){R||P()}),ne(function(){var g;T||(I=u.getContent()),(g=B())===null||g===void 0||g.remove(u)}));var h=function(g){var y;I=u.getContent(),(y=B())===null||y===void 0||y.remove(u),c=D(D(D({},c),g),M),G(function(){return P()})};return l.expose({rerender:h,getEditor:function(){return u}}),function(){return k?De(H,N,b,o.tagName):Se(H,N,b)}}});const Ne={class:"flex h-screen w-full"},Re={__name:"DocumentEditor",setup(o){const l=O(""),c=oe(),d=re(),r=ue(),f=ae(),v=$(()=>{var a;const n=(a=f.currentUser)==null?void 0:a.role;return n==="client"||n==="basic"||n==="corporate_client"}),b=$(()=>d.path.includes("/creator/")),u=O("");O(""),J(async()=>{var a;const n=d.params.id;if(n)try{const t=await r.fetchDocumentById(n,!0);r.selectedDocument=t,u.value=(t==null?void 0:t.content)||"",v.value?l.value=k(u.value):l.value=u.value}catch(t){console.error("Error fetching document:",t),r.selectedDocument=await r.documentById(n),u.value=((a=r.selectedDocument)==null?void 0:a.content)||"",v.value?l.value=k(u.value):l.value=u.value}});const N=(n=null)=>{const a=n||l.value,t=/{{(.*?)}}/g;return Array.from(new Set([...a.matchAll(t)].map(e=>e[1])))},k=n=>{var t;if(!n||!((t=r.selectedDocument)!=null&&t.variables))return n;let a=n;return r.selectedDocument.variables.forEach(e=>{const s=new RegExp(`{{${e.name_en}}}`,"g"),i=e.value||`[${e.name_es||e.name_en}]`,m=`<span 
      class="variable-protected mceNonEditable" 
      data-variable="${e.name_en}" 
      data-mce-contenteditable="false"
      contenteditable="false" 
      unselectable="on"
      style="background-color: #ffeb3b !important; color: #d32f2f !important; padding: 2px 4px !important; border-radius: 3px !important; font-weight: bold !important; cursor: not-allowed !important; user-select: none !important; -webkit-user-select: none !important; -moz-user-select: none !important; -ms-user-select: none !important; display: inline-block !important;"
      title="Variable protegida: ${e.name_es||e.name_en} - No se puede editar"
      onmousedown="return false;"
      onselectstart="return false;"
      ondragstart="return false;"
    >${i}</span>`;a=a.replace(s,m)}),a},T=n=>n&&n.replace(/<span[^>]*(?:class="[^"]*variable-protected[^"]*"|data-variable="([^"]*)")(?:[^>]*data-variable="([^"]*)")?[^>]*>[\s\S]*?<\/span>/g,(a,t,e)=>{const s=t||e;return s?`{{${s}}}`:a}),R=n=>{var e;const a=((e=r.selectedDocument)==null?void 0:e.variables)||[],t=n.map(s=>{const i=a.find(m=>m.name_en===s);return{name_en:s,name_es:(i==null?void 0:i.name_es)||"",tooltip:(i==null?void 0:i.tooltip)||"",field_type:(i==null?void 0:i.field_type)||"input",value:(i==null?void 0:i.value)||"",select_options:(i==null?void 0:i.field_type)==="select"?(i==null?void 0:i.select_options)||[]:null,summary_field:(i==null?void 0:i.summary_field)||"none",currency:(i==null?void 0:i.currency)||null}});r.selectedDocument.variables=t},j=async()=>{var n;try{const a=T(l.value);if(r.selectedDocument){const t=r.selectedDocument,e=f.getCurrentUser,s=t.assigned_to?String(t.assigned_to):null,i=e!=null&&e.id?String(e.id):null,m=s&&i&&s===i,S=t.state==="Published"&&!t.assigned_to;if(b.value||S||!m){const C=f.getCurrentUser;let _=C==null?void 0:C.id;if(_||(_=(n=f.getCurrentUser)==null?void 0:n.id),!_&&C&&(_=C.id),!_){await w("Error: No se pudo identificar al usuario. Por favor, recarga la página.","error");return}const E={title:String(t.title||"Untitled"),content:String(a||""),state:"Progress",assigned_to:Number(_),variables:Array.isArray(t.variables)?t.variables.map(p=>({name_en:p.name_en||"",name_es:p.name_es||"",tooltip:p.tooltip||"",field_type:p.field_type||"input",value:p.value||"",select_options:p.select_options||null,summary_field:p.summary_field||"none",currency:p.summary_field==="value"&&p.currency||null})):[],tag_ids:Array.isArray(t.tags)?t.tags.map(p=>{const z=typeof p=="object"?p.id:p;return Number(z)}).filter(p=>!isNaN(p)):[],requires_signature:!!t.requires_signature,is_public:!1};E.state!=="Progress"&&(E.state="Progress"),(!E.assigned_to||E.assigned_to!==_)&&(E.assigned_to=Number(_));const x=await r.createDocument(E);x&&x.id?(await w("Documento creado exitosamente desde la plantilla.","success"),await r.init(!0),await new Promise(p=>setTimeout(p,300)),window.location.href="/dynamic_document_dashboard"):(console.error("Failed to create document - no ID returned:",x),await w("Error: No se pudo crear el documento.","error"))}else{const C={...t,content:a};await r.updateDocument(t.id,C)&&(await w("Documento guardado exitosamente.","success"),setTimeout(()=>{window.location.href="/dynamic_document_dashboard"},500))}}else await w("Error: No se encontró el documento para guardar.","error")}catch(a){console.error("Error saving document content:",a),await w("Error al guardar el documento.","error")}},I=async()=>{var n,a;try{const t=l.value;if(L(t)){await w("No puedes guardar un documento vacío. Por favor, agrega contenido al documento antes de guardarlo.","warning");return}const e=N();r.selectedDocument?(r.selectedDocument.content=t,r.selectedDocument.state="Draft",e.length>0&&R(e)):(r.selectedDocument={title:((n=r.selectedDocument)==null?void 0:n.title)||d.params.title||"Untitled Document",content:t,state:"Draft",variables:[]},e.length>0&&R(e));let s,i;(a=r.selectedDocument)!=null&&a.id?(s=r.selectedDocument.id,i=await r.updateDocument(s,r.selectedDocument)):(i=await r.createDocument(r.selectedDocument),i&&i.id&&(s=i.id));const m=r.selectedDocument;if(r.selectedDocument=null,await r.init(),!s&&m&&m.title){const S=r.documents.find(U=>U.title===m.title&&U.content===m.content&&U.state==="Draft");S&&(s=S.id)}s&&(localStorage.setItem("lastUpdatedDocumentId",s.toString()),r.lastUpdatedDocumentId=s),await w("¡Borrador guardado exitosamente!","success"),setTimeout(()=>{window.location.href="/dynamic_document_dashboard"},500)}catch(t){console.error("Error saving draft:",t),await w("Error al guardar el borrador.","error")}},L=n=>{if(!n||n.trim()==="")return!0;const a=n.replace(/<[^>]*>/g,"").trim();return a===""||a==="&nbsp;"},P=async()=>{if(L(l.value)){await w("No puedes continuar con un documento vacío. Por favor, agrega contenido al documento antes de continuar.","warning");return}const n=N();r.selectedDocument?r.selectedDocument.content=l.value:r.selectedDocument={title:d.params.title||"Untitled Document",content:l.value,variables:[]},R(n),c.push("/dynamic_document_dashboard/lawyer/variables-config")};let h=!1;function g(n){if(!n||typeof n!="string")return n;try{return n.replace(/(font-family\s*:\s*)([^;!]*)([;!])/gi,"font-family: 'Carlito', sans-serif$3").replace(/<([a-z][a-z0-9]*)\b([^>]*)(?!\bstyle=)([^>]*)>/gi,function(a,t,e,s){return/style=/i.test(e)?a:`<${t}${e} style="font-family: 'Carlito', sans-serif;"${s}>`})}catch(a){return console.error("[ERROR] Failed to apply Carlito font:",a),n}}const y=$(()=>({language:"es",plugins:"lists link image table code wordcount autolink searchreplace",menubar:"",toolbar:v.value?"save return | undo redo | formatselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | outdent indent | blocks fontsize lineheight | forecolor | removeformat | hr":"save continue return | undo redo | formatselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | outdent indent | blocks fontsize lineheight | forecolor | removeformat | hr",height:"100vh",width:"100%",content_style:`
    @import url('https://fonts.googleapis.com/css2?family=Carlito&display=swap');
    body, p, span, div, strong, em, u, i, b {
      font-family: 'Carlito', sans-serif !important;
    }
    .variable-protected {
      background-color: #ffeb3b !important;
      color: #d32f2f !important;
      padding: 2px 4px !important;
      border-radius: 3px !important;
      font-weight: bold !important;
      cursor: not-allowed !important;
      user-select: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
    }
  `,font_formats:"Carlito=Carlito, sans-serif;",paste_webkit_styles:"all",paste_remove_styles_if_webkit:!1,paste_merge_formats:!0,paste_as_text:!1,keep_styles:!0,forced_root_block:"p",forced_root_block_attrs:{style:"font-family: 'Carlito', sans-serif;"},...v.value&&{noneditable_noneditable_class:"variable-protected",noneditable_editable_class:"mce-editable",content_css_cors:!0},setup:n=>{if(n.ui.registry.addButton("save",{text:v.value?"Guardar":"Guardar como borrador",icon:"save",onAction:()=>{v.value?j():I()}}),n.ui.registry.addButton("continue",{text:"Continuar",icon:"chevron-right",onAction:()=>{P()}}),n.ui.registry.addButton("return",{text:"Regresar",icon:"chevron-left",onAction:()=>{A()}}),n.on("init",()=>{try{setTimeout(()=>{try{const a=n.getContent(),t=g(a);a!==t&&(h=!0,n.setContent(t),h=!1)}catch(a){console.error("[ERROR] Failed to initialize content:",a)}},100)}catch(a){console.error("[ERROR] Initialization failed:",a)}}),n.on("BeforeSetContent",a=>{a.content&&(a.content=a.content.replace(/<([a-z][a-z0-9]*)\b([^>]*)(style=["'])([^"']*)["']([^>]*)>/gi,function(t,e,s,i,m,S){return m.includes("font-family")?t.replace(/(font-family\s*:\s*)([^;"]*)([;"])/gi,"font-family: 'Carlito', sans-serif$3"):`<${e}${s}${i}font-family: 'Carlito', sans-serif; ${m}"${S}>`}))}),n.on("SetContent",a=>{if(!h)try{(a.source_view||a.paste||a.setup)&&(h=!0,setTimeout(()=>{try{const t=n.getContent(),e=g(t);t!==e&&n.setContent(e,{format:"raw",no_events:!0})}catch(t){console.error("[ERROR] Failed to process SetContent:",t)}finally{h=!1}},50))}catch(t){console.error("[ERROR] SetContent event error:",t),h=!1}}),n.on("input",()=>{}),v.value){const a=()=>{n.dom.select(".variable-protected").forEach(e=>{e.setAttribute("contenteditable","false"),e.setAttribute("data-mce-contenteditable","false"),e.setAttribute("unselectable","on"),e.className=e.className.replace("mceNonEditable","")+" mceNonEditable",e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.mozUserSelect="none",e.style.msUserSelect="none",e.style.pointerEvents="none",e.style.cursor="not-allowed",e.onmousedown=()=>!1,e.onselectstart=()=>!1,e.ondragstart=()=>!1,e.oncontextmenu=()=>!1,e.style.backgroundColor="#ffeb3b",e.style.color="#d32f2f",e.style.fontWeight="bold",e.style.padding="2px 4px",e.style.borderRadius="3px",e.style.display="inline-block",e.style.border="1px solid #fbc02d",e.title="Variable protegida - No se puede editar"})};n.on("keydown",t=>{var C,_,E,x,p;const e=n.selection,s=e.getNode(),i=e.getRng(),m=((C=s.classList)==null?void 0:C.contains("variable-protected"))||s.closest(".variable-protected")||((x=(E=(_=i.commonAncestorContainer)==null?void 0:_.parentElement)==null?void 0:E.classList)==null?void 0:x.contains("variable-protected")),S=e.getContent(),U=S.includes("variable-protected")||S.includes("data-variable=");if((t.key==="Backspace"||t.key==="Delete"||t.key==="x"&&(t.ctrlKey||t.metaKey))&&(m||U)){if(t.preventDefault(),t.stopPropagation(),m){const z=(p=s.classList)!=null&&p.contains("variable-protected")?s:s.closest(".variable-protected");if(z){const F=z.nextSibling;if(F)e.select(F),e.collapse(!0);else{const K=n.dom.create("span",{}," ");n.dom.insertAfter(K,z),e.select(K),e.collapse(!0)}}}return!1}if(m&&!["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(t.key))return t.preventDefault(),!1}),n.on("paste",t=>{var m;const e=n.selection,s=e.getNode(),i=e.getContent();if((m=s.classList)!=null&&m.contains("variable-protected")||s.closest(".variable-protected")||i.includes("variable-protected"))return t.preventDefault(),!1}),n.on("BeforeSetContent",t=>{!h&&t.content&&n.getContent()}),n.on("SetContent",t=>{h||setTimeout(()=>{a()},10)}),n.on("input",()=>{if(h)return;const t=n.getContent(),e=(u.value.match(/{{.*?}}/g)||[]).length;if((t.match(/variable-protected/g)||[]).length<e){h=!0;const i=k(u.value);n.setContent(i),setTimeout(()=>{a(),h=!1},10);return}a()}),n.on("dragstart",t=>{var s;const e=t.target;if((s=e.classList)!=null&&s.contains("variable-protected")||e.closest(".variable-protected"))return t.preventDefault(),!1}),n.on("selectionchange",()=>{const t=n.selection.getContent();if(t.includes("variable-protected")||t.includes("mceNonEditable")){const e=n.selection;e.getRng();const s=n.getBody(),i=n.dom.select("p,div",s);if(i.length>0){const m=i[0];e.select(m),e.collapse(!0)}}}),n.on("beforeinput",t=>{var i;const e=n.selection,s=e.getNode();if((i=s.classList)!=null&&i.contains("variable-protected")||s.closest(".variable-protected")||e.getContent().includes("variable-protected"))return t.preventDefault(),!1}),n.on("init",()=>{setTimeout(()=>{a()},100)}),n.on("LoadContent",()=>{setTimeout(()=>{a()},50)})}}})),A=()=>{c.push("/dynamic_document_dashboard")};return(n,a)=>(ie(),se("main",Ne,[le(ce(Ee),{"api-key":"tmizyezb3c6j68qwkp8d5hrr3vgk5va6uouidoe2hj7nxp3p",modelValue:l.value,"onUpdate:modelValue":a[0]||(a[0]=t=>l.value=t),init:y.value},null,8,["modelValue","init"])]))}};export{Re as default};
