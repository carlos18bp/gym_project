import{ab as O,u as Q,I as H,r as v,T as K,o as W,c as X,e as d,f as u,g as l,t as c,F as V,N as F,j as w,l as p,n as y,w as x,v as C,s as M,h as ee,S as te,p as R,al as q}from"./index.js";import{u as se}from"./index2.js";import{r as oe}from"./InformationCircleIcon.js";const ae={key:0,class:"pb-10 px-4 sm:px-6 lg:px-8 lg:pt-10"},re={class:"w-full p-5 rounded-lg border-2 border-stroke bg-terciary"},ne={class:"text-primary text-xl font-semibold"},le={class:"mt-4 grid grid-cols-1 gap-6 sm:grid-cols-3"},ie={class:"flex items-center gap-2 mb-2"},de=["for"],ue={key:0,class:"relative group"},ce={class:"absolute hidden group-hover:block top-2 left-4 transform translate-y-[-100%] px-3 py-2 text-sm text-white bg-gray-800 rounded-lg shadow-lg",style:{"white-space":"nowrap","z-index":"10"}},me=["onUpdate:modelValue","id","onInput"],pe=["onUpdate:modelValue","id","onInput"],fe=["onUpdate:modelValue","id","onInput"],ge=["onUpdate:modelValue","id","onInput"],_e=["onUpdate:modelValue","id","onInput"],ve=["onUpdate:modelValue","id","onChange"],ye=l("option",{value:""},"Seleccione una opción",-1),he=["value"],we={key:6,class:"text-red-500 text-sm mt-1 flex items-center gap-1"},xe=l("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor"},[l("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1),be={class:"mt-6 flex space-x-4"},ke=["disabled"],ze={key:0,class:"mt-4"},Ce=l("label",{class:"block text-sm font-medium text-primary mb-2"}," Seleccionar usuarios que deben firmar ",-1),Ue={class:"relative"},De={key:0,class:"absolute z-10 mt-1 w-full bg-white shadow-lg rounded-md max-h-60 overflow-auto"},Ie={class:"py-1"},Se=["onClick"],Ve={key:0,class:"mt-4"},Fe=l("h4",{class:"text-sm font-medium text-gray-700 mb-2"},"Firmantes seleccionados:",-1),$e={class:"space-y-2"},Ne={class:"font-medium"},Be=["onClick"],Ee=l("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[l("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z","clip-rule":"evenodd"})],-1),Le=[Ee],Me={key:1,class:"text-center text-gray-500"},Re=l("p",null,"Cargando documento...",-1),qe=[Re],Ye={__name:"DocumentForm",setup(Pe){const i=O(),I=Q(),g=se(),_=H(),b=v(null),a=v(null),k=v(""),U=v(!1),D=v([]),f=v([]),m=v([]),S=v(!1),P={input:t=>t&&t.trim().length>0,text_area:t=>t&&t.trim().length>0,number:t=>!isNaN(parseFloat(t))&&isFinite(t),date:t=>{if(!t||!/^\d{4}-\d{2}-\d{2}$/.test(t))return!1;const e=new Date(t);return e instanceof Date&&!isNaN(e)},email:t=>t?/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(t):!1,select:t=>t&&t.trim().length>0},T=()=>{if(k.value.trim()===""){D.value=[],U.value=!1;return}const t=k.value.toLowerCase();D.value=_.users.filter(s=>f.value.some(e=>e.id===s.id)?!1:s.email.toLowerCase().includes(t)||s.first_name&&s.first_name.toLowerCase().includes(t)||s.last_name&&s.last_name.toLowerCase().includes(t)).slice(0,5),U.value=!0},A=t=>{f.value.push(t),k.value="",D.value=[],U.value=!1},G=t=>{f.value=f.value.filter(s=>s.id!==t.id)};K(k,t=>{t===""&&(U.value=!1)});const h=(t,s)=>{const e=[];if(t.value!==null&&t.value!==void 0){const o=P[t.field_type];if(o&&!o(t.value))switch(t.field_type){case"number":e.push("El valor debe ser un número válido.");break;case"date":e.push("El valor debe ser una fecha válida en formato YYYY-MM-DD.");break;case"email":e.push("El valor debe ser un correo electrónico válido.");break;default:String(t.value).trim().length===0&&e.push("El valor no puede estar vacío.")}}e.length>0?m.value[s]=e.join(" "):m.value[s]=null},Y=()=>{var s;m.value=[];let t=!0;return(s=a.value)==null||s.variables.forEach((e,o)=>{h(e,o),m.value[o]&&(t=!1)}),i.params.mode==="formalize"&&f.value.length===0?(q.fire({title:"Firmantes requeridos",text:"Debe seleccionar al menos un usuario para firmar el documento.",icon:"warning"}),!1):(t||q.fire({title:"Campos incompletos",text:"Por favor, verifica los formatos de los campos.",icon:"warning"}),t)};W(async()=>{var s;const t=i.params.id;if(S.value=i.params.mode==="editor"||i.params.mode==="formalize",b.value=await g.documentById(t),(!_.users||_.users.length===0)&&await _.fetchUsers(),i.params.mode==="creator"&&(a.value={title:i.params.title,variables:b.value.variables,content:b.value.content,created_by:b.value.created_by,assigned_to:((s=g.currentUser)==null?void 0:s.id)||null,tags:b.value.tags||[]}),(i.params.mode==="editor"||i.params.mode==="formalize")&&(a.value=JSON.parse(JSON.stringify(b.value)),a.value.title=i.params.title,i.params.mode==="formalize"&&(a.value.state="Published",a.value.requires_signature=!0,a.value.signer_ids&&a.value.signer_ids.length>0))){const e=await _.getUsersByIds(a.value.signer_ids);f.value=e}});const B=X(()=>{var t;return(t=a.value)==null?void 0:t.variables.every(s=>s.value!==null&&s.value!==void 0&&String(s.value).trim().length>0)}),E=async(t="Draft")=>{var s;if(Y())try{const e=_.getCurrentUser,o=(e==null?void 0:e.id)||((s=g.currentUser)==null?void 0:s.id),r=i.params.mode==="creator"&&a.value.state==="Published"&&!a.value.assigned_to,Z=r?"Progress":i.params.mode==="formalize"?"PendingSignatures":t,$={title:a.value.title,content:a.value.content,state:Z,assigned_to:(r||!a.value.assigned_to)&&o?o:a.value.assigned_to,variables:a.value.variables.map(n=>({name_en:n.name_en,name_es:n.name_es,tooltip:n.tooltip||"",field_type:n.field_type,value:n.value,select_options:n.field_type==="select"?n.select_options:null})),requires_signature:i.params.mode==="formalize",signers:i.params.mode==="formalize"?(()=>{var L;const n=f.value.map(J=>J.id),N=(L=_.currentUser)==null?void 0:L.id;return N&&!n.includes(N)&&n.push(N),n})():[],tag_ids:a.value.tags?a.value.tags.map(n=>n.id):[]};let z=null;if(i.params.mode==="formalize"){const n=await g.createDocument($);n&&n.id&&(z=n.id)}else if(S.value&&a.value.id)await g.updateDocument(a.value.id,$),z=a.value.id;else{const n=await g.createDocument($);n&&n.id&&(z=n.id,await g.init(!0))}z&&(localStorage.setItem("lastUpdatedDocumentId",z.toString()),g.lastUpdatedDocumentId=z),await M(i.params.mode==="formalize"?"Documento formalizado y listo para firmas":t==="Draft"?"Documento guardado como borrador":"Documento publicado exitosamente","success"),setTimeout(()=>{if(i.params.mode==="formalize"){const n=_.currentUser;(n==null?void 0:n.role)==="lawyer"?I.push({path:"/dynamic_document_dashboard",query:{lawyerTab:"pending-signatures"}}):I.push({path:"/dynamic_document_dashboard",query:{tab:"pending-signatures"}})}else I.push("/dynamic_document_dashboard")},300)}catch(e){console.error("Error saving document:",e),await M("Error al guardar documento","error")}},j=()=>{I.push("/dynamic_document_dashboard")};return(t,s)=>a.value?(d(),u("div",ae,[l("div",re,[l("div",null,[l("h1",ne,c(a.value.title),1)]),l("div",le,[(d(!0),u(V,null,F(a.value.variables,(e,o)=>(d(),u("div",{key:o,class:y({"col-span-3":e.field_type==="text_area","col-span-1":e.field_type!=="text_area"})},[l("div",ie,[l("label",{for:"field-"+o,class:"text-base font-medium text-primary"},c(e.name_es||e.name_en),9,de),e.tooltip?(d(),u("div",ue,[ee(w(oe),{class:"size-5 text-gray-400 hover:text-secondary cursor-pointer"}),l("div",ce,c(e.tooltip),1)])):p("",!0)]),e.field_type==="input"?x((d(),u("input",{key:0,type:"text","onUpdate:modelValue":r=>e.value=r,id:"field-"+o,class:y(["block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-secondary",{"ring-red-300":m.value[o]}]),onInput:r=>h(e,o)},null,42,me)),[[C,e.value]]):p("",!0),e.field_type==="text_area"?x((d(),u("textarea",{key:1,"onUpdate:modelValue":r=>e.value=r,id:"field-"+o,class:y(["block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-secondary",{"ring-red-300":m.value[o]}]),onInput:r=>h(e,o),rows:"4"},null,42,pe)),[[C,e.value]]):p("",!0),e.field_type==="number"?x((d(),u("input",{key:2,type:"number","onUpdate:modelValue":r=>e.value=r,id:"field-"+o,step:"any",class:y(["block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-secondary",{"ring-red-300":m.value[o]}]),onInput:r=>h(e,o)},null,42,fe)),[[C,e.value]]):p("",!0),e.field_type==="date"?x((d(),u("input",{key:3,type:"date","onUpdate:modelValue":r=>e.value=r,id:"field-"+o,class:y(["block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-secondary",{"ring-red-300":m.value[o]}]),onInput:r=>h(e,o)},null,42,ge)),[[C,e.value]]):p("",!0),e.field_type==="email"?x((d(),u("input",{key:4,type:"email","onUpdate:modelValue":r=>e.value=r,id:"field-"+o,class:y(["block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-secondary",{"ring-red-300":m.value[o]}]),onInput:r=>h(e,o)},null,42,_e)),[[C,e.value]]):p("",!0),e.field_type==="select"?x((d(),u("select",{key:5,"onUpdate:modelValue":r=>e.value=r,id:"field-"+o,class:y(["block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-secondary",{"ring-red-300":m.value[o]}]),onChange:r=>h(e,o)},[ye,(d(!0),u(V,null,F(e.select_options,r=>(d(),u("option",{key:r,value:r},c(r),9,he))),128))],42,ve)),[[te,e.value]]):p("",!0),m.value[o]?(d(),u("p",we,[xe,R(" "+c(m.value[o]),1)])):p("",!0)],2))),128))]),l("div",be,[w(i).params.mode!=="formalize"?(d(),u("button",{key:0,type:"button",class:"p-2.5 text-sm font-medium rounded-md flex gap-2 bg-secondary text-white",onClick:s[0]||(s[0]=e=>E("Progress"))},c(S.value?"Guardar cambios como Borrador":"Guardar progreso"),1)):p("",!0),l("button",{type:"button",class:y(["p-2.5 text-sm font-medium rounded-md flex gap-2",!B.value||w(i).params.mode==="formalize"&&f.value.length===0?"bg-gray-200 text-secondary border-2 border-dashed border-secondary cursor-not-allowed bg-opacity-50":"bg-secondary text-white"]),disabled:!B.value||w(i).params.mode==="formalize"&&f.value.length===0,onClick:s[1]||(s[1]=e=>E(w(i).params.mode==="formalize"?"Published":"Completed"))},c(w(i).params.mode==="formalize"?"Formalizar y Agregar Firmas":S.value?"Completar y Generar":"Generar"),11,ke),l("button",{onClick:s[2]||(s[2]=e=>j()),type:"button",class:"p-2.5 text-sm font-medium rounded-md flex gap-2 bg-red-600/80 text-white cursor-pointer"}," Cancelar ")]),w(i).params.mode==="formalize"?(d(),u("div",ze,[Ce,l("div",Ue,[x(l("input",{type:"text","onUpdate:modelValue":s[3]||(s[3]=e=>k.value=e),onInput:T,placeholder:"Buscar usuario por nombre o correo...",class:"block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300"},null,544),[[C,k.value]]),U.value&&D.value.length>0?(d(),u("div",De,[l("ul",Ie,[(d(!0),u(V,null,F(D.value,e=>(d(),u("li",{key:e.id,onClick:o=>A(e),class:"px-4 py-2 hover:bg-gray-100 cursor-pointer"},c(e.first_name)+" "+c(e.last_name)+" ("+c(e.email)+") ",9,Se))),128))])])):p("",!0)]),f.value.length>0?(d(),u("div",Ve,[Fe,l("ul",$e,[(d(!0),u(V,null,F(f.value,(e,o)=>(d(),u("li",{key:e.id,class:"flex items-center justify-between p-2 bg-gray-50 rounded-md"},[l("div",null,[l("span",Ne,c(o+1)+".",1),R(" "+c(e.first_name)+" "+c(e.last_name)+" ("+c(e.email)+") ",1)]),l("button",{onClick:r=>G(e),class:"text-red-500 hover:text-red-700"},Le,8,Be)]))),128))])])):p("",!0)])):p("",!0)])])):(d(),u("div",Me,qe))}};export{Ye as default};
