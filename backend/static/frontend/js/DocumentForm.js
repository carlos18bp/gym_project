import{e as r,f as l,g as a,aa as Z,u as A,P as G,r as f,T,o as Y,c as H,t as u,F as U,M as V,l as _,i as m,n as g,w as y,v as k,s as $,j as Q,S as J,p as B,aj as M}from"./index.js";import{u as K}from"./dynamicDocument.js";function O(E,n){return r(),l("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z"})])}const W={key:0,class:"pb-10 px-4 sm:px-6 lg:px-8 lg:pt-10"},X={class:"w-full p-5 rounded-lg border-2 border-stroke bg-terciary"},ee={class:"text-primary text-xl font-semibold"},te={class:"mt-4 grid grid-cols-1 gap-6 sm:grid-cols-3"},oe={class:"flex items-center gap-2 mb-2"},se=["for"],ae={key:0,class:"relative group"},re={class:"absolute hidden group-hover:block top-2 left-4 transform translate-y-[-100%] px-3 py-2 text-sm text-white bg-gray-800 rounded-lg shadow-lg",style:{"white-space":"nowrap","z-index":"10"}},le=["onUpdate:modelValue","id","onInput"],ne=["onUpdate:modelValue","id","onInput"],ie=["onUpdate:modelValue","id","onInput"],de=["onUpdate:modelValue","id","onInput"],ue=["onUpdate:modelValue","id","onInput"],ce=["onUpdate:modelValue","id","onChange"],me=a("option",{value:""},"Seleccione una opción",-1),pe=["value"],fe={key:6,class:"text-red-500 text-sm mt-1 flex items-center gap-1"},ge=a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor"},[a("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1),ve={class:"mt-6 flex space-x-4"},_e=["disabled"],ye={key:0,class:"mt-4"},he=a("label",{class:"block text-sm font-medium text-primary mb-2"}," Seleccionar usuarios que deben firmar ",-1),we={class:"relative"},xe={key:0,class:"absolute z-10 mt-1 w-full bg-white shadow-lg rounded-md max-h-60 overflow-auto"},ke={class:"py-1"},be=["onClick"],ze={key:0,class:"mt-4"},Ce=a("h4",{class:"text-sm font-medium text-gray-700 mb-2"},"Firmantes seleccionados:",-1),De={class:"space-y-2"},Ue={class:"font-medium"},Ve=["onClick"],Ie=a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[a("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z","clip-rule":"evenodd"})],-1),Se=[Ie],Fe={key:1,class:"text-center text-gray-500"},$e=a("p",null,"Cargando documento...",-1),Be=[$e],Le={__name:"DocumentForm",setup(E){const n=Z(),I=A(),h=K(),b=G(),w=f(null),d=f(null),x=f(""),z=f(!1),C=f([]),p=f([]),c=f([]),D=f(!1),L={input:o=>o&&o.trim().length>0,text_area:o=>o&&o.trim().length>0,number:o=>!isNaN(parseFloat(o))&&isFinite(o),date:o=>{if(!o||!/^\d{4}-\d{2}-\d{2}$/.test(o))return!1;const e=new Date(o);return e instanceof Date&&!isNaN(e)},email:o=>o?/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(o):!1,select:o=>o&&o.trim().length>0},N=()=>{if(x.value.trim()===""){C.value=[],z.value=!1;return}const o=x.value.toLowerCase();C.value=b.users.filter(s=>p.value.some(e=>e.id===s.id)?!1:s.email.toLowerCase().includes(o)||s.first_name&&s.first_name.toLowerCase().includes(o)||s.last_name&&s.last_name.toLowerCase().includes(o)).slice(0,5),z.value=!0},R=o=>{p.value.push(o),x.value="",C.value=[],z.value=!1},P=o=>{p.value=p.value.filter(s=>s.id!==o.id)};T(x,o=>{o===""&&(z.value=!1)});const v=(o,s)=>{const e=[];if(o.value!==null&&o.value!==void 0){const t=L[o.field_type];if(t&&!t(o.value))switch(o.field_type){case"number":e.push("El valor debe ser un número válido.");break;case"date":e.push("El valor debe ser una fecha válida en formato YYYY-MM-DD.");break;case"email":e.push("El valor debe ser un correo electrónico válido.");break;default:String(o.value).trim().length===0&&e.push("El valor no puede estar vacío.")}}e.length>0?c.value[s]=e.join(" "):c.value[s]=null},j=()=>{var s;c.value=[];let o=!0;return(s=d.value)==null||s.variables.forEach((e,t)=>{v(e,t),c.value[t]&&(o=!1)}),n.params.mode==="formalize"&&p.value.length===0?(M.fire({title:"Firmantes requeridos",text:"Debe seleccionar al menos un usuario para firmar el documento.",icon:"warning"}),!1):(o||M.fire({title:"Campos incompletos",text:"Por favor, verifica los formatos de los campos.",icon:"warning"}),o)};Y(async()=>{var s;const o=n.params.id;if(D.value=n.params.mode==="editor"||n.params.mode==="formalize",w.value=await h.documentById(o),(!b.users||b.users.length===0)&&await b.fetchUsers(),n.params.mode==="creator"&&(d.value={title:n.params.title,variables:w.value.variables,content:w.value.content,created_by:w.value.created_by,assigned_to:((s=h.currentUser)==null?void 0:s.id)||null,tags:w.value.tags||[]}),(n.params.mode==="editor"||n.params.mode==="formalize")&&(d.value=w.value,d.value.title=n.params.title,n.params.mode==="formalize"&&(d.value.state="Published",d.value.requires_signature=!0,d.value.signer_ids&&d.value.signer_ids.length>0))){const e=await b.getUsersByIds(d.value.signer_ids);p.value=e}});const S=H(()=>{var o;return(o=d.value)==null?void 0:o.variables.every(s=>s.value!==null&&s.value!==void 0&&String(s.value).trim().length>0)}),F=async(o="Draft")=>{if(j())try{const s={title:d.value.title,content:d.value.content,state:n.params.mode==="formalize"?"PendingSignatures":o,variables:d.value.variables.map(t=>({name_en:t.name_en,name_es:t.name_es,tooltip:t.tooltip||"",field_type:t.field_type,value:t.value,select_options:t.field_type==="select"?t.select_options:null})),requires_signature:n.params.mode==="formalize",signers:n.params.mode==="formalize"?p.value.map(t=>t.id):[],tag_ids:d.value.tags?d.value.tags.map(t=>t.id):[]};let e=null;if(n.params.mode==="formalize"){const t=await h.createDocument(s);t&&t.id&&(e=t.id)}else if(D.value&&d.value.id)await h.updateDocument(d.value.id,s),e=d.value.id;else{const t=await h.createDocument(s);t&&t.id&&(e=t.id)}e&&(localStorage.setItem("lastUpdatedDocumentId",e.toString()),h.lastUpdatedDocumentId=e),await $(n.params.mode==="formalize"?"Documento formalizado y listo para firmas":o==="Draft"?"Documento guardado como borrador":"Documento publicado exitosamente","success"),setTimeout(()=>{I.push("/dynamic_document_dashboard")},300)}catch(s){console.error("Error saving document:",s),await $("Error al guardar documento","error")}},q=()=>{I.push("/dynamic_document_dashboard")};return(o,s)=>d.value?(r(),l("div",W,[a("div",X,[a("div",null,[a("h1",ee,u(d.value.title),1)]),a("div",te,[(r(!0),l(U,null,V(d.value.variables,(e,t)=>(r(),l("div",{key:t,class:g({"col-span-3":e.field_type==="text_area","col-span-1":e.field_type!=="text_area"})},[a("div",oe,[a("label",{for:"field-"+t,class:"text-base font-medium text-primary"},u(e.name_es||e.name_en),9,se),e.tooltip?(r(),l("div",ae,[Q(_(O),{class:"size-5 text-gray-400 hover:text-secondary cursor-pointer"}),a("div",re,u(e.tooltip),1)])):m("",!0)]),e.field_type==="input"?y((r(),l("input",{key:0,type:"text","onUpdate:modelValue":i=>e.value=i,id:"field-"+t,class:g(["block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-secondary",{"ring-red-300":c.value[t]}]),onInput:i=>v(e,t)},null,42,le)),[[k,e.value]]):m("",!0),e.field_type==="text_area"?y((r(),l("textarea",{key:1,"onUpdate:modelValue":i=>e.value=i,id:"field-"+t,class:g(["block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-secondary",{"ring-red-300":c.value[t]}]),onInput:i=>v(e,t),rows:"4"},null,42,ne)),[[k,e.value]]):m("",!0),e.field_type==="number"?y((r(),l("input",{key:2,type:"number","onUpdate:modelValue":i=>e.value=i,id:"field-"+t,step:"any",class:g(["block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-secondary",{"ring-red-300":c.value[t]}]),onInput:i=>v(e,t)},null,42,ie)),[[k,e.value]]):m("",!0),e.field_type==="date"?y((r(),l("input",{key:3,type:"date","onUpdate:modelValue":i=>e.value=i,id:"field-"+t,class:g(["block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-secondary",{"ring-red-300":c.value[t]}]),onInput:i=>v(e,t)},null,42,de)),[[k,e.value]]):m("",!0),e.field_type==="email"?y((r(),l("input",{key:4,type:"email","onUpdate:modelValue":i=>e.value=i,id:"field-"+t,class:g(["block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-secondary",{"ring-red-300":c.value[t]}]),onInput:i=>v(e,t)},null,42,ue)),[[k,e.value]]):m("",!0),e.field_type==="select"?y((r(),l("select",{key:5,"onUpdate:modelValue":i=>e.value=i,id:"field-"+t,class:g(["block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-secondary",{"ring-red-300":c.value[t]}]),onChange:i=>v(e,t)},[me,(r(!0),l(U,null,V(e.select_options,i=>(r(),l("option",{key:i,value:i},u(i),9,pe))),128))],42,ce)),[[J,e.value]]):m("",!0),c.value[t]?(r(),l("p",fe,[ge,B(" "+u(c.value[t]),1)])):m("",!0)],2))),128))]),a("div",ve,[_(n).params.mode!=="formalize"?(r(),l("button",{key:0,type:"button",class:"p-2.5 text-sm font-medium rounded-md flex gap-2 bg-secondary text-white",onClick:s[0]||(s[0]=e=>F("Progress"))},u(D.value?"Guardar cambios como Borrador":"Guardar progreso"),1)):m("",!0),a("button",{type:"button",class:g(["p-2.5 text-sm font-medium rounded-md flex gap-2",!S.value||_(n).params.mode==="formalize"&&p.value.length===0?"bg-gray-200 text-secondary border-2 border-dashed border-secondary cursor-not-allowed bg-opacity-50":"bg-secondary text-white"]),disabled:!S.value||_(n).params.mode==="formalize"&&p.value.length===0,onClick:s[1]||(s[1]=e=>F(_(n).params.mode==="formalize"?"Published":"Completed"))},u(_(n).params.mode==="formalize"?"Formalizar y Agregar Firmas":D.value?"Completar y Generar":"Generar"),11,_e),a("button",{onClick:s[2]||(s[2]=e=>q()),type:"button",class:"p-2.5 text-sm font-medium rounded-md flex gap-2 bg-red-600/80 text-white cursor-pointer"}," Cancelar ")]),_(n).params.mode==="formalize"?(r(),l("div",ye,[he,a("div",we,[y(a("input",{type:"text","onUpdate:modelValue":s[3]||(s[3]=e=>x.value=e),onInput:N,placeholder:"Buscar usuario por nombre o correo...",class:"block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300"},null,544),[[k,x.value]]),z.value&&C.value.length>0?(r(),l("div",xe,[a("ul",ke,[(r(!0),l(U,null,V(C.value,e=>(r(),l("li",{key:e.id,onClick:t=>R(e),class:"px-4 py-2 hover:bg-gray-100 cursor-pointer"},u(e.first_name)+" "+u(e.last_name)+" ("+u(e.email)+") ",9,be))),128))])])):m("",!0)]),p.value.length>0?(r(),l("div",ze,[Ce,a("ul",De,[(r(!0),l(U,null,V(p.value,(e,t)=>(r(),l("li",{key:e.id,class:"flex items-center justify-between p-2 bg-gray-50 rounded-md"},[a("div",null,[a("span",Ue,u(t+1)+".",1),B(" "+u(e.first_name)+" "+u(e.last_name)+" ("+u(e.email)+") ",1)]),a("button",{onClick:i=>P(e),class:"text-red-500 hover:text-red-700"},Se,8,Ve)]))),128))])])):m("",!0)])):m("",!0)])])):(r(),l("div",Fe,Be))}};export{Le as default};
