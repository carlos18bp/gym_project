import{e as n,f as i,g as o,a8 as $,u as G,L as j,r as m,P as R,o as T,c as H,t as d,F as b,H as k,l as c,i as p,n as V,w as z,v as C,s as L,j as Z,m as A,ah as F}from"./index.js";import{u as Q}from"./dynamicDocument.js";function J(I,s){return n(),i("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z"})])}const K={key:0,class:"pb-10 px-4 sm:px-6 lg:px-8 lg:pt-10"},O={class:"w-full p-5 rounded-lg border-2 border-stroke bg-terciary"},W={class:"text-primary text-xl font-semibold"},X={class:"mt-4 grid grid-cols-1 gap-6 sm:grid-cols-3"},Y={class:"flex items-center gap-2"},ee=["for"],te={key:0,class:"relative group"},ae={class:"absolute hidden group-hover:block top-2 left-4 transform translate-y-[-100%] px-3 py-2 text-sm text-white bg-gray-800 rounded-lg shadow-lg",style:{"white-space":"nowrap","z-index":"10"}},oe=["onUpdate:modelValue","id"],se=["onUpdate:modelValue","id"],re={class:"mt-6 flex space-x-4"},le=["disabled"],ne={key:0,class:"mt-4"},ie=o("label",{class:"block text-sm font-medium text-primary mb-2"}," Seleccionar usuarios que deben firmar ",-1),de={class:"relative"},ue={key:0,class:"absolute z-10 mt-1 w-full bg-white shadow-lg rounded-md max-h-60 overflow-auto"},me={class:"py-1"},ce=["onClick"],pe={key:0,class:"mt-4"},fe=o("h4",{class:"text-sm font-medium text-gray-700 mb-2"},"Firmantes seleccionados:",-1),ve={class:"space-y-2"},_e={class:"font-medium"},ge=["onClick"],he=o("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[o("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z","clip-rule":"evenodd"})],-1),ye=[he],xe={key:1,class:"text-center text-gray-500"},we=o("p",null,"Cargando documento...",-1),be=[we],Ce={__name:"DocumentForm",setup(I){const s=$(),D=G(),f=Q(),_=j(),g=m(null),l=m(null),v=m(""),h=m(!1),y=m([]),u=m([]),U=m([]),x=m(!1),E=()=>{if(v.value.trim()===""){y.value=[],h.value=!1;return}const r=v.value.toLowerCase();y.value=_.users.filter(t=>u.value.some(e=>e.id===t.id)?!1:t.email.toLowerCase().includes(r)||t.first_name&&t.first_name.toLowerCase().includes(r)||t.last_name&&t.last_name.toLowerCase().includes(r)).slice(0,5),h.value=!0},M=r=>{u.value.push(r),v.value="",y.value=[],h.value=!1},P=r=>{u.value=u.value.filter(t=>t.id!==r.id)};R(v,r=>{r===""&&(h.value=!1)});const q=()=>{var t;U.value=[];let r=!0;return(t=l.value)==null||t.variables.forEach((e,a)=>{(!e.value||e.value.trim()==="")&&(U.value[a]="Este campo es obligatorio.",r=!1)}),s.params.mode==="formalize"&&u.value.length===0?(F.fire({title:"Firmantes requeridos",text:"Debe seleccionar al menos un usuario para firmar el documento.",icon:"warning"}),!1):(r||F.fire({title:"Campos incompletos",text:"Por favor, completa todos los campos obligatorios.",icon:"warning"}),r)};T(async()=>{var t;const r=s.params.id;if(x.value=s.params.mode==="editor"||s.params.mode==="formalize",g.value=await f.documentById(r),(!_.users||_.users.length===0)&&await _.fetchUsers(),s.params.mode==="creator"&&(l.value={title:s.params.title,variables:g.value.variables,content:g.value.content,created_by:g.value.created_by,assigned_to:((t=f.currentUser)==null?void 0:t.id)||null}),(s.params.mode==="editor"||s.params.mode==="formalize")&&(l.value=g.value,l.value.title=s.params.title,s.params.mode==="formalize"&&(l.value.state="Published",l.value.requires_signature=!0,l.value.signer_ids&&l.value.signer_ids.length>0))){const e=await _.getUsersByIds(l.value.signer_ids);u.value=e}});const S=H(()=>{var r;return(r=l.value)==null?void 0:r.variables.every(t=>t.value&&t.value.trim().length>0)}),B=async(r="Draft")=>{if(q())try{const t={title:l.value.title,content:l.value.content,state:s.params.mode==="formalize"?"PendingSignatures":r,variables:l.value.variables.map(a=>({name_en:a.name_en,name_es:a.name_es,tooltip:a.tooltip||"",field_type:a.field_type,value:a.value})),requires_signature:s.params.mode==="formalize",signers:s.params.mode==="formalize"?u.value.map(a=>a.id):[]};let e=null;if(s.params.mode==="formalize"){const a=await f.createDocument(t);a&&a.id&&(e=a.id)}else if(x.value&&l.value.id)await f.updateDocument(l.value.id,t),e=l.value.id;else{const a=await f.createDocument(t);a&&a.id&&(e=a.id)}e&&(localStorage.setItem("lastUpdatedDocumentId",e.toString()),f.lastUpdatedDocumentId=e),await L(s.params.mode==="formalize"?"Documento formalizado y listo para firmas":r==="Draft"?"Documento guardado como borrador":"Documento publicado exitosamente","success"),setTimeout(()=>{D.push("/dynamic_document_dashboard")},300)}catch(t){console.error("Error saving document:",t),await L("Error al guardar documento","error")}},N=()=>{D.push("/dynamic_document_dashboard")};return(r,t)=>l.value?(n(),i("div",K,[o("div",O,[o("div",null,[o("h1",W,d(l.value.title),1)]),o("div",X,[(n(!0),i(b,null,k(l.value.variables,(e,a)=>(n(),i("div",{key:a,class:V({"col-span-3":e.field_type==="text_area","col-span-1":e.field_type==="input"})},[o("div",Y,[o("label",{for:"field-"+a,class:"text-base font-medium text-primary"},d(e.name_es||e.name_en),9,ee),e.tooltip?(n(),i("div",te,[Z(c(J),{class:"size-5 text-gray-400 hover:text-secondary cursor-pointer"}),o("div",ae,d(e.tooltip),1)])):p("",!0)]),e.field_type==="input"?z((n(),i("input",{key:0,type:"text","onUpdate:modelValue":w=>e.value=w,id:"field-"+a,class:"block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300"},null,8,oe)),[[C,e.value]]):p("",!0),e.field_type==="text_area"?z((n(),i("textarea",{key:1,"onUpdate:modelValue":w=>e.value=w,id:"field-"+a,class:"block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300"},null,8,se)),[[C,e.value]]):p("",!0)],2))),128))]),o("div",re,[c(s).params.mode!=="formalize"?(n(),i("button",{key:0,type:"button",class:"p-2.5 text-sm font-medium rounded-md flex gap-2 bg-secondary text-white",onClick:t[0]||(t[0]=e=>B("Progress"))},d(x.value?"Guardar cambios como Borrador":"Guardar progreso"),1)):p("",!0),o("button",{type:"button",class:V(["p-2.5 text-sm font-medium rounded-md flex gap-2",!S.value||c(s).params.mode==="formalize"&&u.value.length===0?"bg-gray-200 text-secondary border-2 border-dashed border-secondary cursor-not-allowed bg-opacity-50":"bg-secondary text-white"]),disabled:!S.value||c(s).params.mode==="formalize"&&u.value.length===0,onClick:t[1]||(t[1]=e=>B(c(s).params.mode==="formalize"?"Published":"Completed"))},d(c(s).params.mode==="formalize"?"Formalizar y Agregar Firmas":x.value?"Completar y Generar":"Generar"),11,le),o("button",{onClick:t[2]||(t[2]=e=>N()),type:"button",class:"p-2.5 text-sm font-medium rounded-md flex gap-2 bg-red-600/80 text-white cursor-pointer"}," Cancelar ")]),c(s).params.mode==="formalize"?(n(),i("div",ne,[ie,o("div",de,[z(o("input",{type:"text","onUpdate:modelValue":t[3]||(t[3]=e=>v.value=e),onInput:E,placeholder:"Buscar usuario por nombre o correo...",class:"block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300"},null,544),[[C,v.value]]),h.value&&y.value.length>0?(n(),i("div",ue,[o("ul",me,[(n(!0),i(b,null,k(y.value,e=>(n(),i("li",{key:e.id,onClick:a=>M(e),class:"px-4 py-2 hover:bg-gray-100 cursor-pointer"},d(e.first_name)+" "+d(e.last_name)+" ("+d(e.email)+") ",9,ce))),128))])])):p("",!0)]),u.value.length>0?(n(),i("div",pe,[fe,o("ul",ve,[(n(!0),i(b,null,k(u.value,(e,a)=>(n(),i("li",{key:e.id,class:"flex items-center justify-between p-2 bg-gray-50 rounded-md"},[o("div",null,[o("span",_e,d(a+1)+".",1),A(" "+d(e.first_name)+" "+d(e.last_name)+" ("+d(e.email)+") ",1)]),o("button",{onClick:w=>P(e),class:"text-red-500 hover:text-red-700"},ye,8,ge)]))),128))])])):p("",!0)])):p("",!0)])])):(n(),i("div",xe,be))}};export{Ce as default};
