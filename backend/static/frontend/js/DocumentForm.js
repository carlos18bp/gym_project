import{ab as j,u as Z,I as Q,r as _,T as H,o as J,c as K,e as i,f as d,g as l,t as c,F as S,N as V,j as h,l as p,n as v,w,v as C,s as N,h as O,S as W,p as L,ak as M}from"./index.js";import{u as X}from"./index2.js";import{r as ee}from"./InformationCircleIcon.js";const te={key:0,class:"pb-10 px-4 sm:px-6 lg:px-8 lg:pt-10"},se={class:"w-full p-5 rounded-lg border-2 border-stroke bg-terciary"},oe={class:"text-primary text-xl font-semibold"},ae={class:"mt-4 grid grid-cols-1 gap-6 sm:grid-cols-3"},re={class:"flex items-center gap-2 mb-2"},le=["for"],ne={key:0,class:"relative group"},ie={class:"absolute hidden group-hover:block top-2 left-4 transform translate-y-[-100%] px-3 py-2 text-sm text-white bg-gray-800 rounded-lg shadow-lg",style:{"white-space":"nowrap","z-index":"10"}},de=["onUpdate:modelValue","id","onInput"],ue=["onUpdate:modelValue","id","onInput"],ce=["onUpdate:modelValue","id","onInput"],me=["onUpdate:modelValue","id","onInput"],pe=["onUpdate:modelValue","id","onInput"],fe=["onUpdate:modelValue","id","onChange"],ge=l("option",{value:""},"Seleccione una opción",-1),_e=["value"],ve={key:6,class:"text-red-500 text-sm mt-1 flex items-center gap-1"},ye=l("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor"},[l("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1),he={class:"mt-6 flex space-x-4"},we=["disabled"],xe={key:0,class:"mt-4"},ke=l("label",{class:"block text-sm font-medium text-primary mb-2"}," Seleccionar usuarios que deben firmar ",-1),be={class:"relative"},ze={key:0,class:"absolute z-10 mt-1 w-full bg-white shadow-lg rounded-md max-h-60 overflow-auto"},Ce={class:"py-1"},Ue=["onClick"],De={key:0,class:"mt-4"},Ie=l("h4",{class:"text-sm font-medium text-gray-700 mb-2"},"Firmantes seleccionados:",-1),Se={class:"space-y-2"},Ve={class:"font-medium"},Fe=["onClick"],$e=l("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[l("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z","clip-rule":"evenodd"})],-1),Be=[$e],Ee={key:1,class:"text-center text-gray-500"},Ne=l("p",null,"Cargando documento...",-1),Le=[Ne],Te={__name:"DocumentForm",setup(Me){const n=j(),$=Z(),g=X(),x=Q(),k=_(null),a=_(null),b=_(""),U=_(!1),D=_([]),f=_([]),m=_([]),I=_(!1),R={input:t=>t&&t.trim().length>0,text_area:t=>t&&t.trim().length>0,number:t=>!isNaN(parseFloat(t))&&isFinite(t),date:t=>{if(!t||!/^\d{4}-\d{2}-\d{2}$/.test(t))return!1;const e=new Date(t);return e instanceof Date&&!isNaN(e)},email:t=>t?/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(t):!1,select:t=>t&&t.trim().length>0},P=()=>{if(b.value.trim()===""){D.value=[],U.value=!1;return}const t=b.value.toLowerCase();D.value=x.users.filter(s=>f.value.some(e=>e.id===s.id)?!1:s.email.toLowerCase().includes(t)||s.first_name&&s.first_name.toLowerCase().includes(t)||s.last_name&&s.last_name.toLowerCase().includes(t)).slice(0,5),U.value=!0},q=t=>{f.value.push(t),b.value="",D.value=[],U.value=!1},T=t=>{f.value=f.value.filter(s=>s.id!==t.id)};H(b,t=>{t===""&&(U.value=!1)});const y=(t,s)=>{const e=[];if(t.value!==null&&t.value!==void 0){const o=R[t.field_type];if(o&&!o(t.value))switch(t.field_type){case"number":e.push("El valor debe ser un número válido.");break;case"date":e.push("El valor debe ser una fecha válida en formato YYYY-MM-DD.");break;case"email":e.push("El valor debe ser un correo electrónico válido.");break;default:String(t.value).trim().length===0&&e.push("El valor no puede estar vacío.")}}e.length>0?m.value[s]=e.join(" "):m.value[s]=null},A=()=>{var s;m.value=[];let t=!0;return(s=a.value)==null||s.variables.forEach((e,o)=>{y(e,o),m.value[o]&&(t=!1)}),n.params.mode==="formalize"&&f.value.length===0?(M.fire({title:"Firmantes requeridos",text:"Debe seleccionar al menos un usuario para firmar el documento.",icon:"warning"}),!1):(t||M.fire({title:"Campos incompletos",text:"Por favor, verifica los formatos de los campos.",icon:"warning"}),t)};J(async()=>{var s;const t=n.params.id;if(I.value=n.params.mode==="editor"||n.params.mode==="formalize",k.value=await g.documentById(t),(!x.users||x.users.length===0)&&await x.fetchUsers(),n.params.mode==="creator"&&(a.value={title:n.params.title,variables:k.value.variables,content:k.value.content,created_by:k.value.created_by,assigned_to:((s=g.currentUser)==null?void 0:s.id)||null,tags:k.value.tags||[]}),(n.params.mode==="editor"||n.params.mode==="formalize")&&(a.value=k.value,a.value.title=n.params.title,n.params.mode==="formalize"&&(a.value.state="Published",a.value.requires_signature=!0,a.value.signer_ids&&a.value.signer_ids.length>0))){const e=await x.getUsersByIds(a.value.signer_ids);f.value=e}});const B=K(()=>{var t;return(t=a.value)==null?void 0:t.variables.every(s=>s.value!==null&&s.value!==void 0&&String(s.value).trim().length>0)}),E=async(t="Draft")=>{var s;if(A())try{const e=x.getCurrentUser,o=(e==null?void 0:e.id)||((s=g.currentUser)==null?void 0:s.id),r=n.params.mode==="creator"&&a.value.state==="Published"&&!a.value.assigned_to,Y=r?"Progress":n.params.mode==="formalize"?"PendingSignatures":t,F={title:a.value.title,content:a.value.content,state:Y,assigned_to:(r||!a.value.assigned_to)&&o?o:a.value.assigned_to,variables:a.value.variables.map(u=>({name_en:u.name_en,name_es:u.name_es,tooltip:u.tooltip||"",field_type:u.field_type,value:u.value,select_options:u.field_type==="select"?u.select_options:null})),requires_signature:n.params.mode==="formalize",signers:n.params.mode==="formalize"?f.value.map(u=>u.id):[],tag_ids:a.value.tags?a.value.tags.map(u=>u.id):[]};let z=null;if(n.params.mode==="formalize"){const u=await g.createDocument(F);u&&u.id&&(z=u.id)}else if(I.value&&a.value.id)await g.updateDocument(a.value.id,F),z=a.value.id;else{const u=await g.createDocument(F);u&&u.id&&(z=u.id,await g.init(!0))}z&&(localStorage.setItem("lastUpdatedDocumentId",z.toString()),g.lastUpdatedDocumentId=z),await N(n.params.mode==="formalize"?"Documento formalizado y listo para firmas":t==="Draft"?"Documento guardado como borrador":"Documento publicado exitosamente","success"),setTimeout(()=>{$.push("/dynamic_document_dashboard")},300)}catch(e){console.error("Error saving document:",e),await N("Error al guardar documento","error")}},G=()=>{$.push("/dynamic_document_dashboard")};return(t,s)=>a.value?(i(),d("div",te,[l("div",se,[l("div",null,[l("h1",oe,c(a.value.title),1)]),l("div",ae,[(i(!0),d(S,null,V(a.value.variables,(e,o)=>(i(),d("div",{key:o,class:v({"col-span-3":e.field_type==="text_area","col-span-1":e.field_type!=="text_area"})},[l("div",re,[l("label",{for:"field-"+o,class:"text-base font-medium text-primary"},c(e.name_es||e.name_en),9,le),e.tooltip?(i(),d("div",ne,[O(h(ee),{class:"size-5 text-gray-400 hover:text-secondary cursor-pointer"}),l("div",ie,c(e.tooltip),1)])):p("",!0)]),e.field_type==="input"?w((i(),d("input",{key:0,type:"text","onUpdate:modelValue":r=>e.value=r,id:"field-"+o,class:v(["block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-secondary",{"ring-red-300":m.value[o]}]),onInput:r=>y(e,o)},null,42,de)),[[C,e.value]]):p("",!0),e.field_type==="text_area"?w((i(),d("textarea",{key:1,"onUpdate:modelValue":r=>e.value=r,id:"field-"+o,class:v(["block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-secondary",{"ring-red-300":m.value[o]}]),onInput:r=>y(e,o),rows:"4"},null,42,ue)),[[C,e.value]]):p("",!0),e.field_type==="number"?w((i(),d("input",{key:2,type:"number","onUpdate:modelValue":r=>e.value=r,id:"field-"+o,step:"any",class:v(["block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-secondary",{"ring-red-300":m.value[o]}]),onInput:r=>y(e,o)},null,42,ce)),[[C,e.value]]):p("",!0),e.field_type==="date"?w((i(),d("input",{key:3,type:"date","onUpdate:modelValue":r=>e.value=r,id:"field-"+o,class:v(["block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-secondary",{"ring-red-300":m.value[o]}]),onInput:r=>y(e,o)},null,42,me)),[[C,e.value]]):p("",!0),e.field_type==="email"?w((i(),d("input",{key:4,type:"email","onUpdate:modelValue":r=>e.value=r,id:"field-"+o,class:v(["block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-secondary",{"ring-red-300":m.value[o]}]),onInput:r=>y(e,o)},null,42,pe)),[[C,e.value]]):p("",!0),e.field_type==="select"?w((i(),d("select",{key:5,"onUpdate:modelValue":r=>e.value=r,id:"field-"+o,class:v(["block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-secondary",{"ring-red-300":m.value[o]}]),onChange:r=>y(e,o)},[ge,(i(!0),d(S,null,V(e.select_options,r=>(i(),d("option",{key:r,value:r},c(r),9,_e))),128))],42,fe)),[[W,e.value]]):p("",!0),m.value[o]?(i(),d("p",ve,[ye,L(" "+c(m.value[o]),1)])):p("",!0)],2))),128))]),l("div",he,[h(n).params.mode!=="formalize"?(i(),d("button",{key:0,type:"button",class:"p-2.5 text-sm font-medium rounded-md flex gap-2 bg-secondary text-white",onClick:s[0]||(s[0]=e=>E("Progress"))},c(I.value?"Guardar cambios como Borrador":"Guardar progreso"),1)):p("",!0),l("button",{type:"button",class:v(["p-2.5 text-sm font-medium rounded-md flex gap-2",!B.value||h(n).params.mode==="formalize"&&f.value.length===0?"bg-gray-200 text-secondary border-2 border-dashed border-secondary cursor-not-allowed bg-opacity-50":"bg-secondary text-white"]),disabled:!B.value||h(n).params.mode==="formalize"&&f.value.length===0,onClick:s[1]||(s[1]=e=>E(h(n).params.mode==="formalize"?"Published":"Completed"))},c(h(n).params.mode==="formalize"?"Formalizar y Agregar Firmas":I.value?"Completar y Generar":"Generar"),11,we),l("button",{onClick:s[2]||(s[2]=e=>G()),type:"button",class:"p-2.5 text-sm font-medium rounded-md flex gap-2 bg-red-600/80 text-white cursor-pointer"}," Cancelar ")]),h(n).params.mode==="formalize"?(i(),d("div",xe,[ke,l("div",be,[w(l("input",{type:"text","onUpdate:modelValue":s[3]||(s[3]=e=>b.value=e),onInput:P,placeholder:"Buscar usuario por nombre o correo...",class:"block w-full rounded-md border-0 py-1.5 text-primary shadow-sm ring-1 ring-inset ring-gray-300"},null,544),[[C,b.value]]),U.value&&D.value.length>0?(i(),d("div",ze,[l("ul",Ce,[(i(!0),d(S,null,V(D.value,e=>(i(),d("li",{key:e.id,onClick:o=>q(e),class:"px-4 py-2 hover:bg-gray-100 cursor-pointer"},c(e.first_name)+" "+c(e.last_name)+" ("+c(e.email)+") ",9,Ue))),128))])])):p("",!0)]),f.value.length>0?(i(),d("div",De,[Ie,l("ul",Se,[(i(!0),d(S,null,V(f.value,(e,o)=>(i(),d("li",{key:e.id,class:"flex items-center justify-between p-2 bg-gray-50 rounded-md"},[l("div",null,[l("span",Ve,c(o+1)+".",1),L(" "+c(e.first_name)+" "+c(e.last_name)+" ("+c(e.email)+") ",1)]),l("button",{onClick:r=>T(e),class:"text-red-500 hover:text-red-700"},Be,8,Fe)]))),128))])])):p("",!0)])):p("",!0)])])):(i(),d("div",Ee,Le))}};export{Te as default};
