import{r as L,D as g,E as p,ak as d,al as u,$ as C,a0 as y,b0 as $,C as P}from"./index.js";const b=()=>({documents:[],selectedDocument:null,dataLoaded:!1,lastUpdatedDocumentId:null,isLoading:!1,lastFetchTime:null,documentCache:{},tags:[],tagsLoaded:!1,isLoadingTags:!1,pagination:{currentPage:1,itemsPerPage:20,totalItems:0,totalPages:0,hasMore:!1}}),_={documentById:t=>e=>t.documentCache[e]?t.documentCache[e]:t.documents.find(s=>s.id==e)||null,tagById:t=>e=>t.tags.find(s=>s.id==e)||null,sortedTags:t=>[...t.tags].sort((e,s)=>e.name.localeCompare(s.name)),publishedDocumentsUnassigned:t=>t.documents.filter(e=>e.state==="Published"&&!e.assigned_to),draftAndPublishedDocumentsUnassigned:t=>t.documents.filter(e=>(e.state==="Draft"||e.state==="Published")&&!e.assigned_to),progressDocumentsByClient:t=>t.documents.filter(e=>e.state==="Progress"),pendingSignatureDocuments:t=>t.documents.filter(e=>e.state==="PendingSignatures"),fullySignedDocuments:t=>t.documents.filter(e=>e.state==="FullySigned"),completedDocumentsByClient:t=>t.documents.filter(e=>e.state==="Completed"),progressAndCompletedDocumentsByClient:t=>e=>e?t.documents.filter(r=>{const a=r.assigned_to?String(r.assigned_to):null,n=String(e);return a===n&&(r.state==="Progress"||r.state==="Completed")}):[],documentsByClient:t=>e=>e?t.documents.filter(r=>r.client_id===parseInt(e)):[],getDocumentsByLawyerId:t=>e=>e?t.documents.filter(s=>s.created_by===parseInt(e)&&(s.state==="Draft"||s.state==="Published")):[]},T={filteredDocuments:t=>(e,s)=>{if(!e)return t.documents;const r=e.toLowerCase();return t.documents.filter(a=>{var n,o,l,h,c,m,f,i;return a.title.toLowerCase().includes(r)||a.state.toLowerCase().includes(r)||a.assigned_to&&s&&(((o=(n=s.userById(a.assigned_to))==null?void 0:n.first_name)==null?void 0:o.toLowerCase().includes(r))||((h=(l=s.userById(a.assigned_to))==null?void 0:l.last_name)==null?void 0:h.toLowerCase().includes(r))||((m=(c=s.userById(a.assigned_to))==null?void 0:c.email)==null?void 0:m.toLowerCase().includes(r))||((i=(f=s.userById(a.assigned_to))==null?void 0:f.identification)==null?void 0:i.toLowerCase().includes(r)))})},filteredDocumentsByTags:t=>e=>!e||e.length===0?t.documents:t.documents.filter(s=>!s.tags||s.tags.length===0?!1:s.tags.some(r=>e.includes(r.id))),filteredDocumentsBySearchAndTags:t=>(e,s,r)=>{let a=t.documents;if(e){const n=e.toLowerCase();a=a.filter(o=>{var l,h,c,m,f,i,w,D;return o.title.toLowerCase().includes(n)||o.state.toLowerCase().includes(n)||o.assigned_to&&s&&(((h=(l=s.userById(o.assigned_to))==null?void 0:l.first_name)==null?void 0:h.toLowerCase().includes(n))||((m=(c=s.userById(o.assigned_to))==null?void 0:c.last_name)==null?void 0:m.toLowerCase().includes(n))||((i=(f=s.userById(o.assigned_to))==null?void 0:f.email)==null?void 0:i.toLowerCase().includes(n))||((D=(w=s.userById(o.assigned_to))==null?void 0:w.identification)==null?void 0:D.toLowerCase().includes(n)))})}return r&&r.length>0&&(a=a.filter(n=>!n.tags||n.tags.length===0?!1:n.tags.some(o=>r.includes(o.id)))),a}},A=L(!1),B=L({title:"",content:""}),R=t=>{let e=t.content;["Completed","PendingSignatures","FullySigned"].includes(t.state)&&t.variables&&Array.isArray(t.variables)&&t.variables.forEach(a=>{const n=new RegExp(`{{s*${a.name_en}s*}}`,"g");e=e.replace(n,a.value||"")}),B.value={title:t.title,content:e},A.value=!0;const r=x();t&&t.id&&(r.lastUpdatedDocumentId=t.id,localStorage.setItem("lastUpdatedDocumentId",t.id.toString()))},E=async(t,e,s="application/pdf")=>{let r=null;try{const a=await g(t,"blob");if(!a||!a.data)throw new Error("[ERROR] No response data received.");if(a.data instanceof Blob&&a.data.size<1e3){const l=await a.data.text();if(l.includes("error")||l.includes("Error"))throw new Error(`[ERROR] Server returned error: ${l}`)}const n=new Blob([a.data],{type:s}),o=document.createElement("a");r=window.URL.createObjectURL(n),o.href=r,o.download=e,document.body.appendChild(o),o.click()}catch(a){throw console.error("[ERROR] Error downloading file:",a),a}finally{r&&window.URL.revokeObjectURL(r);const a=document.querySelector("a[download]");a&&document.body.removeChild(a)}},I={async init(t=!1){const e=!this.lastFetchTime||Date.now()-this.lastFetchTime>3e5;(!this.dataLoaded||e||t)&&await this.fetchDocuments({forceRefresh:t});const s=localStorage.getItem("lastUpdatedDocumentId");s&&(this.lastUpdatedDocumentId=parseInt(s))},async fetchDocuments(t={}){const{page:e=1,limit:s=this.pagination.itemsPerPage,state:r="",clientId:a=null,lawyerId:n=null,forceRefresh:o=!1,append:l=!1}=t;if(!(this.isLoading||this.lastFetchTime&&Date.now()-this.lastFetchTime<30*1e3&&!o&&this.dataLoaded)){this.isLoading=!0;try{const c=new URLSearchParams;c.append("page",e),c.append("limit",s),r&&c.append("state",r),a&&c.append("client_id",a),n&&c.append("lawyer_id",n);const m=`dynamic-documents/?${c.toString()}`;let i=(await g(m)).data;return!i.items&&Array.isArray(i)&&(i={items:i,totalItems:i.length,totalPages:1,currentPage:1}),this.pagination={currentPage:e,itemsPerPage:s,totalItems:i.totalItems||i.items.length,totalPages:i.totalPages||1,hasMore:i.totalPages&&e<i.totalPages||!1},l&&e>1?this.documents=[...this.documents,...i.items]:this.documents=i.items||[],this.dataLoaded=!0,this.lastFetchTime=Date.now(),this.pagination}catch(c){throw console.error("Error fetching documents:",c),e===1&&(this.documents=[]),c}finally{this.isLoading=!1}}},async loadMoreDocuments(t={}){if(!this.pagination.hasMore||this.isLoading)return;const e=this.pagination.currentPage+1;return this.fetchDocuments({...t,page:e,append:!0})},async fetchDocumentById(t,e=!1){if(this.documentCache[t]&&!e)return this.documentCache[t];try{const r=(await g(`dynamic-documents/${t}/`)).data;this.documentCache[t]=r;const a=this.documents.findIndex(n=>n.id==t);return a>=0&&(this.documents[a]=r),r}catch(s){throw console.error(`Error fetching document ID ${t}:`,s),s}},async createDocument(t){try{const e=await p("dynamic-documents/create/",t);return this.documents.unshift(e.data),this.documentCache[e.data.id]=e.data,this.lastUpdatedDocumentId=e.data.id,localStorage.setItem("lastUpdatedDocumentId",e.data.id),await d(u.CREATE,`Creaste el nuevo documento ${t.title||"sin título"}`),e.data}catch(e){throw console.error("Error creating document:",e),e}},async updateDocument(t,e){try{const s=await C(`dynamic-documents/${t}/update/`,e);this.documentCache[t]=s.data;const r=this.documents.findIndex(a=>a.id==t);return r>=0&&(this.documents[r]=s.data),this.lastUpdatedDocumentId=t,localStorage.setItem("lastUpdatedDocumentId",t),await d(u.UPDATE,`Actualizaste el documento ${e.title||"sin título"}`),s.data}catch(s){throw console.error(`Error updating document ID ${t}:`,s),s}},async deleteDocument(t){try{let e="document";const s=this.documentById(t);return s&&(e=s.title),(await y(`dynamic-documents/${t}/delete/`)).status===204?(delete this.documentCache[t],this.documents=this.documents.filter(a=>a.id!=t),await d(u.DELETE,`Eliminaste el documento ${e}`),!0):!1}catch(e){return console.error(`Error deleting document ID ${t}:`,e),!1}},async downloadPDF(t,e){try{await E(`dynamic-documents/${t}/download-pdf/`,`${e}.pdf`),await d(u.DOWNLOAD,`Descargaste en PDF "${e}"`)}catch(s){throw console.error(`Error downloading PDF for document ID ${t}:`,s),s}},async downloadWord(t,e){try{await E(`dynamic-documents/${t}/download-word/`,`${e}.docx`),await d(u.DOWNLOAD,`Descargaste en Word "${e}"`)}catch(s){throw console.error(`Error downloading Word document for document ID ${t}:`,s),s}},clearSelectedDocument(){this.selectedDocument=null},async uploadLetterheadImage(t,e){try{const s=new FormData;s.append("image",e);const r=await $(`dynamic-documents/${t}/letterhead/upload/`,s);return await d(u.UPDATE,`Subiste imagen de membrete para documento ID ${t}`),r}catch(s){throw console.error(`Error uploading letterhead image for document ID ${t}:`,s),s}},async getLetterheadImage(t,e="blob"){try{return await g(`dynamic-documents/${t}/letterhead/`,e)}catch(s){throw console.error(`Error fetching letterhead image for document ID ${t}:`,s),s}},async deleteLetterheadImage(t){try{const e=await y(`dynamic-documents/${t}/letterhead/delete/`);return await d(u.DELETE,`Eliminaste imagen de membrete para documento ID ${t}`),e}catch(e){throw console.error(`Error deleting letterhead image for document ID ${t}:`,e),e}}},U={async fetchTags(t=!1){if(this.isLoadingTags)return this.tags;if(this.tagsLoaded&&!t)return this.tags;this.isLoadingTags=!0;try{const e=await g("dynamic-documents/tags/");return this.tags=e.data||[],this.tagsLoaded=!0,this.tags}catch(e){throw console.error("Error fetching tags:",e),this.tags=[],e}finally{this.isLoadingTags=!1}},async createTag(t){try{const e=await p("dynamic-documents/tags/create/",t);return this.tags.push(e.data),await d(u.CREATE,`Creaste la etiqueta "${t.name}"`),e.data}catch(e){throw console.error("Error creating tag:",e),e}},async updateTag(t,e){try{const s=await C(`dynamic-documents/tags/${t}/update/`,e),r=this.tags.findIndex(a=>a.id==t);return r>=0&&(this.tags[r]=s.data),await d(u.UPDATE,`Actualizaste la etiqueta "${e.name||"sin nombre"}"`),s.data}catch(s){throw console.error(`Error updating tag ID ${t}:`,s),s}},async deleteTag(t){try{let e="etiqueta";const s=this.tagById(t);return s&&(e=s.name),(await y(`dynamic-documents/tags/${t}/delete/`)).status===204?(this.tags=this.tags.filter(a=>a.id!=t),await d(u.DELETE,`Eliminaste la etiqueta "${e}"`),!0):!1}catch(e){return console.error(`Error deleting tag ID ${t}:`,e),!1}},async initTags(t=!1){(!this.tagsLoaded||t)&&await this.fetchTags(t)}},v={async fetchAvailableClients(){var t;try{return(((t=(await g("dynamic-documents/permissions/clients/")).data)==null?void 0:t.clients)||[]).map(a=>({id:a.user_id,user_id:a.user_id,email:a.email,full_name:a.full_name}))}catch(e){throw console.error("Error fetching available clients:",e),e}},async fetchDocumentPermissions(t){try{return(await g(`dynamic-documents/${t}/permissions/`)).data}catch(e){throw console.error(`Error fetching permissions for document ${t}:`,e),e}},async toggleDocumentPublicAccess(t){try{return(await p(`dynamic-documents/${t}/permissions/public/toggle/`,{})).data}catch(e){throw console.error(`Error toggling public access for document ${t}:`,e),e}},async grantVisibilityPermissions(t,e){try{return(await p(`dynamic-documents/${t}/permissions/visibility/grant/`,{user_ids:e})).data}catch(s){throw console.error(`Error granting visibility permissions for document ${t}:`,s),s}},async grantUsabilityPermissions(t,e){try{return(await p(`dynamic-documents/${t}/permissions/usability/grant/`,{user_ids:e})).data}catch(s){throw console.error(`Error granting usability permissions for document ${t}:`,s),s}}},x=P("dynamicDocument",{state:b,getters:{..._,...T},actions:{...I,...U,...v}});export{E as d,R as o,B as p,A as s,x as u};
