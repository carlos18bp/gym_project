import{r as C,D as m,E as y,ak as l,al as d,$ as b,a0 as p,b1 as E,C as P}from"./index.js";const $=()=>({documents:[],selectedDocument:null,dataLoaded:!1,lastUpdatedDocumentId:null,isLoading:!1,lastFetchTime:null,documentCache:{},tags:[],tagsLoaded:!1,isLoadingTags:!1,pagination:{currentPage:1,itemsPerPage:20,totalItems:0,totalPages:0,hasMore:!1}}),_={documentById:e=>t=>e.documentCache[t]?e.documentCache[t]:e.documents.find(a=>a.id==t)||null,tagById:e=>t=>e.tags.find(a=>a.id==t)||null,sortedTags:e=>[...e.tags].sort((t,a)=>t.name.localeCompare(a.name)),publishedDocumentsUnassigned:e=>e.documents.filter(t=>t.state==="Published"&&!t.assigned_to),draftAndPublishedDocumentsUnassigned:e=>e.documents.filter(t=>(t.state==="Draft"||t.state==="Published")&&!t.assigned_to),progressDocumentsByClient:e=>e.documents.filter(t=>t.state==="Progress"),pendingSignatureDocuments:e=>e.documents.filter(t=>t.state==="PendingSignatures"),fullySignedDocuments:e=>e.documents.filter(t=>t.state==="FullySigned"),completedDocumentsByClient:e=>e.documents.filter(t=>t.state==="Completed"),progressAndCompletedDocumentsByClient:e=>t=>t?e.documents.filter(r=>{const s=r.assigned_to?String(r.assigned_to):null,n=String(t);return s===n&&(r.state==="Progress"||r.state==="Completed")}):[],documentsByClient:e=>t=>t?e.documents.filter(r=>r.client_id===parseInt(t)):[],getDocumentsByLawyerId:e=>t=>t?e.documents.filter(a=>a.created_by===parseInt(t)&&(a.state==="Draft"||a.state==="Published")):[]},T={filteredDocuments:e=>(t,a)=>{if(!t)return e.documents;const r=t.toLowerCase();return e.documents.filter(s=>{var n,o,u,h,c,g,f,i;return s.title.toLowerCase().includes(r)||s.state.toLowerCase().includes(r)||s.assigned_to&&a&&(((o=(n=a.userById(s.assigned_to))==null?void 0:n.first_name)==null?void 0:o.toLowerCase().includes(r))||((h=(u=a.userById(s.assigned_to))==null?void 0:u.last_name)==null?void 0:h.toLowerCase().includes(r))||((g=(c=a.userById(s.assigned_to))==null?void 0:c.email)==null?void 0:g.toLowerCase().includes(r))||((i=(f=a.userById(s.assigned_to))==null?void 0:f.identification)==null?void 0:i.toLowerCase().includes(r)))})},filteredDocumentsByTags:e=>t=>!t||t.length===0?e.documents:e.documents.filter(a=>!a.tags||a.tags.length===0?!1:a.tags.some(r=>t.includes(r.id))),filteredDocumentsBySearchAndTags:e=>(t,a,r)=>{let s=e.documents;if(t){const n=t.toLowerCase();s=s.filter(o=>{var u,h,c,g,f,i,w,D;return o.title.toLowerCase().includes(n)||o.state.toLowerCase().includes(n)||o.assigned_to&&a&&(((h=(u=a.userById(o.assigned_to))==null?void 0:u.first_name)==null?void 0:h.toLowerCase().includes(n))||((g=(c=a.userById(o.assigned_to))==null?void 0:c.last_name)==null?void 0:g.toLowerCase().includes(n))||((i=(f=a.userById(o.assigned_to))==null?void 0:f.email)==null?void 0:i.toLowerCase().includes(n))||((D=(w=a.userById(o.assigned_to))==null?void 0:w.identification)==null?void 0:D.toLowerCase().includes(n)))})}return r&&r.length>0&&(s=s.filter(n=>!n.tags||n.tags.length===0?!1:n.tags.some(o=>r.includes(o.id)))),s}},I=C(!1),A=C({title:"",content:""}),R=e=>{let t=e.content;["Completed","PendingSignatures","FullySigned"].includes(e.state)&&e.variables&&Array.isArray(e.variables)&&e.variables.forEach(s=>{const n=new RegExp(`{{s*${s.name_en}s*}}`,"g");t=t.replace(n,s.value||"")}),A.value={title:e.title,content:t},I.value=!0;const r=S();e&&e.id&&(r.lastUpdatedDocumentId=e.id,localStorage.setItem("lastUpdatedDocumentId",e.id.toString()))},L=async(e,t,a="application/pdf")=>{let r=null;try{const s=await m(e,"blob");if(!s||!s.data)throw new Error("[ERROR] No response data received.");if(s.data instanceof Blob&&s.data.size<1e3){const u=await s.data.text();if(u.includes("error")||u.includes("Error"))throw new Error(`[ERROR] Server returned error: ${u}`)}const n=new Blob([s.data],{type:a}),o=document.createElement("a");r=window.URL.createObjectURL(n),o.href=r,o.download=t,document.body.appendChild(o),o.click()}catch(s){throw console.error("[ERROR] Error downloading file:",s),s}finally{r&&window.URL.revokeObjectURL(r);const s=document.querySelector("a[download]");s&&document.body.removeChild(s)}},B={async init(e=!1){const t=!this.lastFetchTime||Date.now()-this.lastFetchTime>3e5;(!this.dataLoaded||t||e)&&await this.fetchDocuments({forceRefresh:e});const a=localStorage.getItem("lastUpdatedDocumentId");a&&(this.lastUpdatedDocumentId=parseInt(a))},async fetchDocuments(e={}){const{page:t=1,limit:a=this.pagination.itemsPerPage,state:r="",clientId:s=null,lawyerId:n=null,forceRefresh:o=!1,append:u=!1}=e;if(!(this.isLoading||this.lastFetchTime&&Date.now()-this.lastFetchTime<30*1e3&&!o&&this.dataLoaded)){this.isLoading=!0;try{const c=new URLSearchParams;c.append("page",t),c.append("limit",a),r&&c.append("state",r),s&&c.append("client_id",s),n&&c.append("lawyer_id",n);const g=`dynamic-documents/?${c.toString()}`;let i=(await m(g)).data;return!i.items&&Array.isArray(i)&&(i={items:i,totalItems:i.length,totalPages:1,currentPage:1}),this.pagination={currentPage:t,itemsPerPage:a,totalItems:i.totalItems||i.items.length,totalPages:i.totalPages||1,hasMore:i.totalPages&&t<i.totalPages||!1},u&&t>1?this.documents=[...this.documents,...i.items]:this.documents=i.items||[],this.dataLoaded=!0,this.lastFetchTime=Date.now(),this.pagination}catch(c){throw console.error("Error fetching documents:",c),t===1&&(this.documents=[]),c}finally{this.isLoading=!1}}},async loadMoreDocuments(e={}){if(!this.pagination.hasMore||this.isLoading)return;const t=this.pagination.currentPage+1;return this.fetchDocuments({...e,page:t,append:!0})},async fetchDocumentById(e,t=!1){if(this.documentCache[e]&&!t)return this.documentCache[e];try{const r=(await m(`dynamic-documents/${e}/`)).data;this.documentCache[e]=r;const s=this.documents.findIndex(n=>n.id==e);return s>=0&&(this.documents[s]=r),r}catch(a){throw console.error(`Error fetching document ID ${e}:`,a),a}},async createDocument(e){try{const t=await y("dynamic-documents/create/",e);return this.documents.unshift(t.data),this.documentCache[t.data.id]=t.data,this.lastUpdatedDocumentId=t.data.id,localStorage.setItem("lastUpdatedDocumentId",t.data.id),await l(d.CREATE,`Creaste el nuevo documento ${e.title||"sin título"}`),t.data}catch(t){throw console.error("Error creating document:",t),t}},async updateDocument(e,t){try{const a=await b(`dynamic-documents/${e}/update/`,t);this.documentCache[e]=a.data;const r=this.documents.findIndex(s=>s.id==e);return r>=0&&(this.documents[r]=a.data),this.lastUpdatedDocumentId=e,localStorage.setItem("lastUpdatedDocumentId",e),await l(d.UPDATE,`Actualizaste el documento ${t.title||"sin título"}`),a.data}catch(a){throw console.error(`Error updating document ID ${e}:`,a),a}},async deleteDocument(e){try{let t="document";const a=this.documentById(e);return a&&(t=a.title),(await p(`dynamic-documents/${e}/delete/`)).status===204?(delete this.documentCache[e],this.documents=this.documents.filter(s=>s.id!=e),await l(d.DELETE,`Eliminaste el documento ${t}`),!0):!1}catch(t){return console.error(`Error deleting document ID ${e}:`,t),!1}},async downloadPDF(e,t){try{await L(`dynamic-documents/${e}/download-pdf/`,`${t}.pdf`),await l(d.DOWNLOAD,`Descargaste en PDF "${t}"`)}catch(a){throw console.error(`Error downloading PDF for document ID ${e}:`,a),a}},async downloadWord(e,t){try{await L(`dynamic-documents/${e}/download-word/`,`${t}.docx`),await l(d.DOWNLOAD,`Descargaste en Word "${t}"`)}catch(a){throw console.error(`Error downloading Word document for document ID ${e}:`,a),a}},clearSelectedDocument(){this.selectedDocument=null},async uploadLetterheadImage(e,t){try{const a=new FormData;a.append("image",t);const r=await E(`dynamic-documents/${e}/letterhead/upload/`,a);return await l(d.UPDATE,`Subiste imagen de membrete para documento ID ${e}`),r}catch(a){throw console.error(`Error uploading letterhead image for document ID ${e}:`,a),a}},async getLetterheadImage(e,t="blob"){try{return await m(`dynamic-documents/${e}/letterhead/`,t)}catch(a){throw console.error(`Error fetching letterhead image for document ID ${e}:`,a),a}},async deleteLetterheadImage(e){try{const t=await p(`dynamic-documents/${e}/letterhead/delete/`);return await l(d.DELETE,`Eliminaste imagen de membrete para documento ID ${e}`),t}catch(t){throw console.error(`Error deleting letterhead image for document ID ${e}:`,t),t}},async uploadGlobalLetterheadImage(e){try{const t=new FormData;t.append("image",e);const a=await E("user/letterhead/upload/",t);return await l(d.UPDATE,"Subiste imagen de membrete global"),a}catch(t){throw console.error("Error uploading global letterhead image:",t),t}},async getGlobalLetterheadImage(e="blob"){try{return await m("user/letterhead/",e)}catch(t){throw console.error("Error fetching global letterhead image:",t),t}},async deleteGlobalLetterheadImage(){try{const e=await p("user/letterhead/delete/");return await l(d.DELETE,"Eliminaste imagen de membrete global"),e}catch(e){throw console.error("Error deleting global letterhead image:",e),e}}},U={async fetchTags(e=!1){if(this.isLoadingTags)return this.tags;if(this.tagsLoaded&&!e)return this.tags;this.isLoadingTags=!0;try{const t=await m("dynamic-documents/tags/");return this.tags=t.data||[],this.tagsLoaded=!0,this.tags}catch(t){throw console.error("Error fetching tags:",t),this.tags=[],t}finally{this.isLoadingTags=!1}},async createTag(e){try{const t=await y("dynamic-documents/tags/create/",e);return this.tags.push(t.data),await l(d.CREATE,`Creaste la etiqueta "${e.name}"`),t.data}catch(t){throw console.error("Error creating tag:",t),t}},async updateTag(e,t){try{const a=await b(`dynamic-documents/tags/${e}/update/`,t),r=this.tags.findIndex(s=>s.id==e);return r>=0&&(this.tags[r]=a.data),await l(d.UPDATE,`Actualizaste la etiqueta "${t.name||"sin nombre"}"`),a.data}catch(a){throw console.error(`Error updating tag ID ${e}:`,a),a}},async deleteTag(e){try{let t="etiqueta";const a=this.tagById(e);return a&&(t=a.name),(await p(`dynamic-documents/tags/${e}/delete/`)).status===204?(this.tags=this.tags.filter(s=>s.id!=e),await l(d.DELETE,`Eliminaste la etiqueta "${t}"`),!0):!1}catch(t){return console.error(`Error deleting tag ID ${e}:`,t),!1}},async initTags(e=!1){(!this.tagsLoaded||e)&&await this.fetchTags(e)}},v={async fetchAvailableClients(){var e;try{return(((e=(await m("dynamic-documents/permissions/clients/")).data)==null?void 0:e.clients)||[]).map(s=>({id:s.user_id,user_id:s.user_id,email:s.email,full_name:s.full_name}))}catch(t){throw console.error("Error fetching available clients:",t),t}},async fetchDocumentPermissions(e){try{return(await m(`dynamic-documents/${e}/permissions/`)).data}catch(t){throw console.error(`Error fetching permissions for document ${e}:`,t),t}},async fetchAvailableRoles(){try{return(await m("dynamic-documents/permissions/roles/")).data}catch(e){throw console.error("Error fetching available roles:",e),e}},async manageDocumentPermissions(e,t){try{return(await y(`dynamic-documents/${e}/permissions/manage/`,t)).data}catch(a){throw console.error(`Error managing permissions for document ${e}:`,a),a}}},S=P("dynamicDocument",{state:$,getters:{..._,...T},actions:{...B,...U,...v}});export{L as d,R as o,A as p,I as s,S as u};
