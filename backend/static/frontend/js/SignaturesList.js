import{L as W,u as X,r as y,c as $,o as Z,P as I,e as d,f as m,F as L,H as ee,g as a,t as C,i as h,j as g,l as u,I as v,k as f,a0 as te,X as se,s as o,n as F,ab as re,ac as ae,ad as ne,ae as S,aa as ie,A as oe,aU as le,Y as ue,J as ce,K as de}from"./index.js";import{u as ge,s as N,p as fe,o as me,d as pe}from"./dynamicDocument.js";import{_ as he,D as _e,r as we,s as T}from"./DocumentSignaturesModal.js";import{useRecentViews as ye}from"./useRecentViews.js";import{_ as ve}from"./_plugin-vue_export-helper.js";const E=p=>(ce("data-v-0216e022"),p=p(),de(),p),Se=["data-document-id","onClick"],xe={key:0,d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"},be={key:1,d:"M20 6L9 17l-5-5"},De={class:"flex justify-between items-center w-full"},ke={class:"grid gap-1"},Ce={class:"text-base font-medium"},Ee={class:"flex items-center gap-2 text-sm text-gray-500"},Ue=E(()=>a("span",null,"Estado de firmas:",-1)),Pe={class:"py-1"},$e=["onClick"],Ie=["onClick"],Fe=["onClick"],Me=["onClick"],qe=["onClick"],Le={key:0,class:"mt-6 flex flex-col items-center justify-center text-center text-gray-500 w-full"},Ne={class:"text-lg font-semibold"},Te={key:1,class:"mt-6 flex justify-center"},Ve=E(()=>a("svg",{class:"animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[a("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),a("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1)),ze=E(()=>a("span",null,"Cargando documentos...",-1)),Re=[Ve,ze],je={class:"p-4 sm:p-6"},Be={class:"bg-white rounded-xl shadow-xl max-w-3xl w-full mx-auto"},He={class:"flex justify-between items-center p-4 border-b"},Ae=E(()=>a("h2",{class:"text-lg font-medium text-primary"},"Firma Electrónica",-1)),Oe={class:"p-4 sm:p-6"},Qe={__name:"SignaturesList",props:{state:{type:String,required:!0,validator:p=>["PendingSignatures","FullySigned"].includes(p)},searchQuery:{type:String,default:""}},setup(p){const _=p,l=W(),c=ge(),{registerView:V}=ye(),z=X();y([]);const x=y(!1),U=y(!1),M=y(null),w=y(!1),R=$(()=>_.state==="PendingSignatures"?"No tienes documentos pendientes por firmar.":"No tienes documentos firmados."),b=$(()=>{const e=l.currentUser.role,s=l.currentUser.id,t=l.currentUser.email;let r=[];return e==="lawyer"?_.state==="PendingSignatures"?r=c.pendingSignatureDocuments.filter(i=>i.created_by===s):r=c.fullySignedDocuments.filter(i=>i.created_by===s):_.state==="PendingSignatures"?r=c.documents.filter(i=>{var n;return i.state!=="PendingSignatures"?!1:(n=i.signatures)==null?void 0:n.some(k=>k.signer_email===t)}):r=c.documents.filter(i=>{var n;return i.state!=="FullySigned"?!1:(n=i.signatures)==null?void 0:n.some(k=>k.signer_email===t&&k.signed)}),_.searchQuery&&(r=r.filter(i=>i.title.toLowerCase().includes(_.searchQuery.toLowerCase()))),r}),j=$(()=>{const e=c.lastUpdatedDocumentId,s=localStorage.getItem("lastUpdatedDocumentId");return e&&b.value.some(r=>String(r.id)===String(e))?e:s&&b.value.some(i=>String(i.id)===String(s))?s:null}),D=async()=>{x.value=!0;try{if(await c.init(!0),c.pendingSignatureDocuments.length===0&&c.fullySignedDocuments.length===0){const e=l.currentUser.id,t=l.currentUser.role==="lawyer"?`dynamic-documents/created-by/${e}/pending-signatures/`:`dynamic-documents/user/${e}/pending-documents-full/`,r=await se(t);r&&r.data&&c.$patch(i=>{i.documents=[...i.documents,...r.data]})}}catch(e){console.error("Error refreshing documents:",e),o("Error al actualizar documentos","error")}finally{x.value=!1}};Z(async()=>{await D()});const B=async e=>{try{const s=l.currentUser.id,t=l.currentUser.email;if(!e.requires_signature){await o("This document does not require signatures","error");return}const r=e.signatures.find(n=>n.signer_email===t);if(!r){await o("No estás autorizado para firmar este documento","error");return}if(r.signed){await o("Ya has firmado este documento","info");return}if(!l.currentUser.has_signature){await o("Para firmar documentos necesitas tener una firma registrada.","info"),await T("¿Deseas crear una firma electrónica ahora?","Crear firma electrónica","Crear firma","Cancelar")?w.value=!0:await o("Necesitas una firma para poder firmar documentos.","warning");return}if(!await T(`¿Estás seguro de que deseas firmar el documento "${e.title}"?`,"Confirmar firma digital","Firmar documento","Cancelar")){await o("Operación de firma cancelada","info");return}const P=`dynamic-documents/${e.id}/sign/${s}/`;try{await o("Procesando firma del documento...","info");const n=await ue(P,{});if(n.status===200||n.status===201)await o(`¡Documento "${e.title}" firmado correctamente!`,"success"),await D(),await c.init(!0),e.id&&(localStorage.setItem("lastUpdatedDocumentId",e.id.toString()),c.lastUpdatedDocumentId=e.id),await o("Redirigiendo al panel de documentos...","info"),z.push("/dynamic_document_dashboard");else throw new Error(`Unexpected server response: ${n.status} ${n.statusText}`)}catch(n){throw console.error("Error in HTTP request:",n),n.response&&(console.error("Error response details:",n.response.data),console.error("HTTP status:",n.response.status)),n}}catch(s){console.error("General error signing document:",s),s.response&&console.error("Error details:",s.response.data),await o(`Error al firmar el documento: ${s.message}`,"error")}},q=async e=>{await V("document",e.id),me(e)},H=e=>{if(!e.requires_signature){o("Este documento no requiere firmas","warning");return}M.value=e.id,U.value=!0},A=()=>{U.value=!1},O=e=>e.signatures?e.signatures.length:0,Q=e=>e.signatures?e.signatures.filter(s=>s.signed).length:0;I(()=>c.documents,e=>{},{deep:!0}),I(()=>l.currentUser,e=>{D()}),I(()=>_.searchQuery,e=>{e||fetchDocuments()});const G=e=>{if(!e.requires_signature||e.state!=="PendingSignatures"||!e.signatures||e.signatures.length===0)return!1;const s=l.currentUser.email,t=e.signatures.find(r=>r.signer_email===s);return!(!t||t.signed)},Y=async e=>{try{if(console.log("=== DOWNLOADING SIGNED DOCUMENT ==="),console.log("Document:",{id:e.id,title:e.title,state:e.state,signatures:e.signatures}),e.state!=="FullySigned"){console.log("❌ Document is not fully signed"),o("El documento debe estar completamente firmado para descargarlo","warning");return}if(!e.signatures||e.signatures.length===0){console.log("❌ Document has no signatures"),o("El documento no tiene firmas registradas","warning");return}const s=`dynamic-documents/${e.id}/generate-signatures-pdf/`;console.log("Downloading from URL:",s),await pe(s,`firmas_${e.title}.pdf`),console.log("✅ Document downloaded successfully")}catch(s){console.error("❌ Error downloading signed document:",s),o("Error al descargar el documento firmado","error")}},J=async e=>{await l.getUserInfo(),l.currentUser&&(l.currentUser.has_signature=!0),o("Firma electrónica guardada correctamente","success"),setTimeout(()=>{w.value=!1},500)},K=e=>{c.downloadPDF(e.id,e.title)};return(e,s)=>(d(),m(L,null,[(d(!0),m(L,null,ee(b.value,t=>(d(),m("div",{key:t.id,"data-document-id":t.id,class:F(["flex items-center gap-3 py-2 px-4 border rounded-xl cursor-pointer hover:bg-gray-50 mb-4",{"border-yellow-400 bg-yellow-300/10":t.state==="PendingSignatures","border-green-400 bg-green-50":t.state==="FullySigned","border-stroke shadow-md animate-pulse-highlight":String(t.id)===String(j.value)}]),onClick:r=>{r.target.closest(".menu-container")||q(t)}},[(d(),m("svg",{class:F(["h-6 w-6",{"text-yellow-500":t.state==="PendingSignatures","text-green-500":t.state==="FullySigned"}]),viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[t.state==="PendingSignatures"?(d(),m("path",xe)):(d(),m("path",be))],2)),a("div",De,[a("div",ke,[a("span",Ce,C(t.title),1),a("div",Ee,[Ue,a("span",{class:F([{"bg-blue-100 text-blue-800":t.state==="PendingSignatures","bg-green-100 text-green-800":t.state==="FullySigned"},"text-xs font-medium px-2 py-0.5 rounded"])},C(Q(t))+"/"+C(O(t)),3)])]),g(u(ie),{as:"div",class:"relative inline-block text-left menu-container"},{default:f(()=>[g(u(re),{class:"flex items-center text-gray-400"},{default:f(()=>[g(u(we),{class:"size-6","aria-hidden":"true"})]),_:1}),g(ae,{"enter-active-class":"transition ease-out duration-100","enter-from-class":"transform opacity-0 scale-95","enter-to-class":"transform opacity-100 scale-100","leave-active-class":"transition ease-in duration-75","leave-from-class":"transform opacity-100 scale-100","leave-to-class":"transform opacity-0 scale-95"},{default:f(()=>[g(u(ne),{class:"absolute z-10 mt-2 w-56 rounded-md bg-white shadow-lg ring-1 ring-black/5 focus:outline-none right-0 left-auto"},{default:f(()=>[a("div",Pe,[t.requires_signature&&(t.state==="PendingSignatures"||t.state==="FullySigned")?(d(),v(u(S),{key:0},{default:f(()=>[a("button",{class:"block w-full text-left px-4 py-2 text-sm font-regular hover:bg-gray-100 transition",onClick:r=>H(t)}," Estado de las firmas ",8,$e)]),_:2},1024)):h("",!0),G(t)?(d(),v(u(S),{key:1},{default:f(()=>[a("button",{class:"block w-full text-left px-4 py-2 text-sm font-regular hover:bg-gray-100 transition",onClick:r=>B(t)}," Firmar documento ",8,Ie)]),_:2},1024)):h("",!0),t.state==="FullySigned"?(d(),v(u(S),{key:2},{default:f(()=>[a("button",{class:"block w-full text-left px-4 py-2 text-sm font-regular hover:bg-gray-100 transition",onClick:r=>Y(t)}," Descargar Documento firmado ",8,Fe)]),_:2},1024)):h("",!0),t.state==="PendingSignatures"?(d(),v(u(S),{key:3},{default:f(()=>[a("button",{class:"block w-full text-left px-4 py-2 text-sm font-regular hover:bg-gray-100 transition",onClick:r=>K(t)}," Descargar PDF ",8,Me)]),_:2},1024)):h("",!0),g(u(S),null,{default:f(()=>[a("button",{class:"block w-full text-left px-4 py-2 text-sm font-regular hover:bg-gray-100 transition",onClick:r=>q(t)}," Previsualizar ",8,qe)]),_:2},1024)])]),_:2},1024)]),_:2},1024)]),_:2},1024)])],10,Se))),128)),b.value.length===0&&!x.value?(d(),m("div",Le,[a("p",Ne,C(R.value),1)])):h("",!0),x.value?(d(),m("div",Te,Re)):h("",!0),g(he,{isVisible:u(N),documentData:u(fe),onClose:s[0]||(s[0]=t=>N.value=!1)},null,8,["isVisible","documentData"]),g(_e,{isVisible:U.value,documentId:M.value,onClose:A,onRefresh:D},null,8,["isVisible","documentId"]),w.value?(d(),v(te,{key:2},{default:f(()=>[a("div",je,[a("div",Be,[a("div",He,[Ae,a("button",{onClick:s[1]||(s[1]=t=>w.value=!1),class:"text-gray-400 hover:text-gray-500 p-1 rounded-full hover:bg-gray-100"},[g(u(oe),{class:"h-6 w-6"})])]),a("div",Oe,[g(le,{"user-id":u(l).currentUser.id,"initial-show-options":!u(l).currentUser.has_signature,onSignatureSaved:J,onCancel:s[2]||(s[2]=t=>w.value=!1)},null,8,["user-id","initial-show-options"])])])])]),_:1})):h("",!0)],64))}},Xe=ve(Qe,[["__scopeId","data-v-0216e022"]]);export{Xe as default};
